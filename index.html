<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Мед-карта (отладка кликов)</title>

  <style>
    body{ margin:0; font-family: Arial, sans-serif; background:#fff; color:#111; }
    .title{ padding:10px; text-align:center; font-weight:700; font-size:18px; }

    .topStatus{
      padding:10px 12px;
      font-size:14px;
      background:#fff7cc;
      border-bottom:1px solid #e7d48a;
      color:#333;
    }
    .topStatus.ok{ background:#dff7df; border-bottom:1px solid #a9d9a9; }
    .topStatus.bad{ background:#ffe1e1; border-bottom:1px solid #f0a6a6; }

    .tabs{ display:flex; }
    .tab{
      width:100%;
      padding:14px;
      font-size:17px;
      border:none;
      background:#222;
      color:#fff;
      touch-action: manipulation;
    }
    .tab.active{ background:#0b6623; }
    .tab:active{ opacity:.85; }

    .wrap{ position:relative; width:100%; }
    .map{ width:100%; display:block; user-select:none; -webkit-user-drag:none; }

    /* слой меток */
    #pinsLayer{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      z-index:10;
    }

    .pin{
      position:absolute;
      transform: translate(-50%,-50%);
      min-width:26px; height:26px; padding:0 6px;
      border-radius:999px;
      color:#fff; font-weight:800; font-size:13px;
      display:flex; align-items:center; justify-content:center;
      z-index:20;
      border:2px solid rgba(255,255,255,0.95);
      box-shadow:0 1px 6px rgba(0,0,0,0.18);
      pointer-events:auto;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    .pin.front{ background: rgba(0,120,255,0.88); }
    .pin.back{  background: rgba(255,0,0,0.88); }
    .pin.selected{ outline:3px solid rgba(255,255,255,0.95); }

    .panel{ padding:12px; border-top:1px solid #ddd; background:#fafafa; }
    label{ display:block; font-size:13px; color:#444; margin:10px 0 6px; }
    input, textarea{
      width:100%; box-sizing:border-box;
      padding:10px; font-size:15px;
      border:1px solid #ccc; border-radius:10px; background:#fff;
    }
    textarea{ min-height:60px; }

    .row{ display:flex; gap:10px; }
    .col{ width:100%; }

    .btn2{
      width:100%;
      padding:12px;
      font-size:16px;
      border:1px solid #222;
      background:#fff;
      color:#222;
      border-radius:10px;
      margin-top:10px;
      touch-action: manipulation;
    }
    .btn2:active{ opacity:.85; }

    .log{
      margin-top:10px;
      padding:10px;
      border:1px solid #ddd;
      border-radius:10px;
      background:#fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      white-space:pre-wrap;
      min-height:60px;
    }

    .reqBad{
      border-color:#d11 !important;
      box-shadow:0 0 0 3px rgba(209,17,17,0.15);
    }

    .bar{
      display:flex;
      gap:10px;
      padding:10px 12px;
      border-top:1px solid #ddd;
      background:#fafafa;
      position:sticky;
      bottom:0;
    }
    .bar button{
      width:100%;
      padding:14px;
      font-size:16px;
      border:none;
      border-radius:10px;
      color:#fff;
      background:#0b6623;
      touch-action: manipulation;
    }
  </style>
</head>

<body>
  <div class="title">КАРТА РАНЕНИЙ</div>

  <div id="topStatus" class="topStatus">JS: загрузка…</div>

  <div class="tabs">
    <button class="tab" id="btnFront" type="button">ПЕРЕД</button>
    <button class="tab" id="btnBack" type="button">СПИНА</button>
  </div>

  <div class="wrap">
    <img id="bodyImage" class="map" src="body_front.png" alt="body">
    <div id="pinsLayer"></div>
  </div>

  <div class="panel">
    <div class="row">
      <div class="col">
        <label>Дата/время (обязательно)</label>
        <input id="dt" type="datetime-local"/>
      </div>
      <div class="col">
        <label>Позывной (обязательно)</label>
        <input id="call" placeholder="например: БАРС-12"/>
      </div>
    </div>

    <label>Комментарий (обязательно)</label>
    <textarea id="comment" placeholder="кратко..."></textarea>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label>Ввести номер зоны (для текущей стороны)</label>
        <input id="zoneNum" type="number" inputmode="numeric" placeholder="например: 12"/>
      </div>
      <div class="col" style="display:flex;align-items:flex-end;">
        <button class="btn2" id="btnAddZone" type="button" style="margin-top:0;">ДОБАВИТЬ/УБРАТЬ</button>
      </div>
    </div>

    <button class="btn2" id="btnClearLog" type="button">ОЧИСТИТЬ ЛОГ</button>

    <div class="log" id="log"></div>
  </div>

  <div class="bar">
    <button id="btnMakePDF" type="button">СДЕЛАТЬ PDF (пока отключено)</button>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const topStatus = $("topStatus");
  const logEl = $("log");

  function log(msg){
    const t = new Date();
    const hh = String(t.getHours()).padStart(2,"0");
    const mm = String(t.getMinutes()).padStart(2,"0");
    const ss = String(t.getSeconds()).padStart(2,"0");
    logEl.textContent += `[${hh}:${mm}:${ss}] ${msg}\n`;
  }

  // Показываем, что JS реально запустился
  topStatus.textContent = "JS: OK (нажатия должны работать)";
  topStatus.classList.add("ok");
  log("JS стартовал");

  // ===== ключи storage (НЕ ТРОГАЕМ — чтобы твои точки не пропали) =====
  const POINTS_KEY = "medmap_points_v2";
  const SEL_FRONT  = "medmap_sel_front_v2";
  const SEL_BACK   = "medmap_sel_back_v2";

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    }catch(e){
      return fallback;
    }
  }
  function saveJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  function loadPoints(){
    const p = loadJSON(POINTS_KEY, {front:{}, back:{}});
    if(!p.front) p.front = {};
    if(!p.back) p.back = {};
    return p;
  }

  function loadSel(side){
    const key = side==="front" ? SEL_FRONT : SEL_BACK;
    const arr = loadJSON(key, []);
    return Array.isArray(arr) ? arr.map(String) : [];
  }
  function saveSel(side, arr){
    const key = side==="front" ? SEL_FRONT : SEL_BACK;
    saveJSON(key, arr);
  }

  function uniqNums(arr){
    const seen=new Set(), out=[];
    for(const x of arr){
      const n=parseInt(x,10);
      if(Number.isFinite(n) && !seen.has(n)){ seen.add(n); out.push(String(n)); }
    }
    return out;
  }

  const bodyImage = $("bodyImage");
  const pinsLayer = $("pinsLayer");
  const btnFront = $("btnFront");
  const btnBack = $("btnBack");
  const zoneNumEl = $("zoneNum");

  let view = "front";

  function clearPins(){ pinsLayer.innerHTML=""; }

  function addPin(num, x, y, selected){
    const pin = document.createElement("div");
    pin.className = "pin " + (view==="front" ? "front" : "back") + (selected ? " selected" : "");
    pin.style.left = x + "%";
    pin.style.top  = y + "%";
    pin.textContent = String(num);

    // ВАЖНО: pointerdown
    pin.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      log(`Нажали метку ${num} (${view})`);
      toggleZone(num);
    });

    pinsLayer.appendChild(pin);
  }

  function renderPins(){
    const points = loadPoints();
    const map = view==="front" ? points.front : points.back;
    const sel = new Set(loadSel(view));

    clearPins();

    const keys = Object.keys(map);
    if(keys.length===0){
      log(`Точек нет в localStorage для "${view}". Ключ: ${POINTS_KEY}`);
    }

    // выбранные сверху
    for(const k of Array.from(sel)){
      if(map[k]) addPin(k, map[k].x, map[k].y, true);
    }
    // остальные
    for(const k of keys){
      if(!sel.has(k)) addPin(k, map[k].x, map[k].y, false);
    }
  }

  function toggleZone(num){
    const n = String(parseInt(num,10));
    let sel = loadSel(view);
    const idx = sel.indexOf(n);
    if(idx>=0){ sel.splice(idx,1); log(`Зона ${n} убрана (${view})`); }
    else { sel.push(n); log(`Зона ${n} добавлена (${view})`); }
    sel = uniqNums(sel);
    saveSel(view, sel);
    renderPins();
  }

  function setView(side){
    view = side;
    bodyImage.src = (view==="front") ? "body_front.png" : "body_back.png";

    btnFront.classList.toggle("active", view==="front");
    btnBack.classList.toggle("active", view==="back");

    log(`Переключили вид: ${view}`);
    renderPins();
  }

  // Кнопки — pointerdown
  btnFront.addEventListener("pointerdown", (e)=>{ e.preventDefault(); setView("front"); });
  btnBack .addEventListener("pointerdown", (e)=>{ e.preventDefault(); setView("back"); });

  $("btnAddZone").addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    const raw = (zoneNumEl.value||"").trim();
    const n = parseInt(raw,10);
    if(!Number.isFinite(n)){ log("Ввод зоны: пусто/не число"); alert("Введи номер зоны"); return; }
    log(`Ввод зоны вручную: ${n} (${view})`);
    toggleZone(n);
    zoneNumEl.value="";
  });

  $("btnClearLog").addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    logEl.textContent="";
  });

  $("btnMakePDF").addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    alert("PDF временно отключён. Сначала добьёмся 100% работы кликов/переключения.");
  });

  // Старт
  setView("front");

})();
</script>
</body>
</html>
