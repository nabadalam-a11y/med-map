<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞—Ä—Ç–∞ —Ä–∞–Ω–µ–Ω–∏–π</title>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #fff; color: #111; }
    .title { padding: 10px; text-align: center; font-weight: 700; font-size: 18px; }
    .topStatus { padding: 10px 12px; font-size: 14px; background: #dff7df; border-bottom: 1px solid #a9d9a9; color: #333; white-space: pre-wrap; }
    .topStatus.bad { background: #ffe1e1; border-bottom: 1px solid #f0a6a6; color: #8a1f1f; }
    .tabs { display: flex; }
    .tab { width: 100%; padding: 14px; font-size: 17px; border: none; background: #222; color: #fff; touch-action: manipulation; }
    .tab.active { background: #0b6623; }
    .tab:active { opacity: .85; }
    .wrap { position: relative; width: 100%; }
    .map { width: 100%; display: block; user-select: none; -webkit-user-drag: none; }
    #pinsLayer { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    .pin {
      position: absolute; transform: translate(-50%, -50%);
      min-width: 26px; height: 26px; padding: 0 6px; border-radius: 999px;
      color: #fff; font-weight: 800; font-size: 13px; display: flex; align-items: center; justify-content: center;
      z-index: 20; border: 2px solid rgba(255, 255, 255, 0.95);
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.18);
      pointer-events: auto; cursor: pointer; user-select: none; touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }
    .pin.front { background: rgba(0, 120, 255, 0.90); } /* –ü–ï–†–ï–î ‚Äî —Å–∏–Ω–∏–π */
    .pin.back { background: rgba(255, 0, 0, 0.90); }  /* –°–ü–ò–ù–ê ‚Äî –∫—Ä–∞—Å–Ω—ã–π */
    .pin.selected { outline: 3px solid rgba(255, 255, 255, 0.95); }
    .panel { padding: 12px; border-top: 1px solid #ddd; background: #fafafa; }
    label { display: block; font-size: 13px; color: #444; margin: 10px 0 6px; }
    input, textarea { width: 100%; box-sizing: border-box; padding: 10px; font-size: 15px; border: 1px solid #ccc; border-radius: 10px; background: #fff; }
    textarea { min-height: 55px; }
    .btn2 { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #222; background: #fff; color: #222; border-radius: 10px; margin-top: 10px; touch-action: manipulation; }
    .btn2:active { opacity: .85; }
    .btn2:disabled { opacity: .55; }
    .out { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; background: #fff; margin-top: 10px; }
    .bar { display: flex; gap: 10px; padding: 10px 12px; border-top: 1px solid #ddd; background: #fafafa; position: sticky; bottom: 0; z-index: 30; }
    .bar button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 10px; color: #fff; background: #0b6623; touch-action: manipulation; }
    .bar button:active { opacity: .85; }
    .bar button:disabled { opacity: .55; }
    #toast { position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%); background: rgba(0, 0, 0, 0.85); color: #fff; padding: 10px 12px; border-radius: 12px; font-size: 14px; max-width: 92%; z-index: 9999; display: none; white-space: pre-wrap; }
  </style>
</head>

<body>
  <div class="title">–ö–ê–†–¢–ê –†–ê–ù–ï–ù–ò–ô</div>
  <div id="topStatus" class="topStatus">JS: OK (–∫–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞)</div>

  <div class="tabs">
    <button class="tab" id="btnFront" type="button">–ü–ï–†–ï–î</button>
    <button class="tab" id="btnBack" type="button">–°–ü–ò–ù–ê</button>
  </div>

  <div class="wrap">
    <img id="bodyImage" class="map" src="body_front.png" alt="body">
    <div id="pinsLayer"></div>
  </div>

  <div class="panel">
    <div class="row">
      <div class="col">
        <label>–î–∞—Ç–∞/–≤—Ä–µ–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="dt" type="datetime-local"/>
      </div>
      <div class="col">
        <label>–ü–æ–∑—ã–≤–Ω–æ–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="call" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–ê–†–°-12"/>
      </div>
    </div>

    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
    <textarea id="comment" placeholder="–∫—Ä–∞—Ç–∫–æ..."></textarea>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label>–í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –∑–æ–Ω—ã (–¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç–æ—Ä–æ–Ω—ã)</label>
        <input id="zoneNum" type="number" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 12"/>
        <div class="hint">–ù–∞–∂–º–∏ ‚Äú–î–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å‚Äù ‚Äî —ç—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å.</div>
      </div>
      <div class="col" style="display:flex;align-items:flex-end;">
        <button class="btn2" id="btnAddZone" type="button" style="margin-top:0;">–î–û–ë–ê–í–ò–¢–¨/–£–ë–†–ê–¢–¨</button>
      </div>
    </div>

    <div class="hint" style="margin-top:10px;">
      –¢–µ–ø–µ—Ä—å –õ–ï–í–û/–ü–†–ê–í–û –µ—Å—Ç—å –¥–ª—è –≤—Å–µ—Ö –∑–æ–Ω, –∫—Ä–æ–º–µ:
      <b>–ü–æ–∑–≤–æ–Ω–æ—á–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏</b> –∏ <b>–ü—É–ø–æ—á–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏</b>.
      <br/>üéÅ –ù–æ–≤–∞—è —Ñ–∏—à–∫–∞: –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–æ–Ω—ã —Å—Ç–æ—Ä–æ–Ω–∞ —Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –ø–æ–ª–æ–∂–µ–Ω–∏—é –º–µ—Ç–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞) ‚Äî –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–Ω–æ–ø–∫–∞–º–∏.
    </div>

    <div id="zonesUI"></div>

    <div class="miniRow">
      <button class="btn2" id="btnRefresh" type="button">–û–ë–ù–û–í–ò–¢–¨ –û–¢–ß–Å–¢</button>
      <button class="btn2" id="btnCopy" type="button">–ö–û–ü–ò–†–û–í–ê–¢–¨</button>
    </div>

    <button class="btn2" id="btnShort" type="button">–ö–û–†–û–¢–ö–ê–Ø –°–í–û–î–ö–ê (–¥–ª—è —Ä–∞—Ü–∏–∏)</button>

    <div class="out" id="finalMsg"></div>
  </div>

  <div class="bar">
    <button id="btnMakePDF" type="button">–°–î–ï–õ–ê–¢–¨ PDF (2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã)</button>
    <button id="btnTG" class="tg" type="button">TELEGRAM</button>
    <button id="btnHelp" type="button" style="background:#444;">–ò–ù–°–¢–†–£–ö–¶–ò–Ø</button>
    <button type="button" style="background:#444;" onclick="location.href='./evac.html'">–≠–í–ê–ö–£–ê–¶–ò–Ø</button>
  </div>

  <div id="toast"></div>

  <script>
    (function(){
      const top = document.getElementById("topStatus");
      const toastEl = document.getElementById("toast");
      function setTopBad(msg){ top.className="topStatus bad"; top.textContent=msg; }
      function toast(msg, ms){
        toastEl.textContent = msg;
        toastEl.style.display = "block";
        clearTimeout(toastEl._t);
        toastEl._t = setTimeout(()=>{ toastEl.style.display="none"; }, ms || 2400);
      }

      window.addEventListener("error", (e)=>{
        setTopBad("JS –û–®–ò–ë–ö–ê:\n" + (e.message || "unknown") + "\n" + (e.filename||"") + ":" + (e.lineno||""));
      });
      window.addEventListener("unhandledrejection", (e)=>{
        setTopBad("JS PROMISE –û–®–ò–ë–ö–ê:\n" + (e.reason && (e.reason.message || e.reason) || "unknown"));
      });

      const $ = (id)=>document.getElementById(id);

      const BACK = {
        1:"–ü–æ–¥–æ—à–≤–∞",2:"–¢—ã–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å—Ç–æ–ø—ã",3:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –≥–æ–ª–µ–Ω–∏",4:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –≥–æ–ª–µ–Ω–∏",
        5:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –∫–æ–ª–µ–Ω–∞",6:"–ó–∞–¥–Ω–µ–ø—Ä–æ—Ö–æ–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",7:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –±–µ–¥—Ä–∞",8:"–ö—Ä–µ—Å—Ç—Ü–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",
        9:"–Ø–≥–æ–¥–∏—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",10:"–ë–æ–∫–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å –∂–∏–≤–æ—Ç–∞",11:"–ü–æ—è—Å–Ω–∏—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",12:"–ü–æ–∑–≤–æ–Ω–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
        13:"–ü–æ–¥–ª–æ–ø–∞—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",14:"–ó–∞–¥–Ω—è—è –ª–æ–∫—Ç–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",15:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø–ª–µ—á–∞",16:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è",
        17:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø–ª–µ—á–∞",18:"–¢—ã–ª –∫–∏—Å—Ç–∏",19:"–ù–∞–¥–ª–æ–ø–∞—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",20:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å —à–µ–∏",
        21:"–ó–∞—Ç—ã–ª–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",22:"–°–∫—É–ª–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",23:"–¢–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",24:"–í–∏—Å–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
        25:"–õ–æ–±–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",26:"–ì–ª–∞–∑–Ω–∏—Ü–∞",27:"–©—ë—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",28:"–ü–æ–¥–Ω–∏–∂–Ω–µ—á–µ–ª—é—Å—Ç–Ω–æ–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫",
        29:"–ì—Ä—É–¥–∏–Ω–æ-–∫–ª—é—á–∏—á–Ω–æ-—Å–æ—Å—Ü–µ–≤–∏–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",30:"–ê–∫—Ä–æ–º–∏–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",31:"–ú–µ–∂–ª–æ–ø–∞—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
        32:"–î–µ–ª—å—Ç–æ–≤–∏–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",33:"–õ–æ–ø–∞—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",34:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø–ª–µ—á–∞",35:"–õ–∞—Ç–µ—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –≥—Ä—É–¥–∏",
        36:"–ó–∞–¥–Ω—è—è –ª–æ–∫—Ç–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",37:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è",38:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è",
        39:"–ö–∏—Å—Ç—å, –ª–∞–¥–æ–Ω—å",40:"–ü–æ–¥—Ä—ë–±–µ—Ä–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",41:"–ü—è—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å"
      };
      const FRONT = {
        1:"–ü—É–ø–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",2:"–ü–æ–¥—á—Ä–µ–≤–Ω–∞—è (–ª–æ–±–∫–æ–≤–∞—è) –æ–±–ª–∞—Å—Ç—å",3:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è",4:"–¢—ã–ª –∫–∏—Å—Ç–∏",
        5:"–ü—Ä–µ–¥–ø–ª–µ—á—å–µ",6:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è",7:"–ó–∞–¥–Ω—è—è –ª–æ–∫—Ç–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",8:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø–ª–µ—á–∞",
        9:"–ì—Ä—É–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",10:"–î–µ–ª—å—Ç–æ–≤–∏–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",11:"–ö–ª—é—á–∏—á–Ω–æ-–≥—Ä—É–¥–Ω–æ–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫",
        12:"–ì—Ä—É–¥–∏–Ω–æ-–∫–ª—é—á–∏—á–Ω–æ-—Å–æ—Å—Ü–µ–≤–∏–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",13:"–û–±–ª–∞—Å—Ç—å —Ä—Ç–∞",14:"–û–±–ª–∞—Å—Ç—å –Ω–æ—Å–∞",
        15:"–í–∏—Å–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",16:"–ì–ª–∞–∑–Ω–∏—Ü–∞",17:"–õ–æ–±–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",18:"–¢–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
        19:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å —à–µ–∏",20:"–ü–æ–¥–±–æ—Ä–æ–¥–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",21:"–õ–∞—Ç–µ—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —à–µ–∏",22:"–û–±–ª–∞—Å—Ç—å –∫–ª—é—á–∏—Ü—ã",
        23:"–ü–æ–¥–∫–ª—é—á–∏—á–Ω–∞—è —è–º–∫–∞",24:"–õ–∞–¥–æ–Ω—å",25:"–ü–µ—Ä–µ–¥–Ω—è—è –ª–æ–∫—Ç–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",26:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø–ª–µ—á–∞",
        27:"–ü–æ–¥–º—ã—à–µ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",28:"–ì—Ä—É–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",29:"–ü–æ–¥—Ä—ë–±–µ—Ä–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",30:"–ù–∞–¥—á—Ä–µ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
        31:"–ë–æ–∫–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å –∂–∏–≤–æ—Ç–∞",32:"–ü–∞—Ö–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",33:"–ë–µ–¥—Ä–µ–Ω–Ω—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫",34:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –±–µ–¥—Ä–∞",
        35:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –∫–æ–ª–µ–Ω–∞",36:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –≥–æ–ª–µ–Ω–∏",37:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –≥–æ–ª–µ–Ω–∏",
        38:"–ü–µ—Ä–µ–¥–Ω—è—è –≥–æ–ª–µ–Ω–æ—Å—Ç–æ–ø–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",39:"–ü—è—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",40:"–¢—ã–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å—Ç–æ–ø—ã"
      };

      const POINTS_KEY="medmap_points_v2";        // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–µ—Ç–æ–∫: {front:{n:{x,y}}, back:{...}}
      const SEL_FRONT="medmap_sel_front_v2";
      const SEL_BACK="medmap_sel_back_v2";
      const META_FRONT="medmap_meta_front_v2";    // { [num]: { lr:"L"/"R", shrapnel:bool, ... } }
      const META_BACK="medmap_meta_back_v2";

      function loadJSON(key, fallback){
        try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):fallback; }catch(_){ return fallback; }
      }
      function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

      function loadPoints(){
        const p=loadJSON(POINTS_KEY,{front:{},back:{}});
        if(!p.front) p.front={};
        if(!p.back) p.back={};
        return p;
      }
      function loadSel(side){
        const key = side==="front"?SEL_FRONT:SEL_BACK;
        const arr=loadJSON(key,[]);
        return Array.isArray(arr)?arr.map(String):[];
      }
      function saveSel(side,arr){
        const key = side==="front"?SEL_FRONT:SEL_BACK;
        saveJSON(key,arr);
      }
      function loadMeta(side){
        const key = side==="front"?META_FRONT:META_BACK;
        const obj=loadJSON(key,{});
        return (obj && typeof obj==="object")?obj:{};
      }
      function saveMeta(side,obj){
        const key = side==="front"?META_FRONT:META_BACK;
        saveJSON(key,obj);
      }

      function dictFor(side){ return side==="front"?FRONT:BACK; }
      function uniqNums(arr){
        const seen={}, out=[];
        for(let i=0;i<arr.length;i++){
          const n=parseInt(arr[i],10);
          if(isFinite(n) && !seen[n]){ seen[n]=1; out.push(String(n)); }
        }
        return out;
      }

      const bodyImage=$("bodyImage");
      const pinsLayer=$("pinsLayer");
      const btnFront=$("btnFront");
      const btnBack=$("btnBack");
      const zoneNumEl=$("zoneNum");
      const zonesUI=$("zonesUI");
      const finalEl=$("finalMsg");
      const dtEl=$("dt");
      const callEl=$("call");
      const commentEl=$("comment");
      const btnMakePDF=$("btnMakePDF");
      const btnTG=$("btnTG");

      let view="front";
      let pdfBusy=false;

      function markReq(el, ok){ if(ok) el.classList.remove("reqBad"); else el.classList.add("reqBad"); }
      function validateRequired(){
        const dt=(dtEl.value||"").trim();
        const call=(callEl.value||"").trim();
        const comment=(commentEl.value||"").trim();
        const okDt=!!dt, okCall=!!call, okComment=!!comment;
        markReq(dtEl,okDt); markReq(callEl,okCall); markReq(commentEl,okComment);
        const miss=[];
        if(!okDt) miss.push("–î–∞—Ç–∞/–≤—Ä–µ–º—è");
        if(!okCall) miss.push("–ü–æ–∑—ã–≤–Ω–æ–π");
        if(!okComment) miss.push("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
        return {ok: okDt&&okCall&&okComment, missing: miss};
      }

      const TRAUMAS=[
        {key:"shrapnel",label:"–û—Å–∫–æ–ª–æ—á–Ω–æ–µ",abbr:"–û–°–ö"},
        {key:"sor",label:"–°–û–† (—Å–ª–µ–ø–æ–µ –æ—Å–∫–æ–ª–æ—á–Ω–æ–µ)",abbr:"–°–û–†"},
        {key:"mvt",label:"–ú–í–¢",abbr:"–ú–í–¢"},
        {key:"burn",label:"–û–∂–æ–≥",abbr:"–û–ñ"},
        {key:"fracture",label:"–ü–µ—Ä–µ–ª–æ–º",abbr:"–ü–ï–†"}
      ];

      function zoneClassByName(name){
        const s=(name||"").toLowerCase();
        const head=["–ª–æ–±","–≤–∏—Å–æ—á","—Ç–µ–º–µ–Ω–Ω","–∑–∞—Ç—ã–ª","—Å–∫—É–ª","–≥–ª–∞–∑–Ω–∏—Ü","—â—ë—á","–Ω–æ—Å","—Ä–æ—Ç","–ø–æ–¥–±–æ—Ä–æ–¥"];
        for(let i=0;i<head.length;i++) if(s.indexOf(head[i])!==-1) return "head";
        if(s.indexOf("—à–µ–∏")!==-1 || s.indexOf("–≥—Ä—É–¥–∏–Ω–æ-–∫–ª—é—á–∏—á–Ω–æ-—Å–æ—Å—Ü–µ–≤–∏–¥")!==-1 || s.indexOf("–ø–æ–¥–Ω–∏–∂–Ω–µ—á–µ–ª—é—Å—Ç")!==-1) return "neck";
        const upper=["–ø–ª–µ—á","–ø—Ä–µ–¥–ø–ª–µ—á","–ª–æ–∫—Ç","–∫–∏—Å—Ç","–ª–∞–¥–æ–Ω","–¥–µ–ª—å—Ç–æ–≤","–∞–∫—Ä–æ–º–∏","–ø–æ–¥–º—ã—à"];
        for(let i=0;i<upper.length;i++) if(s.indexOf(upper[i])!==-1) return "limb_upper";
        const lower=["–±–µ–¥—Ä","–∫–æ–ª–µ–Ω","–≥–æ–ª–µ–Ω","—Å—Ç–æ–ø","–ø—è—Ç","–ø–æ–¥–æ—à–≤","–≥–æ–ª–µ–Ω–æ—Å—Ç–æ–ø"];
        for(let i=0;i<lower.length;i++) if(s.indexOf(lower[ifor(let i=0;i<lower.length;i++) if(s.indexOf(lower[i])!==-1) return "limb_lower";
        return "trunk";
      }

      function addPin(x, y, label, side) {
        const pin = document.createElement('div');
        pin.classList.add('pin');
        pin.classList.add(side);
        pin.style.left = `${x}%`;
        pin.style.top = `${y}%`;
        pin.textContent = label;

        pin.addEventListener('click', () => {
          pin.classList.toggle('selected');
          updateSelectedZones();
        });

        pinsLayer.appendChild(pin);
      }

      function updateSelectedZones() {
        const selectedPins = [...document.querySelectorAll('.pin.selected')];
        const selectedZones = selectedPins.map(pin => pin.textContent);
        zonesUI.innerHTML = selectedZones.join('<br/>');
      }

      btnFront.addEventListener('click', () => {
        view = 'front';
        bodyImage.src = 'body_front.png';
        updateSelectedZones();
        btnFront.classList.add('active');
        btnBack.classList.remove('active');
      });

      btnBack.addEventListener('click', () => {
        view = 'back';
        bodyImage.src = 'body_back.png';
        updateSelectedZones();
        btnBack.classList.add('active');
        btnFront.classList.remove('active');
      });

      btnAddZone.addEventListener('click', () => {
        const zoneNum = zoneNumEl.value.trim();
        if (zoneNum) {
          const zoneClass = zoneClassByName(zoneNum);
          addPin(10 + Math.random() * 80, 10 + Math.random() * 80, zoneNum, view);  // –ø—Ä–∏–º–µ—Ä —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
          toast(`–ó–æ–Ω–∞ ${zoneNum} –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ ${view === 'front' ? '–ø–µ—Ä–µ–¥' : '—Å–ø–∏–Ω—É'}`);
        }
      });

      btnCopy.addEventListener('click', () => {
        const data = {
          date: dtEl.value,
          call: callEl.value,
          comment: commentEl.value,
          zones: zonesUI.innerHTML
        };
        const text = `–û—Ç—á–µ—Ç: \n–î–∞—Ç–∞: ${data.date}\n–ü–æ–∑—ã–≤–Ω–æ–π: ${data.call}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${data.comment}\n–ó–æ–Ω—ã: ${data.zones}`;
        navigator.clipboard.writeText(text).then(() => {
          toast('–û—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
        });
      });

      btnShort.addEventListener('click', () => {
        const shortReport = `–î–∞—Ç–∞: ${dtEl.value}\n–ü–æ–∑—ã–≤–Ω–æ–π: ${callEl.value}\n–ó–æ–Ω—ã: ${zonesUI.innerHTML}`;
        toast(`–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞: \n${shortReport}`);
      });

      btnMakePDF.addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('–û—Ç—á–µ—Ç –ø–æ —Ä–∞–Ω–µ–Ω–∏—è–º', 10, 10);
        doc.text(`–î–∞—Ç–∞: ${dtEl.value}`, 10, 20);
        doc.text(`–ü–æ–∑—ã–≤–Ω–æ–π: ${callEl.value}`, 10, 30);
        doc.text(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${commentEl.value}`, 10, 40);
        doc.text(`–ó–æ–Ω—ã: ${zonesUI.innerHTML}`, 10, 50);
        doc.save('report.pdf');
        toast('PDF —Å –æ—Ç—á–µ—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
      });

      btnTG.addEventListener('click', () => {
        const message = `–û—Ç—á–µ—Ç –ø–æ —Ä–∞–Ω–µ–Ω–∏—è–º:\n–î–∞—Ç–∞: ${dtEl.value}\n–ü–æ–∑—ã–≤–Ω–æ–π: ${callEl.value}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${commentEl.value}\n–ó–æ–Ω—ã: ${zonesUI.innerHTML}`;
        const tgUrl = `https://t.me/share/url?url=${encodeURIComponent(message)}&text=–û—Ç—á–µ—Ç –ø–æ —Ä–∞–Ω–µ–Ω–∏—è–º`;
        window.open(tgUrl, '_blank');
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      btnFront.classList.add('active');
      addPin(10, 10, '–ü–µ—Ä–≤–∞—è –∑–æ–Ω–∞', 'front');  // –ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
    })();
  </script>
</body>
</html>
