<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞—Ä—Ç–∞ —Ä–∞–Ω–µ–Ω–∏–π</title>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body{ margin:0; font-family: Arial, sans-serif; background:#fff; color:#111; }
    .title{ padding:10px; text-align:center; font-weight:700; font-size:18px; }
    .topStatus{ padding:10px 12px; font-size:14px; background:#dff7df; border-bottom:1px solid #a9d9a9; color:#333; white-space:pre-wrap; }
    .topStatus.bad{ background:#ffe1e1; border-bottom:1px solid #f0a6a6; color:#8a1f1f; }

    .tabs{ display:flex; }
    .tab{ width:100%; padding:14px; font-size:17px; border:none; background:#222; color:#fff; touch-action: manipulation; }
    .tab.active{ background:#0b6623; }
    .tab:active{ opacity:.85; }

    .wrap{ position:relative; width:100%; }
    .map{ width:100%; display:block; user-select:none; -webkit-user-drag:none; }

    #pinsLayer{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:10; }

    .pin{
      position:absolute; transform: translate(-50%,-50%);
      min-width:26px; height:26px; padding:0 6px; border-radius:999px;
      color:#fff; font-weight:800; font-size:13px; display:flex; align-items:center; justify-content:center;
      z-index:20; border:2px solid rgba(255,255,255,0.95);
      box-shadow:0 1px 6px rgba(0,0,0,0.18);
      pointer-events:auto; cursor:pointer; user-select:none; touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    /* –ü–ï–†–ï–î ‚Äî —Å–∏–Ω–∏–π, –°–ü–ò–ù–ê ‚Äî –∫—Ä–∞—Å–Ω—ã–π */
    .pin.front{ background: rgba(0,120,255,0.90); }
    .pin.back{  background: rgba(255,0,0,0.90); }

    /* –í–´–ë–†–ê–ù–û ‚Äî –∂–µ–ª—Ç—ã–π */
    .pin.selected{
      outline:3px solid rgba(255,255,255,0.95);
      transform: translate(-50%,-50%) scale(1.08);
      filter:none;
    }
    .pin.front.selected,
    .pin.back.selected{
      background: rgba(255, 200, 0, 0.98);
      color:#111;
      border-color: rgba(0,0,0,0.15);
    }

    .panel{ padding:12px; border-top:1px solid #ddd; background:#fafafa; }
    label{ display:block; font-size:13px; color:#444; margin:10px 0 6px; }
    input, textarea{
      width:100%; box-sizing:border-box; padding:10px; font-size:15px;
      border:1px solid #ccc; border-radius:10px; background:#fff;
    }
    textarea{ min-height:55px; }
    .row{ display:flex; gap:10px; }
    .col{ width:100%; }

    .btn2{
      width:100%; padding:12px; font-size:16px; border:1px solid #222;
      background:#fff; color:#222; border-radius:10px; margin-top:10px;
      touch-action: manipulation;
    }
    .btn2:active{ opacity:.85; }
    .btn2:disabled{ opacity:.55; }

    .hint{ font-size:12px; color:#666; margin-top:6px; }
    .reqBad{ border-color:#d11 !important; box-shadow:0 0 0 3px rgba(209,17,17,0.15); }

    .zoneCard{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:10px; margin-top:10px; }
    .zoneHead{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; font-size:14px; font-weight:700; }
    .zoneSub{ margin-top:4px; font-size:12px; color:#444; font-weight:400; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .chk{
      display:flex; align-items:center; gap:10px;
      padding:10px; border:1px solid #eee; border-radius:12px;
      background:#fafafa; font-size:14px; user-select:none; touch-action: manipulation;
    }
    .chk input{ width:22px; height:22px; margin:0; }

    .miniBtn{
      border:1px solid #222; background:#fff; color:#222;
      border-radius:10px; padding:6px 10px; font-size:13px; min-width:88px;
      touch-action: manipulation;
    }
    .miniBtn:active{ opacity:.85; }

    /* –õ–ï–í–û/–ü–†–ê–í–û ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    .lrRow{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .lrBtn{
      flex:1;
      border:1px solid #ddd;
      border-radius:12px;
      padding:12px 10px;
      background:#f6f6f6;
      font-size:14px;
      font-weight:700;
      text-align:center;
      user-select:none;
      touch-action: manipulation;
    }
    .lrBtn.active{
      border-color:#0b6623;
      background:#e9f7ee;
    }

    .out{
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; padding:10px; border:1px solid #ddd; border-radius:10px;
      background:#fff; margin-top:10px;
    }

    .bar{
      display:flex; gap:10px; padding:10px 12px; border-top:1px solid #ddd;
      background:#fafafa; position:sticky; bottom:0; z-index:30;
    }
    .bar button{
      width:100%; padding:14px; font-size:16px; border:none; border-radius:10px;
      color:#fff; background:#0b6623; touch-action: manipulation;
    }
    .bar button:active{ opacity:.85; }
    .bar button:disabled{ opacity:.55; }

    .bar .tg{ background:#2a76d2; }

    .miniRow{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .miniRow .btn2{ margin-top:0; }

    #toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background:rgba(0,0,0,0.85); color:#fff; padding:10px 12px; border-radius:12px;
      font-size:14px; max-width:92%; z-index:9999; display:none; white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="title">–ö–ê–†–¢–ê –†–ê–ù–ï–ù–ò–ô</div>
  <div id="topStatus" class="topStatus">JS: OK (–∫–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞)</div>

  <div class="tabs">
    <button class="tab" id="btnFront" type="button">–ü–ï–†–ï–î</button>
    <button class="tab" id="btnBack" type="button">–°–ü–ò–ù–ê</button>
  </div>

  <div class="wrap">
    <img id="bodyImage" class="map" src="body_front.png" alt="body">
    <div id="pinsLayer"></div>
  </div>

  <div class="panel">
    <div class="row">
      <div class="col">
        <label>–î–∞—Ç–∞/–≤—Ä–µ–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="dt" type="datetime-local"/>
      </div>
      <div class="col">
        <label>–ü–æ–∑—ã–≤–Ω–æ–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="call" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–ê–†–°-12"/>
      </div>
    </div>

    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
    <textarea id="comment" placeholder="–∫—Ä–∞—Ç–∫–æ..."></textarea>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label>–í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –∑–æ–Ω—ã (–¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç–æ—Ä–æ–Ω—ã)</label>
        <input id="zoneNum" type="number" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 12"/>
        <div class="hint">–ù–∞–∂–º–∏ ‚Äú–î–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å‚Äù ‚Äî —ç—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å.</div>
      </div>
      <div class="col" style="display:flex;align-items:flex-end;">
        <button class="btn2" id="btnAddZone" type="button" style="margin-top:0;">–î–û–ë–ê–í–ò–¢–¨/–£–ë–†–ê–¢–¨</button>
      </div>
    </div>

    <div class="hint" style="margin-top:10px;">
      –¢–µ–ø–µ—Ä—å –õ–ï–í–û/–ü–†–ê–í–û –µ—Å—Ç—å –¥–ª—è –≤—Å–µ—Ö –∑–æ–Ω, –∫—Ä–æ–º–µ:
      <b>–ü–æ–∑–≤–æ–Ω–æ—á–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏</b> –∏ <b>–ü—É–ø–æ—á–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏</b>.
      <br/>üéÅ –ù–æ–≤–∞—è —Ñ–∏—à–∫–∞: –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–æ–Ω—ã —Å—Ç–æ—Ä–æ–Ω–∞ —Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –ø–æ–ª–æ–∂–µ–Ω–∏—é –º–µ—Ç–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞) ‚Äî –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–Ω–æ–ø–∫–∞–º–∏.
    </div>

    <div id="zonesUI"></div>

    <div class="miniRow">
      <button class="btn2" id="btnRefresh" type="button">–û–ë–ù–û–í–ò–¢–¨ –û–¢–ß–Å–¢</button>
      <button class="btn2" id="btnCopy" type="button">–ö–û–ü–ò–†–û–í–ê–¢–¨</button>
    </div>

    <button class="btn2" id="btnShort" type="button">–ö–û–†–û–¢–ö–ê–Ø –°–í–û–î–ö–ê (–¥–ª—è —Ä–∞—Ü–∏–∏)</button>

    <div class="out" id="finalMsg"></div>
  </div>

  <div class="bar">
    <button id="btnMakePDF" type="button">–°–î–ï–õ–ê–¢–¨ PDF (2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã)</button>
    <button id="btnTG" class="tg" type="button">TELEGRAM</button>
    <button id="btnHelp" type="button" style="background:#444;">–ò–ù–°–¢–†–£–ö–¶–ò–Ø</button>
    <button type="button" style="background:#444;" onclick="location.href='./evac.html'">–≠–í–ê–ö–£–ê–¶–ò–Ø</button>
  </div>

  <div id="toast"></div>

<script>
(function(){
  const top = document.getElementById("topStatus");
  const toastEl = document.getElementById("toast");
  function setTopBad(msg){ top.className="topStatus bad"; top.textContent=msg; }
  function toast(msg, ms){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>{ toastEl.style.display="none"; }, ms || 2400);
  }

  window.addEventListener("error", (e)=>{
    setTopBad("JS –û–®–ò–ë–ö–ê:\n" + (e.message || "unknown") + "\n" + (e.filename||"") + ":" + (e.lineno||""));
  });
  window.addEventListener("unhandledrejection", (e)=>{
    setTopBad("JS PROMISE –û–®–ò–ë–ö–ê:\n" + (e.reason && (e.reason.message || e.reason) || "unknown"));
  });

  const $ = (id)=>document.getElementById(id);

  /* ===== –°–õ–û–í–ê–†–ò –ó–û–ù ===== */
  const BACK = {
    1:"–ü–æ–¥–æ—à–≤–∞",2:"–¢—ã–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å—Ç–æ–ø—ã",3:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –≥–æ–ª–µ–Ω–∏",4:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –≥–æ–ª–µ–Ω–∏",
    5:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –∫–æ–ª–µ–Ω–∞",6:"–ó–∞–¥–Ω–µ–ø—Ä–æ—Ö–æ–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",7:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –±–µ–¥—Ä–∞",8:"–ö—Ä–µ—Å—Ç—Ü–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",
    9:"–Ø–≥–æ–¥–∏—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",10:"–ë–æ–∫–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å –∂–∏–≤–æ—Ç–∞",11:"–ü–æ—è—Å–Ω–∏—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",12:"–ü–æ–∑–≤–æ–Ω–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
    13:"–ü–æ–¥–ª–æ–ø–∞—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",14:"–ó–∞–¥–Ω—è—è –ª–æ–∫—Ç–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",15:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø–ª–µ—á–∞",16:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è",
    17:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø–ª–µ—á–∞",18:"–¢—ã–ª –∫–∏—Å—Ç–∏",19:"–ù–∞–¥–ª–æ–ø–∞—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",20:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å —à–µ–∏",
    21:"–ó–∞—Ç—ã–ª–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",22:"–°–∫—É–ª–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",23:"–¢–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",24:"–í–∏—Å–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
    25:"–õ–æ–±–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",26:"–ì–ª–∞–∑–Ω–∏—Ü–∞",27:"–©—ë—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",28:"–ü–æ–¥–Ω–∏–∂–Ω–µ—á–µ–ª—é—Å—Ç–Ω–æ–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫",
    29:"–ì—Ä—É–¥–∏–Ω–æ-–∫–ª—é—á–∏—á–Ω–æ-—Å–æ—Å—Ü–µ–≤–∏–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",30:"–ê–∫—Ä–æ–º–∏–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",31:"–ú–µ–∂–ª–æ–ø–∞—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
    32:"–î–µ–ª—å—Ç–æ–≤–∏–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",33:"–õ–æ–ø–∞—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",34:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø–ª–µ—á–∞",35:"–õ–∞—Ç–µ—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –≥—Ä—É–¥–∏",
    36:"–ó–∞–¥–Ω—è—è –ª–æ–∫—Ç–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",37:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è",38:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è",
    39:"–ö–∏—Å—Ç—å, –ª–∞–¥–æ–Ω—å",40:"–ü–æ–¥—Ä—ë–±–µ—Ä–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",41:"–ü—è—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å"
  };
  const FRONT = {
    1:"–ü—É–ø–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",2:"–ü–æ–¥—á—Ä–µ–≤–Ω–∞—è (–ª–æ–±–∫–æ–≤–∞—è) –æ–±–ª–∞—Å—Ç—å",3:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è",4:"–¢—ã–ª –∫–∏—Å—Ç–∏",
    5:"–ü—Ä–µ–¥–ø–ª–µ—á—å–µ",6:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è",7:"–ó–∞–¥–Ω—è—è –ª–æ–∫—Ç–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",8:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø–ª–µ—á–∞",
    9:"–ì—Ä—É–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",10:"–î–µ–ª—å—Ç–æ–≤–∏–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",11:"–ö–ª—é—á–∏—á–Ω–æ-–≥—Ä—É–¥–Ω–æ–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫",
    12:"–ì—Ä—É–¥–∏–Ω–æ-–∫–ª—é—á–∏—á–Ω–æ-—Å–æ—Å—Ü–µ–≤–∏–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",13:"–û–±–ª–∞—Å—Ç—å —Ä—Ç–∞",14:"–û–±–ª–∞—Å—Ç—å –Ω–æ—Å–∞",
    15:"–í–∏—Å–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",16:"–ì–ª–∞–∑–Ω–∏—Ü–∞",17:"–õ–æ–±–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",18:"–¢–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
    19:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å —à–µ–∏",20:"–ü–æ–¥–±–æ—Ä–æ–¥–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",21:"–õ–∞—Ç–µ—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —à–µ–∏",22:"–û–±–ª–∞—Å—Ç—å –∫–ª—é—á–∏—Ü—ã",
    23:"–ü–æ–¥–∫–ª—é—á–∏—á–Ω–∞—è —è–º–∫–∞",24:"–õ–∞–¥–æ–Ω—å",25:"–ü–µ—Ä–µ–¥–Ω—è—è –ª–æ–∫—Ç–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",26:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –ø–ª–µ—á–∞",
    27:"–ü–æ–¥–º—ã—à–µ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",28:"–ì—Ä—É–¥–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",29:"–ü–æ–¥—Ä—ë–±–µ—Ä–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",30:"–ù–∞–¥—á—Ä–µ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
    31:"–ë–æ–∫–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å –∂–∏–≤–æ—Ç–∞",32:"–ü–∞—Ö–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å",33:"–ë–µ–¥—Ä–µ–Ω–Ω—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫",34:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –±–µ–¥—Ä–∞",
    35:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –∫–æ–ª–µ–Ω–∞",36:"–ó–∞–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –≥–æ–ª–µ–Ω–∏",37:"–ü–µ—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å –≥–æ–ª–µ–Ω–∏",
    38:"–ü–µ—Ä–µ–¥–Ω—è—è –≥–æ–ª–µ–Ω–æ—Å—Ç–æ–ø–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",39:"–ü—è—Ç–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",40:"–¢—ã–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å—Ç–æ–ø—ã"
  };

  /* ===== –•–†–ê–ù–ò–õ–ò–©–ï ===== */
  const POINTS_KEY="medmap_points_v2";        // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–µ—Ç–æ–∫: {front:{n:{x,y}}, back:{...}}
  const SEL_FRONT="medmap_sel_front_v4";
  const SEL_BACK="medmap_sel_back_v4";
  const META_FRONT="medmap_meta_front_v4";    // { [num]: { lr:"L"/"R", shrapnel:bool, ... } }
  const META_BACK="medmap_meta_back_v4";

  function loadJSON(key, fallback){
    try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):fallback; }catch(_){ return fallback; }
  }
  function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

  function loadPoints(){
    const p=loadJSON(POINTS_KEY,{front:{},back:{}});
    if(!p.front) p.front={};
    if(!p.back) p.back={};
    return p;
  }
  function loadSel(side){
    const key = side==="front"?SEL_FRONT:SEL_BACK;
    const arr=loadJSON(key,[]);
    return Array.isArray(arr)?arr.map(String):[];
  }
  function saveSel(side,arr){
    const key = side==="front"?SEL_FRONT:SEL_BACK;
    saveJSON(key,arr);
  }
  function loadMeta(side){
    const key = side==="front"?META_FRONT:META_BACK;
    const obj=loadJSON(key,{});
    return (obj && typeof obj==="object")?obj:{};
  }
  function saveMeta(side,obj){
    const key = side==="front"?META_FRONT:META_BACK;
    saveJSON(key,obj);
  }

  function dictFor(side){ return side==="front"?FRONT:BACK; }
  function uniqNums(arr){
    const seen={}, out=[];
    for(let i=0;i<arr.length;i++){
      const n=parseInt(arr[i],10);
      if(isFinite(n) && !seen[n]){ seen[n]=1; out.push(String(n)); }
    }
    return out;
  }

  const bodyImage=$("bodyImage");
  const pinsLayer=$("pinsLayer");
  const btnFront=$("btnFront");
  const btnBack=$("btnBack");
  const zoneNumEl=$("zoneNum");
  const zonesUI=$("zonesUI");
  const finalEl=$("finalMsg");
  const dtEl=$("dt");
  const callEl=$("call");
  const commentEl=$("comment");
  const btnMakePDF=$("btnMakePDF");
  const btnTG=$("btnTG");

  let view="front";
  let pdfBusy=false;

  /* ===== –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–û–õ–Ø ===== */
  function markReq(el, ok){ if(ok) el.classList.remove("reqBad"); else el.classList.add("reqBad"); }
  function validateRequired(){
    const dt=(dtEl.value||"").trim();
    const call=(callEl.value||"").trim();
    const comment=(commentEl.value||"").trim();
    const okDt=!!dt, okCall=!!call, okComment=!!comment;
    markReq(dtEl,okDt); markReq(callEl,okCall); markReq(commentEl,okComment);
    const miss=[];
    if(!okDt) miss.push("–î–∞—Ç–∞/–≤—Ä–µ–º—è");
    if(!okCall) miss.push("–ü–æ–∑—ã–≤–Ω–æ–π");
    if(!okComment) miss.push("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π");
    return {ok: okDt&&okCall&&okComment, missing: miss};
  }

  /* ===== –¢–†–ê–í–ú–´ (–ü–£–õ–ï–í–û–ï –£–ë–†–ê–õ–ò) ===== */
  const TRAUMAS=[
    {key:"shrapnel",label:"–û—Å–∫–æ–ª–æ—á–Ω–æ–µ",abbr:"–û–°–ö"},
    {key:"sor",label:"–°–û–† (—Å–ª–µ–ø–æ–µ –æ—Å–∫–æ–ª–æ—á–Ω–æ–µ)",abbr:"–°–û–†"},
    {key:"mvt",label:"–ú–í–¢",abbr:"–ú–í–¢"},
    {key:"burn",label:"–û–∂–æ–≥",abbr:"–û–ñ"},
    {key:"fracture",label:"–ü–µ—Ä–µ–ª–æ–º",abbr:"–ü–ï–†"}
  ];

  /* ===== –ö–õ–ê–°–°–´ –ó–û–ù (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–µ—Ä–µ–ª–æ–º/—à–∏–Ω–∞) ===== */
  function zoneClassByName(name){
    const s=(name||"").toLowerCase();
    const head=["–ª–æ–±","–≤–∏—Å–æ—á","—Ç–µ–º–µ–Ω–Ω","–∑–∞—Ç—ã–ª","—Å–∫—É–ª","–≥–ª–∞–∑–Ω–∏—Ü","—â—ë—á","–Ω–æ—Å","—Ä–æ—Ç","–ø–æ–¥–±–æ—Ä–æ–¥"];
    for(let i=0;i<head.length;i++) if(s.indexOf(head[i])!==-1) return "head";
    if(s.indexOf("—à–µ–∏")!==-1 || s.indexOf("–≥—Ä—É–¥–∏–Ω–æ-–∫–ª—é—á–∏—á–Ω–æ-—Å–æ—Å—Ü–µ–≤–∏–¥")!==-1 || s.indexOf("–ø–æ–¥–Ω–∏–∂–Ω–µ—á–µ–ª—é—Å—Ç")!==-1) return "neck";
    const upper=["–ø–ª–µ—á","–ø—Ä–µ–¥–ø–ª–µ—á","–ª–æ–∫—Ç","–∫–∏—Å—Ç","–ª–∞–¥–æ–Ω","–¥–µ–ª—å—Ç–æ–≤","–∞–∫—Ä–æ–º–∏","–ø–æ–¥–º—ã—à"];
    for(let i=0;i<upper.length;i++) if(s.indexOf(upper[i])!==-1) return "limb_upper";
    const lower=["–±–µ–¥—Ä","–∫–æ–ª–µ–Ω","–≥–æ–ª–µ–Ω","—Å—Ç–æ–ø","–ø—è—Ç","–ø–æ–¥–æ—à–≤","–≥–æ–ª–µ–Ω–æ—Å—Ç–æ–ø"];
    for(let i=0;i<lower.length;i++) if(s.indexOf(lower[i])!==-1) return "limb_lower";
    return "trunk";
  }
  function allowedForClass(cls){
    // –ø–µ—Ä–µ–ª–æ–º + —à–∏–Ω–∞: —Ç–æ–ª—å–∫–æ –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏
    if(cls==="limb_upper" || cls==="limb_lower") return {shrapnel:1,sor:1,mvt:1,burn:1,fracture:1,splint:1};
    // –≥–æ–ª–æ–≤–∞/—à–µ—è: –±–µ–∑ –ø–µ—Ä–µ–ª–æ–º–∞ –∏ —à–∏–Ω—ã
    if(cls==="head" || cls==="neck") return {shrapnel:1,sor:1,mvt:1,burn:1,fracture:0,splint:0};
    // —Ç—É–ª–æ–≤–∏—â–µ: –±–µ–∑ –ø–µ—Ä–µ–ª–æ–º–∞ –∏ —à–∏–Ω—ã
    return {shrapnel:1,sor:1,mvt:1,burn:1,fracture:0,splint:0};
  }

  /* ===== –õ–ï–í–û/–ü–†–ê–í–û: –¥–ª—è –≤—Å–µ–≥–æ, –∫—Ä–æ–º–µ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–æ–π –∏ –ø—É–ø–æ—á–Ω–æ–π ===== */
  function needsLR(name){
    const s=(name||"").toLowerCase();
    if(s.indexOf("–ø–æ–∑–≤–æ–Ω–æ—á–Ω")!==-1) return false;  // –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
    if(s.indexOf("–ø—É–ø–æ—á–Ω")!==-1) return false;     // –ø—É–ø–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
    return true;
  }

  function lrLabel(lr){
    return lr==="R" ? "–ø—Ä–∞–≤–∞—è" : "–ª–µ–≤–∞—è";
  }

  function limbGroupByName(name){
    const cls=zoneClassByName(name);
    if(cls==="limb_upper") return "–í–ö";
    if(cls==="limb_lower") return "–ù–ö";
    if(cls==="head") return "–ì–û–õ–û–í–ê";
    if(cls==="neck") return "–®–ï–Ø";
    return "–¢–£–õ–û–í–ò–©–ï";
  }

  function traumaAbbrList(meta){
    const out=[];
    for(const t of TRAUMAS){
      if(meta && meta[t.key]) out.push(t.abbr);
    }
    return out;
  }

  /* ===== –ù–û–í–ê–Ø –§–ò–®–ö–ê: –∞–≤—Ç–æ-—Å—Ç–æ—Ä–æ–Ω–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ –º–µ—Ç–∫–∏ ===== */
  function autoLRForZone(side, num){
    // –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏: x < 50 => L, –∏–Ω–∞—á–µ R
    const points=loadPoints();
    const map = side==="front" ? points.front : points.back;
    const p = map && map[num];
    if(p && typeof p.x==="number"){
      return (p.x < 50) ? "L" : "R";
    }
    return "L";
  }

  /* ===== –ü–ò–ù–´ ===== */
  function clearPins(){ pinsLayer.innerHTML=""; }

  function addPin(num,x,y,selected){
    const pin=document.createElement("div");
    pin.className="pin " + (view==="front"?"front":"back") + (selected?" selected":"");
    pin.style.left=x+"%";
    pin.style.top=y+"%";
    pin.textContent=String(num);

    pin.addEventListener("pointerdown",(e)=>{
      e.preventDefault(); e.stopPropagation();
      toggleZone(num);
    });

    pinsLayer.appendChild(pin);
  }

  function renderPins(){
    const points=loadPoints();
    const map=view==="front"?points.front:points.back;
    const sel=loadSel(view);
    const selSet={}; for(let i=0;i<sel.length;i++) selSet[sel[i]]=1;

    clearPins();

    // —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
    for(let i=0;i<sel.length;i++){
      const k=sel[i];
      if(map[k]) addPin(k, map[k].x, map[k].y, true);
    }
    // –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    const keys=Object.keys(map);
    for(let i=0;i<keys.length;i++){
      const k=keys[i];
      if(!selSet[k] && map[k]) addPin(k, map[k].x, map[k].y, false);
    }
  }

  function ensureMeta(side, n){
    const m=loadMeta(side);
    if(!m[n]) m[n]={};
    return m;
  }

  function toggleZone(num){
    const n=String(parseInt(num,10));
    let sel=loadSel(view);

    let idx=-1;
    for(let i=0;i<sel.length;i++){ if(sel[i]===n){ idx=i; break; } }

    if(idx>=0){
      sel.splice(idx,1);
      saveSel(view, uniqNums(sel));
      renderAll();
      return;
    }

    // –¥–æ–±–∞–≤–∏—Ç—å
    sel.push(n);
    saveSel(view, uniqNums(sel));

    // –∞–≤—Ç–æ-—Å—Ç–æ—Ä–æ–Ω–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞
    const dict=dictFor(view);
    const name=dict[parseInt(n,10)] || "";
    if(needsLR(name)){
      const m=ensureMeta(view, n);
      if(m[n].lr!=="L" && m[n].lr!=="R"){
        m[n].lr = autoLRForZone(view, n);
        saveMeta(view, m);
      }
    }

    renderAll();
  }

  function setTrauma(num,key,val){
    const n=String(parseInt(num,10));
    const m=ensureMeta(view, n);
    m[n][key]=!!val;
    saveMeta(view,m);
    renderAll(false);
  }

  function setLR(num, lr){
    const n=String(parseInt(num,10));
    const m=ensureMeta(view, n);
    m[n].lr = lr;
    saveMeta(view,m);
    renderAll(false);
  }

  /* ===== UI –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–æ–Ω ===== */
  function renderZonesUI(){
    const sel=loadSel(view).sort((a,b)=>parseInt(a,10)-parseInt(b,10));
    const meta=loadMeta(view);
    const dict=dictFor(view);

    zonesUI.innerHTML="";
    if(sel.length===0){
      const empty=document.createElement("div");
      empty.className="hint";
      empty.textContent="–ó–æ–Ω—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã. –¢–∞–ø–Ω–∏ –ø–æ –º–µ—Ç–∫–µ –∏–ª–∏ –≤–≤–µ–¥–∏ –Ω–æ–º–µ—Ä.";
      zonesUI.appendChild(empty);
      return;
    }

    for(let i=0;i<sel.length;i++){
      const num=sel[i];
      const name=dict[parseInt(num,10)] || "–ù–ï–ò–ó–í–ï–°–¢–ù–û";
      const cls=zoneClassByName(name);
      const allow=allowedForClass(cls);
      const cur=meta[num] || {};

      const card=document.createElement("div");
      card.className="zoneCard";

      const head=document.createElement("div");
      head.className="zoneHead";
      head.innerHTML=`<div>[${num}] ${name}<div class="zoneSub">–°—Ç–æ—Ä–æ–Ω–∞: ${view==="front"?"–ü–ï–†–ï–î":"–°–ü–ò–ù–ê"}</div></div>`;

      const delBtn=document.createElement("button");
      delBtn.className="miniBtn";
      delBtn.type="button";
      delBtn.textContent="–£–±—Ä–∞—Ç—å";
      delBtn.addEventListener("pointerdown",(e)=>{ e.preventDefault(); toggleZone(num); });
      head.appendChild(delBtn);
      card.appendChild(head);

      /* –õ–ï–í–û/–ü–†–ê–í–û ‚Äî –¥–ª—è –≤—Å–µ–≥–æ, –∫—Ä–æ–º–µ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–æ–π/–ø—É–ø–æ—á–Ω–æ–π */
      if(needsLR(name)){
        const curLR = (cur.lr==="L" || cur.lr==="R") ? cur.lr : autoLRForZone(view, num);

        const lrRow=document.createElement("div");
        lrRow.className="lrRow";

        const leftBtn=document.createElement("div");
        leftBtn.className="lrBtn" + (curLR==="L" ? " active" : "");
        leftBtn.textContent="–õ–ï–í–û";
        leftBtn.addEventListener("pointerdown",(e)=>{ e.preventDefault(); setLR(num,"L"); });

        const rightBtn=document.createElement("div");
        rightBtn.className="lrBtn" + (curLR==="R" ? " active" : "");
        rightBtn.textContent="–ü–†–ê–í–û";
        rightBtn.addEventListener("pointerdown",(e)=>{ e.preventDefault(); setLR(num,"R"); });

        lrRow.appendChild(leftBtn);
        lrRow.appendChild(rightBtn);
        card.appendChild(lrRow);
      }

      const grid=document.createElement("div");
      grid.className="grid";

      for(let j=0;j<TRAUMAS.length;j++){
        const tr=TRAUMAS[j];
        if(!allow[tr.key]) continue;

        const wrap=document.createElement("label");
        wrap.className="chk";

        const inp=document.createElement("input");
        inp.type="checkbox";
        inp.checked=!!cur[tr.key];
        inp.addEventListener("change", ()=> setTrauma(num,tr.key,inp.checked));

        const span=document.createElement("span");
        span.textContent=tr.label;

        wrap.appendChild(inp);
        wrap.appendChild(span);
        grid.appendChild(wrap);
      }

      if(allow.splint){
        const wrap=document.createElement("label");
        wrap.className="chk";

        const inp=document.createElement("input");
        inp.type="checkbox";
        inp.checked=!!cur.splint;
        inp.addEventListener("change", ()=> setTrauma(num,"splint",inp.checked));

        const span=document.createElement("span");
        span.textContent="–®–∏–Ω–∞ –Ω–∞–ª–æ–∂–µ–Ω–∞";

        wrap.appendChild(inp);
        wrap.appendChild(span);
        grid.appendChild(wrap);
      }

      card.appendChild(grid);
      zonesUI.appendChild(card);
    }
  }

  /* ===== –¢–ï–ö–°–¢ –û–¢–ß–Å–¢–ê ===== */
  function buildTextReport(){
    const dt=(dtEl.value||"").trim();
    const call=(callEl.value||"").trim();
    const comment=(commentEl.value||"").trim();

    const selFront=loadSel("front").sort((a,b)=>parseInt(a,10)-parseInt(b,10));
    const selBack=loadSel("back").sort((a,b)=>parseInt(a,10)-parseInt(b,10));
    const mf=loadMeta("front");
    const mb=loadMeta("back");

    function linesFor(side, sel, meta){
      const dict=dictFor(side);
      if(sel.length===0) return ["(–Ω–µ—Ç)"];
      const out=[];
      for(let i=0;i<sel.length;i++){
        const num=sel[i];
        const name=dict[parseInt(num,10)] || "–ù–ï–ò–ó–í–ï–°–¢–ù–û";
        const m=meta[num] || {};
        const abbr=traumaAbbrList(m);
        const spl=!!m.splint;

        let lrTxt="";
        if(needsLR(name)){
          const lr = (m.lr==="R") ? "R" : "L";
          lrTxt = ` (${lrLabel(lr)})`;
        }

        let line=`‚Ä¢ ${num} ‚Äî ${name}${lrTxt}`;
        if(abbr.length) line += `\n  –¢—Ä–∞–≤–º—ã: ${abbr.join(", ")}`;
        if(spl) line += `\n  –®–∏–Ω–∞: –¥–∞`;
        out.push(line);
      }
      return out;
    }

    return (
`–ú–ï–î –û–¢–ß–Å–¢
–î–∞—Ç–∞/–≤—Ä–µ–º—è: ${dt || "-"}
–ü–æ–∑—ã–≤–Ω–æ–π: ${call || "-"}

–ü–ï–†–ï–î:
${linesFor("front", selFront, mf).join("\n")}

–°–ü–ò–ù–ê:
${linesFor("back", selBack, mb).join("\n")}

–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
${comment || "-"}`
    );
  }

  /* ===== –ù–û–í–ê–Ø –§–ò–®–ö–ê ‚Ññ2: –∫–æ—Ä–æ—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ ‚Äú–¥–ª—è —Ä–∞—Ü–∏–∏‚Äù ===== */
  function shortSummary(){
    const selFront=loadSel("front");
    const selBack=loadSel("back");
    const mf=loadMeta("front");
    const mb=loadMeta("back");
    const df=dictFor("front");
    const db=dictFor("back");

    function pack(side, sel, meta, dict){
      const parts=[];
      for(const num of sel){
        const name=dict[parseInt(num,10)] || "";
        const m=meta[num] || {};
        const ab=traumaAbbrList(m);
        const grp=limbGroupByName(name);
        let where="";

        if(needsLR(name)){
          const lr=(m.lr==="R") ? "–ø—Ä–∞–≤–∞—è" : "–ª–µ–≤–∞—è";
          if(grp==="–í–ö" || grp==="–ù–ö") where = `${lr} ${grp}`;
          else where = `${lr} —Å—Ç–æ—Ä–æ–Ω–∞`;
        } else {
          where = grp;
        }

        const lead = ab.length ? ab.join("+") : "–ó–û–ù–ê";
        parts.push(`${lead} ${where} (‚Ññ${num})`);
      }
      return parts;
    }

    const all = [].concat(
      pack("front", selFront, mf, df),
      pack("back", selBack, mb, db)
    );

    if(!all.length) return "–°–≤–æ–¥–∫–∞: (–Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–æ–Ω)";
    return "–°–≤–æ–¥–∫–∞: " + all.join("; ");
  }

  function renderAll(updateText=true){
    renderPins();
    renderZonesUI();
    if(updateText) finalEl.textContent=buildTextReport();
  }

  function setView(side){
    view=side;
    bodyImage.src=(view==="front") ? "body_front.png" : "body_back.png";
    btnFront.classList.toggle("active", view==="front");
    btnBack.classList.toggle("active", view==="back");
    renderAll();
  }

  function addZoneFromInput(){
    const raw=(zoneNumEl.value||"").trim();
    const n=parseInt(raw,10);
    if(!isFinite(n)){ toast("–í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä –∑–æ–Ω—ã"); return; }
    const dict = dictFor(view);
    if(!dict[n]){ toast(`–ù–µ—Ç –∑–æ–Ω—ã ‚Ññ${n} –¥–ª—è —Å—Ç–æ—Ä–æ–Ω—ã: ${view==="front"?"–ü–ï–†–ï–î":"–°–ü–ò–ù–ê"}`, 2600); return; }
    toggleZone(n);
    zoneNumEl.value="";
  }

  /* ===== –ö–ù–û–ü–ö–ò ===== */
  $("btnCopy").addEventListener("pointerdown", async (e)=>{
    e.preventDefault();
    const v=validateRequired();
    if(!v.ok){ toast("–ó–∞–ø–æ–ª–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n- " + v.missing.join("\n- "), 3200); return; }
    const text=buildTextReport();
    finalEl.textContent=text;
    try{ await navigator.clipboard.writeText(text); toast("‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); }
    catch(_){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –í—ã–¥–µ–ª–∏ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.", 3200); }
  });

  $("btnRefresh").addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    finalEl.textContent=buildTextReport();
    toast("–û—Ç—á—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω");
  });

  $("btnShort").addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    const v=validateRequired();
    if(!v.ok){ toast("–ó–∞–ø–æ–ª–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n- " + v.missing.join("\n- "), 3200); return; }
    toast(shortSummary(), 4200);
  });

  btnFront.addEventListener("pointerdown",(e)=>{ e.preventDefault(); setView("front"); });
  btnBack.addEventListener("pointerdown",(e)=>{ e.preventDefault(); setView("back"); });

  $("btnAddZone").addEventListener("pointerdown",(e)=>{ e.preventDefault(); addZoneFromInput(); });
  zoneNumEl.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); addZoneFromInput(); } });

  /* ===== TELEGRAM (deep-link + fallback, –±–µ–∑ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç) ===== */
  btnTG.addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    const v=validateRequired();
    if(!v.ok){ toast("–ó–∞–ø–æ–ª–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n- " + v.missing.join("\n- "), 3200); return; }

    const text = buildTextReport() + "\n\n" + shortSummary();
    const tgApp = "tg://msg_url?url=&text=" + encodeURIComponent(text);
    const tgWeb = "https://t.me/share/url?url=&text=" + encodeURIComponent(text);

    const a=document.createElement("a");
    a.href=tgApp;
    a.style.display="none";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    setTimeout(()=>{ try{ window.open(tgWeb, "_blank"); }catch(_){ } }, 700);
    toast("–û—Ç–∫—Ä—ã–≤–∞—é Telegram‚Ä¶", 1800);
  });

  /* ===== PDF (2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –±–µ–∑ –ø–∞—Ä–æ–ª—è, —Ä—É—Å—Å–∫–∏–π –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞) ===== */
  function mkFileName(){
    const dt=(dtEl.value||"").trim();
    const call=(callEl.value||"").trim();
    const nice = dt ? dt.replace("T","_").replace(/:/g,"-") : "no-date";
    const pref = call ? call.trim().slice(0,2).toUpperCase().replace(/[^A-Z–ê-–Ø0-9]/g,"") : "XX";
    return `${nice}_${pref}.pdf`;
  }

  function loadImage(url){
    return new Promise((resolve,reject)=>{
      const img=new Image();
      img.crossOrigin="anonymous";
      img.onload=()=>resolve(img);
      img.onerror=()=>reject(new Error("–ù–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –∫–∞—Ä—Ç–∏–Ω–∫–∞: " + url));
      img.src = url + (url.indexOf("?")>=0?"&":"?") + "v=" + Date.now();
    });
  }

  function drawCirclePin(ctx, cx, cy, num, fillRGBA){
    const r = 18;
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.fillStyle = fillRGBA;
    ctx.fill();
    ctx.lineWidth = 4;
    ctx.strokeStyle = "rgba(255,255,255,0.95)";
    ctx.stroke();

    ctx.fillStyle = "#111";
    ctx.font = "bold 18px Arial";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(String(num), cx, cy+1);
    ctx.restore();
  }

  function drawImageWithSelectedPins(baseImg, side){
    const points=loadPoints();
    const map = side==="front" ? points.front : points.back;
    const sel = loadSel(side);

    const c=document.createElement("canvas");
    c.width = baseImg.naturalWidth || baseImg.width;
    c.height= baseImg.naturalHeight || baseImg.height;
    const ctx=c.getContext("2d");

    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,c.width,c.height);
    ctx.drawImage(baseImg,0,0,c.width,c.height);

    const fill = "rgba(255, 200, 0, 0.98)"; // –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –Ω–∞ PDF —Ç–æ–∂–µ –∂–µ–ª—Ç—ã–º

    for(let i=0;i<sel.length;i++){
      const k=sel[i];
      const p=map[k];
      if(!p) continue;
      const cx = (p.x/100)*c.width;
      const cy = (p.y/100)*c.height;
      drawCirclePin(ctx, cx, cy, k, fill);
    }
    return c;
  }

  function wrapTextCanvas(ctx, text, x, y, maxWidth, lineHeight){
    const words = (text||"").split(/\s+/g);
    let line="";
    for(let i=0;i<words.length;i++){
      const test = line ? (line + " " + words[i]) : words[i];
      const w = ctx.measureText(test).width;
      if(w > maxWidth && line){
        ctx.fillText(line, x, y);
        y += lineHeight;
        line = words[i];
      }else{
        line = test;
      }
    }
    if(line){ ctx.fillText(line, x, y); y += lineHeight; }
    return y;
  }

  function buildPdfLines(){
    const dt=(dtEl.value||"").trim();
    const call=(callEl.value||"").trim();
    const comment=(commentEl.value||"").trim();

    const selFront=loadSel("front").sort((a,b)=>parseInt(a,10)-parseInt(b,10));
    const selBack=loadSel("back").sort((a,b)=>parseInt(a,10)-parseInt(b,10));
    const mf=loadMeta("front");
    const mb=loadMeta("back");

    const lines=[];
    lines.push(`–î–∞—Ç–∞/–≤—Ä–µ–º—è: ${dt||"-"}`);
    lines.push(`–ü–æ–∑—ã–≤–Ω–æ–π: ${call||"-"}`);
    lines.push("");

    function addSide(side, sel, meta){
      const dict=dictFor(side);
      lines.push(side==="front" ? "–ü–ï–†–ï–î:" : "–°–ü–ò–ù–ê:");
      if(!sel.length){ lines.push("‚Äî (–Ω–µ—Ç)"); lines.push(""); return; }

      for(const num of sel){
        const name=dict[parseInt(num,10)] || "–ù–ï–ò–ó–í–ï–°–¢–ù–û";
        const m=meta[num] || {};
        const abbr=traumaAbbrList(m);
        const spl=!!m.splint;
        const grp=limbGroupByName(name);

        let where = grp;
        if(needsLR(name)){
          const lr=(m.lr==="R") ? "–ø—Ä–∞–≤–∞—è" : "–ª–µ–≤–∞—è";
          if(grp==="–í–ö" || grp==="–ù–ö") where = `${lr} ${grp}`;
          else where = `${lr} —Å—Ç–æ—Ä–æ–Ω–∞`;
        }

        const lead = abbr.length ? abbr.join(", ") : "–±–µ–∑ —É—Ç–æ—á–Ω—ë–Ω–Ω—ã—Ö —Ç—Ä–∞–≤–º";
        let line = `‚Äî ${lead}: ${where}; ‚Ññ${num} ${name}`;
        if(spl) line += " (—à–∏–Ω–∞)";
        lines.push(line);
      }
      lines.push("");
    }

    addSide("front", selFront, mf);
    addSide("back", selBack, mb);

    lines.push("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:");
    lines.push(comment || "-");
    lines.push("");
    lines.push(shortSummary());

    return lines;
  }

  function makeA4PageCanvas(title, imgCanvas, lines){
    const page=document.createElement("canvas");
    page.width=1240;
    page.height=1754;
    const ctx=page.getContext("2d");

    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,page.width,page.height);

    ctx.fillStyle="#111";
    ctx.font="bold 34px Arial";
    ctx.fillText(title, 60, 70);

    const imgX=140, imgY=110, imgW=960, imgH=960;
    ctx.drawImage(imgCanvas, imgX, imgY, imgW, imgH);

    ctx.font="22px Arial";
    ctx.fillStyle="#111";

    let y = imgY + imgH + 55;
    const x = 60;
    const maxW = page.width - 120;
    const lh = 28;

    for(const line of lines){
      if(y > page.height - 60) break;
      if(line===""){ y += Math.round(lh*0.35); continue; }
      y = wrapTextCanvas(ctx, line, x, y, maxW, lh);
    }

    return page;
  }

  async function makePDF(){
    const v=validateRequired();
    if(!v.ok){ toast("–ó–∞–ø–æ–ª–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n- " + v.missing.join("\n- "), 3200); return; }
    if(pdfBusy) return;

    pdfBusy=true;
    btnMakePDF.disabled=true;
    try{
      toast("–ì–æ—Ç–æ–≤–ª—é PDF‚Ä¶", 1800);

      const baseFront = await loadImage("body_front.png");
      const baseBack  = await loadImage("body_back.png");

      const frontPins = drawImageWithSelectedPins(baseFront, "front");
      const backPins  = drawImageWithSelectedPins(baseBack, "back");

      const lines = buildPdfLines();

      const page1 = makeA4PageCanvas("–ö–ê–†–¢–ê –†–ê–ù–ï–ù–ò–ô ‚Äî –ü–ï–†–ï–î", frontPins, lines);
      const page2 = makeA4PageCanvas("–ö–ê–†–¢–ê –†–ê–ù–ï–ù–ò–ô ‚Äî –°–ü–ò–ù–ê", backPins, lines);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:"p", unit:"mm", format:"a4"});

      const img1 = page1.toDataURL("image/jpeg", 0.92);
      doc.addImage(img1, "JPEG", 0, 0, 210, 297);

      doc.addPage();
      const img2 = page2.toDataURL("image/jpeg", 0.92);
      doc.addImage(img2, "JPEG", 0, 0, 210, 297);

      doc.save(mkFileName());
      toast("‚úÖ PDF –≥–æ—Ç–æ–≤");
    }catch(err){
      setTopBad("PDF –û–®–ò–ë–ö–ê:\n" + (err && err.message ? err.message : String(err)));
      toast("–û—à–∏–±–∫–∞ PDF (—Å–º. —Å–≤–µ—Ä—Ö—É)", 3200);
    }finally{
      pdfBusy=false;
      btnMakePDF.disabled=false;
    }
  }

  btnMakePDF.addEventListener("pointerdown",(e)=>{ e.preventDefault(); makePDF(); });

  /* ===== INIT ===== */
  function init(){
    // –∞–≤—Ç–æ-–≤—Ä–µ–º—è –µ—Å–ª–∏ –ø—É—Å—Ç–æ
    if(!dtEl.value){
      const d=new Date();
      const pad=(n)=>String(n).padStart(2,"0");
      dtEl.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    setView("front");
    finalEl.textContent=buildTextReport();
  }

  init();
})();
  document.getElementById("btnHelp").addEventListener("pointerdown",(e)=>{
  e.preventDefault();
  window.location.href = "help.html";
});
  <!-- –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–≤–æ—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–¥ –ø–∞–Ω–µ–ª—å—é –¥–µ–π—Å—Ç–≤–∏–π –∏–ª–∏ –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã) -->

<div style="text-align: center; margin-top: 20px;">
  <a href="med_inventory.html">
    <button style="padding: 12px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">
      –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–æ–≤
    </button>
  </a>
</div>
</script>
</body>
</html>
```Ó®Å0Ó®Ç
