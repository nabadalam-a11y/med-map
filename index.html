<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Мед-карта (PDF всегда с паролем)</title>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body{ margin:0; font-family: Arial, sans-serif; background:#fff; color:#111; }
    .title{ padding:10px; text-align:center; font-weight:700; font-size:18px; }
    .tabs{ display:flex; }
    .btn{ width:100%; padding:14px; font-size:17px; border:none; background:#222; color:#fff; }
    .btn:active{ opacity:.85; }
    .btn2{
      width:100%;
      padding:12px;
      font-size:16px;
      border:1px solid #222;
      background:#fff;
      color:#222;
      border-radius:10px;
      margin-top:10px;
    }
    .btn2:active{ opacity:.85; }

    .wrap{ position:relative; width:100%; }
    .map{ width:100%; display:block; user-select:none; -webkit-user-drag:none; }

    .panel{ padding:12px; border-top:1px solid #ddd; background:#fafafa; }
    .row{ display:flex; gap:10px; }
    .col{ width:100%; }
    label{ display:block; font-size:13px; color:#444; margin:10px 0 6px; }
    input, textarea{
      width:100%; box-sizing:border-box;
      padding:10px; font-size:15px;
      border:1px solid #ccc; border-radius:10px; background:#fff;
    }
    textarea{ min-height:70px; }

    .hint{ font-size:12px; color:#666; margin-top:6px; }
    .out{
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      padding:10px; border:1px solid #ddd; border-radius:10px;
      background:#fff; margin-top:10px;
    }

    .bar{
      display:flex; gap:10px;
      padding:10px 12px; border-top:1px solid #ddd; background:#fafafa;
      position:sticky; bottom:0;
    }
    .bar .btn{ padding:14px 10px; }

    /* метки */
    .pin{
      position:absolute; transform: translate(-50%,-50%);
      min-width:26px; height:26px; padding:0 6px;
      border-radius:999px;
      background: rgba(255,0,0,0.88);
      color:#fff; font-weight:800; font-size:13px;
      display:flex; align-items:center; justify-content:center;
      z-index:20;
      border:2px solid rgba(255,255,255,0.95);
      box-shadow:0 1px 6px rgba(0,0,0,0.18);
      pointer-events:auto; cursor:pointer; user-select:none;
    }
    .pin.selected{ background: rgba(0,120,255,0.88); }

    .err{
      display:none;
      padding:10px 12px;
      background:#fff3f3;
      border-top:1px solid #f1b5b5;
      color:#8a1f1f;
      font-size:13px;
      white-space:pre-wrap;
    }

    /* обязательные поля подсветка */
    .reqBad{
      border-color:#d11 !important;
      box-shadow:0 0 0 3px rgba(209,17,17,0.15);
    }

    /* карточки зон */
    .zoneCard{
      background:#fff; border:1px solid #ddd; border-radius:12px;
      padding:10px; margin-top:10px;
    }
    .zoneHead{
      display:flex; justify-content:space-between; gap:10px;
      align-items:flex-start; font-size:14px; font-weight:700;
    }
    .zoneSub{ margin-top:4px; font-size:12px; color:#444; font-weight:400; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .chk{
      display:flex; align-items:center; gap:10px;
      padding:10px; border:1px solid #eee; border-radius:12px;
      background:#fafafa; font-size:14px; user-select:none;
    }
    .chk input{ width:22px; height:22px; margin:0; }
    .miniBtn{
      border:1px solid #222; background:#fff; color:#222;
      border-radius:10px; padding:6px 10px; font-size:13px; min-width:88px;
    }
    .miniBtn:active{ opacity:.85; }

    .statusLine{
      margin-top:10px;
      font-size:13px;
      color:#0b6623;
      font-weight:700;
      display:none;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="title">КАРТА РАНЕНИЙ</div>

  <div class="tabs">
    <button class="btn" id="btnFront">ПЕРЕД</button>
    <button class="btn" id="btnBack">СПИНА</button>
  </div>

  <div class="wrap">
    <img id="bodyImage" class="map" src="body_front.png" alt="body">
    <div id="pinsLayer"></div>
  </div>

  <div class="err" id="errBox"></div>

  <div class="panel">
    <div class="row">
      <div class="col">
        <label>Дата/время (обязательно)</label>
        <input id="dt" type="datetime-local"/>
        <div class="hint">Заполни вручную. Без даты/времени PDF не сформируется.</div>
      </div>
      <div class="col">
        <label>Позывной (обязательно, он же пароль PDF)</label>
        <input id="call" placeholder="например: БАРС-12"/>
        <div class="hint">PDF всегда с паролем = позывной (точно как введён).</div>
      </div>
    </div>

    <label>Комментарий (обязательно)</label>
    <textarea id="comment" placeholder="кратко: турникет/кровотечение/состояние..."></textarea>

    <div class="hint" style="margin-top:10px;">
      Тап по метке = выбор зоны. Для каждой зоны появятся травмы (по логике зоны) + “шина” только для конечностей.
    </div>

    <div id="zonesUI"></div>

    <button class="btn2" id="btnRefresh">ОБНОВИТЬ ТЕКСТ ОТЧЁТА</button>
    <button class="btn2" id="btnCopy">КОПИРОВАТЬ ТЕКСТ (в чат)</button>

    <div class="out" id="finalMsg">Здесь будет итоговое сообщение…</div>
    <div class="statusLine" id="statusLine"></div>
  </div>

  <div class="bar">
    <button class="btn" id="btnMakePDF" style="background:#0b6623;">СДЕЛАТЬ PDF (С ПАРОЛЕМ)</button>
  </div>

<script type="module">
  import createQpdfModule from "https://esm.sh/@neslinesli93/qpdf-wasm@0.3.0";
  const QPDF_WASM_URL = "https://cdn.jsdelivr.net/npm/@neslinesli93/qpdf-wasm@0.3.0/dist/qpdf.wasm";
  let qpdfPromise = null;

  const $ = (id)=> document.getElementById(id);
  const errBox = $("errBox");
  const statusLine = $("statusLine");

  function showErr(msg){ errBox.style.display="block"; errBox.textContent=msg; }
  function setStatus(msg){ statusLine.style.display="block"; statusLine.textContent=msg; }
  function clearStatus(){ statusLine.style.display="none"; statusLine.textContent=""; }

  window.addEventListener("error", (e)=> {
    showErr("Ошибка JS:\n" + (e?.message||e) + "\n" + (e?.filename||"") + ":" + (e?.lineno||""));
  });

  // ===== словари зон =====
  const BACK = {
    1:"Подошва",2:"Тыльная область стопы",3:"Передняя область голени",4:"Задняя область голени",
    5:"Задняя область колена",6:"Заднепроходная область",7:"Задняя область бедра",8:"Крестцовая область",
    9:"Ягодичная область",10:"Боковая область живота",11:"Поясничная область",12:"Позвоночная область",
    13:"Подлопаточная область",14:"Задняя локтевая область",15:"Задняя область плеча",16:"Задняя область предплечья",
    17:"Передняя область плеча",18:"Тыл кисти",19:"Надлопаточная область",20:"Задняя область шеи",
    21:"Затылочная область",22:"Скуловая область",23:"Теменная область",24:"Височная область",
    25:"Лобная область",26:"Глазница",27:"Щёчная область",28:"Поднижнечелюстной треугольник",
    29:"Грудино-ключично-сосцевидная область",30:"Акромиальная область",31:"Межлопаточная область",
    32:"Дельтовидная область",33:"Лопаточная область",34:"Задняя область плеча",35:"Латеральная область груди",
    36:"Задняя локтевая область",37:"Задняя область предплечья",38:"Передняя область предплечья",
    39:"Кисть, ладонь",40:"Подрёберная область",41:"Пяточная область"
  };
  const FRONT = {
    1:"Пупочная область",2:"Подчревная (лобковая) область",3:"Передняя область предплечья",4:"Тыл кисти",
    5:"Предплечье",6:"Задняя область предплечья",7:"Задняя локтевая область",8:"Передняя область плеча",
    9:"Грудная область",10:"Дельтовидная область",11:"Ключично-грудной треугольник",
    12:"Грудино-ключично-сосцевидная область",13:"Область рта",14:"Область носа",
    15:"Височная область",16:"Глазница",17:"Лобная область",18:"Теменная область",
    19:"Передняя область шеи",20:"Подбородочная область",21:"Латеральная область шеи",22:"Область ключицы",
    23:"Подключичная ямка",24:"Ладонь",25:"Передняя локтевая область",26:"Задняя область плеча",
    27:"Подмышечная область",28:"Грудная область",29:"Подрёберная область",30:"Надчревная область",
    31:"Боковая область живота",32:"Паховая область",33:"Бедренный треугольник",34:"Передняя область бедра",
    35:"Передняя область колена",36:"Задняя область голени",37:"Передняя область голени",
    38:"Передняя голеностопная область",39:"Пяточная область",40:"Тыльная область стопы"
  };

  // ===== storage keys =====
  const POINTS_KEY = "medmap_points_v2";
  const SEL_FRONT  = "medmap_sel_front_v2";
  const SEL_BACK   = "medmap_sel_back_v2";
  const TRAUMA_FRONT = "medmap_trauma_front_v1";
  const TRAUMA_BACK  = "medmap_trauma_back_v1";

  // ===== DOM =====
  const bodyImage = $("bodyImage");
  const pinsLayer = $("pinsLayer");
  const dtEl = $("dt");
  const callEl = $("call");
  const commentEl = $("comment");
  const zonesUI = $("zonesUI");
  const finalEl = $("finalMsg");

  // ===== state =====
  let view = "front";

  function loadJSON(key, fallback){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
    catch{ return fallback; }
  }
  function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  function loadPoints(){
    const p = loadJSON(POINTS_KEY, {front:{}, back:{}});
    if(!p.front) p.front = {};
    if(!p.back) p.back = {};
    return p;
  }

  function loadSel(side){
    const key = side==="front" ? SEL_FRONT : SEL_BACK;
    const arr = loadJSON(key, []);
    return Array.isArray(arr) ? arr.map(String) : [];
  }
  function saveSel(side, arr){
    const key = side==="front" ? SEL_FRONT : SEL_BACK;
    saveJSON(key, arr);
  }

  function loadTrauma(side){
    const key = side==="front" ? TRAUMA_FRONT : TRAUMA_BACK;
    const obj = loadJSON(key, {});
    return (obj && typeof obj==="object") ? obj : {};
  }
  function saveTrauma(side, obj){
    const key = side==="front" ? TRAUMA_FRONT : TRAUMA_BACK;
    saveJSON(key, obj);
  }

  function dictFor(side){ return side==="front" ? FRONT : BACK; }

  function uniqNums(arr){
    const seen = new Set();
    const out = [];
    for(const x of arr){
      const n = parseInt(x,10);
      if(Number.isFinite(n) && !seen.has(n)){
        seen.add(n);
        out.push(String(n));
      }
    }
    return out;
  }

  // ===== обязательные поля =====
  function markReq(el, ok){
    if(ok) el.classList.remove("reqBad");
    else el.classList.add("reqBad");
  }

  function validateRequired(){
    // обязательные: дата/время, позывной, комментарий
    const dt = (dtEl.value||"").trim();
    const call = (callEl.value||"").trim();
    const comment = (commentEl.value||"").trim();

    const okDt = !!dt;
    const okCall = !!call;
    const okComment = !!comment;

    markReq(dtEl, okDt);
    markReq(callEl, okCall);
    markReq(commentEl, okComment);

    const missing = [];
    if(!okDt) missing.push("Дата/время");
    if(!okCall) missing.push("Позывной");
    if(!okComment) missing.push("Комментарий");

    return { ok: okDt && okCall && okComment, missing };
  }

  // ===== логика чекбоксов =====
  const TRAUMAS = [
    { key:"bullet",   label:"Пулевое" },
    { key:"shrapnel", label:"Осколочное" },
    { key:"mvt",      label:"МВТ" },
    { key:"burn",     label:"Ожог" },
    { key:"fracture", label:"Перелом" },
  ];

  function zoneClassByName(name){
    const s = (name||"").toLowerCase();
    const head = ["лоб","височ","теменн","затыл","скул","глазниц","щёч","нос","рот","подбород"];
    if(head.some(k=>s.includes(k))) return "head";
    if(s.includes("шеи") || s.includes("грудино-ключично-сосцевид") || s.includes("поднижнечелюст")) return "neck";
    const upper = ["плеч","предплеч","локт","кист","ладон","дельтов","акроми","подмыш"];
    if(upper.some(k=>s.includes(k))) return "limb_upper";
    const lower = ["бедр","колен","голен","стоп","пят","подошв","голеностоп"];
    if(lower.some(k=>s.includes(k))) return "limb_lower";
    return "trunk";
  }

  function allowedForClass(cls){
    if(cls==="limb_upper" || cls==="limb_lower"){
      return { bullet:true, shrapnel:true, mvt:true, burn:true, fracture:true, splint:true };
    }
    if(cls==="head" || cls==="neck"){
      return { bullet:true, shrapnel:true, mvt:true, burn:true, fracture:false, splint:false };
    }
    return { bullet:true, shrapnel:true, mvt:true, burn:true, fracture:false, splint:false };
  }

  function traumaSummary(obj){
    const out = [];
    if(obj?.bullet) out.push("пулевое");
    if(obj?.shrapnel) out.push("осколочное");
    if(obj?.mvt) out.push("МВТ");
    if(obj?.burn) out.push("ожог");
    if(obj?.fracture) out.push("перелом");
    return out;
  }

  // ===== pins =====
  function clearPins(){ pinsLayer.innerHTML = ""; }

  function addPin(num, x, y, selected){
    const pin = document.createElement("div");
    pin.className = "pin" + (selected ? " selected" : "");
    pin.style.left = x + "%";
    pin.style.top  = y + "%";
    pin.textContent = String(num);
    pin.addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      toggleZone(num);
    });
    pinsLayer.appendChild(pin);
  }

  function renderPins(){
    const points = loadPoints();
    const map = view==="front" ? points.front : points.back;
    const sel = new Set(loadSel(view));
    clearPins();

    for(const k of Array.from(sel)){
      if(map[k]) addPin(k, map[k].x, map[k].y, true);
    }
    for(const k of Object.keys(map)){
      if(!sel.has(k)) addPin(k, map[k].x, map[k].y, false);
    }
  }

  function toggleZone(num){
    const n = String(parseInt(num,10));
    let sel = loadSel(view);
    const idx = sel.indexOf(n);
    if(idx>=0) sel.splice(idx,1);
    else sel.push(n);
    sel = uniqNums(sel);
    saveSel(view, sel);
    renderAll();
  }

  function setTrauma(num, key, val){
    const n = String(parseInt(num,10));
    const t = loadTrauma(view);
    if(!t[n]) t[n] = {};
    t[n][key] = !!val;
    saveTrauma(view, t);
    renderAll(false);
  }

  function renderZonesUI(){
    const sel = loadSel(view).sort((a,b)=>parseInt(a,10)-parseInt(b,10));
    const trauma = loadTrauma(view);
    const dict = dictFor(view);

    zonesUI.innerHTML = "";

    if(sel.length===0){
      const empty = document.createElement("div");
      empty.className="hint";
      empty.textContent="Зоны не выбраны. Тапни по метке на картинке.";
      zonesUI.appendChild(empty);
      return;
    }

    for(const num of sel){
      const name = dict[parseInt(num,10)] || "НЕИЗВЕСТНО";
      const cls = zoneClassByName(name);
      const allow = allowedForClass(cls);
      const cur = trauma[num] || {};

      const card = document.createElement("div");
      card.className="zoneCard";

      const head = document.createElement("div");
      head.className="zoneHead";
      head.innerHTML = `<div>[${num}] ${name}<div class="zoneSub">Сторона: ${view==="front"?"ПЕРЕД":"СПИНА"}</div></div>`;

      const delBtn = document.createElement("button");
      delBtn.className="miniBtn";
      delBtn.textContent="Убрать";
      delBtn.onclick = ()=> toggleZone(num);
      head.appendChild(delBtn);

      card.appendChild(head);

      const grid = document.createElement("div");
      grid.className="grid";

      for(const tr of TRAUMAS){
        if(!allow[tr.key]) continue;
        const wrap = document.createElement("label");
        wrap.className="chk";
        const inp = document.createElement("input");
        inp.type="checkbox";
        inp.checked=!!cur[tr.key];
        inp.onchange=()=> setTrauma(num, tr.key, inp.checked);
        const span=document.createElement("span");
        span.textContent=tr.label;
        wrap.appendChild(inp);
        wrap.appendChild(span);
        grid.appendChild(wrap);
      }

      if(allow.splint){
        const wrap = document.createElement("label");
        wrap.className="chk";
        const inp = document.createElement("input");
        inp.type="checkbox";
        inp.checked=!!cur.splint;
        inp.onchange=()=> setTrauma(num, "splint", inp.checked);
        const span=document.createElement("span");
        span.textContent="Шина наложена";
        wrap.appendChild(inp);
        wrap.appendChild(span);
        grid.appendChild(wrap);
      }

      card.appendChild(grid);
      zonesUI.appendChild(card);
    }
  }

  // ===== текст отчёта =====
  function buildTextReport(){
    const dt = (dtEl.value||"").trim();
    const call = (callEl.value||"").trim();
    const comment = (commentEl.value||"").trim();

    const selFront = loadSel("front").sort((a,b)=>parseInt(a,10)-parseInt(b,10));
    const selBack  = loadSel("back").sort((a,b)=>parseInt(a,10)-parseInt(b,10));
    const tf = loadTrauma("front");
    const tb = loadTrauma("back");

    function linesFor(side, sel, t){
      const dict = dictFor(side);
      if(sel.length===0) return ["(нет)"];
      const out=[];
      for(const num of sel){
        const name = dict[parseInt(num,10)] || "НЕИЗВЕСТНО";
        const ts = traumaSummary(t[num]||{});
        const spl = !!(t[num]?.splint);
        let line = `• ${num} — ${name}`;
        if(ts.length) line += `\n  Травмы: ${ts.join(", ")}`;
        if(spl) line += `\n  Шина: да`;
        out.push(line);
      }
      return out;
    }

    return (
`МЕД ОТЧЁТ
Дата/время: ${dt || "-"}
Позывной: ${call || "-"}

ПЕРЕД:
${linesFor("front", selFront, tf).join("\n")}

СПИНА:
${linesFor("back", selBack, tb).join("\n")}

Комментарий:
${comment || "-"}`
    );
  }

  // ===== имя файла =====
  function firstTwoChars(s){
    if(!s) return "XX";
    return Array.from(s).slice(0,2).join("");
  }
  function fmtBaseName(){
    const dt = (dtEl.value||"").trim(); // YYYY-MM-DDTHH:MM
    const call = (callEl.value||"").trim();
    const [d,t] = (dt || "0000-00-00T0000").split("T");
    const hhmm = (t || "0000").replace(":","");
    const xx = firstTwoChars(call);
    return `MED_${d}_${hhmm}_${xx}`;
  }

  // ===== рендер страницы в PNG =====
  async function loadImage(src){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload=()=>resolve(img);
      img.onerror=reject;
      img.src=src;
    });
  }
  function sideColor(side){ return side==="front" ? "#0078ff" : "#ff0000"; }

  function traumaLineFor(side, num){
    const t = loadTrauma(side)[String(num)] || {};
    const parts=[];
    if(t.bullet) parts.push("Пулевое");
    if(t.shrapnel) parts.push("Осколочное");
    if(t.mvt) parts.push("МВТ");
    if(t.burn) parts.push("Ожог");
    if(t.fracture) parts.push("Перелом");
    return parts.join(", ");
  }

  async function renderPagePNG(side){
    const W=1240, H=1754;
    const canvas=document.createElement("canvas");
    canvas.width=W; canvas.height=H;
    const ctx=canvas.getContext("2d");

    ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);

    const dt = (dtEl.value||"").trim();
    const call = (callEl.value||"").trim();
    const comment = (commentEl.value||"").trim();
    const title = side==="front" ? "ПЕРЕД" : "СПИНА";
    const color = sideColor(side);

    ctx.fillStyle="#111";
    ctx.font="bold 34px Arial";
    ctx.fillText(`МЕД ОТЧЁТ — ${title}`, 60, 70);
    ctx.font="22px Arial";
    ctx.fillText(`Позывной: ${call || "-"}`, 60, 110);
    ctx.fillText(`Дата/время: ${dt || "-"}`, 60, 145);

    const imgSrc = side==="front" ? "body_front.png" : "body_back.png";
    const img = await loadImage(imgSrc);

    const marginX=60, topY=180;
    const imgW=W - marginX*2;
    const imgH=Math.round(img.height*(imgW/img.width));
    const maxImgH=980;
    const drawH=Math.min(imgH, maxImgH);
    const drawW=Math.round(imgW*(drawH/imgH));
    const imgX=Math.round((W - drawW)/2);
    const imgY=topY;

    ctx.drawImage(img, imgX, imgY, drawW, drawH);

    const points = loadPoints();
    const map = side==="front" ? points.front : points.back;
    const sel = loadSel(side);

    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.font="bol
