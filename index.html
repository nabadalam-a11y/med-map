<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Карта ранений</title>

  <!-- jsPDF (PDF будет из картинок, поэтому русский отображается нормально) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body{ margin:0; font-family: Arial, sans-serif; background:#fff; color:#111; }
    .title{ padding:10px; text-align:center; font-weight:800; font-size:18px; }
    .topStatus{ padding:10px 12px; font-size:14px; background:#dff7df; border-bottom:1px solid #a9d9a9; color:#333; white-space:pre-wrap; }
    .topStatus.bad{ background:#ffe1e1; border-bottom:1px solid #f0a6a6; color:#8a1f1f; }

    .tabs{ display:flex; }
    .tab{
      width:100%; padding:14px; font-size:17px; border:none;
      background:#222; color:#fff; touch-action: manipulation;
    }
    .tab.active{ background:#0b6623; }
    .tab:active{ opacity:.85; }

    .wrap{ position:relative; width:100%; }
    .map{ width:100%; display:block; user-select:none; -webkit-user-drag:none; }

    #pinsLayer{
      position:absolute; inset:0; width:100%; height:100%;
      pointer-events:none; z-index:10;
    }

    .pin{
      position:absolute; transform: translate(-50%,-50%);
      min-width:26px; height:26px; padding:0 7px; border-radius:999px;
      color:#fff; font-weight:900; font-size:13px;
      display:flex; align-items:center; justify-content:center;
      z-index:20; border:2px solid rgba(255,255,255,0.95);
      box-shadow:0 1px 8px rgba(0,0,0,0.22);
      pointer-events:auto; cursor:pointer; user-select:none; touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    /* твои цвета */
    .pin.front{ background: rgba(0,120,255,0.90); } /* ПЕРЕД — синий */
    .pin.back{  background: rgba(255,0,0,0.90); }  /* СПИНА — красный */

    /* просил: при тапе должна менять цвет */
    .pin.selected.front{ background: rgba(0,200,120,0.95); } /* выбранное — зелёный */
    .pin.selected.back{  background: rgba(0,200,120,0.95); } /* выбранное — зелёный */
    .pin.selected{ outline:3px solid rgba(255,255,255,0.95); }

    .panel{ padding:12px; border-top:1px solid #ddd; background:#fafafa; }
    label{ display:block; font-size:13px; color:#444; margin:10px 0 6px; }
    input, textarea{
      width:100%; box-sizing:border-box; padding:10px; font-size:15px;
      border:1px solid #ccc; border-radius:10px; background:#fff;
    }
    textarea{ min-height:55px; }
    .row{ display:flex; gap:10px; }
    .col{ width:100%; }

    .btn2{
      width:100%; padding:12px; font-size:16px; border:1px solid #222;
      background:#fff; color:#222; border-radius:10px; margin-top:10px;
      touch-action: manipulation;
    }
    .btn2:active{ opacity:.85; }
    .btn2:disabled{ opacity:.55; }

    .hint{ font-size:12px; color:#666; margin-top:6px; }
    .reqBad{ border-color:#d11 !important; box-shadow:0 0 0 3px rgba(209,17,17,0.15); }

    .zoneCard{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:10px; margin-top:10px; }
    .zoneHead{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; font-size:14px; font-weight:800; }
    .zoneSub{ margin-top:4px; font-size:12px; color:#444; font-weight:400; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .chk{
      display:flex; align-items:center; gap:10px;
      padding:10px; border:1px solid #eee; border-radius:12px;
      background:#fafafa; font-size:14px; user-select:none; touch-action: manipulation;
    }
    .chk input{ width:22px; height:22px; margin:0; }

    .miniBtn{
      border:1px solid #222; background:#fff; color:#222;
      border-radius:10px; padding:6px 10px; font-size:13px; min-width:88px;
      touch-action: manipulation;
    }
    .miniBtn:active{ opacity:.85; }

    .out{
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; padding:10px; border:1px solid #ddd; border-radius:10px;
      background:#fff; margin-top:10px;
    }

    .bar{
      display:flex; gap:10px; padding:10px 12px; border-top:1px solid #ddd;
      background:#fafafa; position:sticky; bottom:0; z-index:30;
    }
    .bar button{
      width:100%; padding:14px; font-size:16px; border:none; border-radius:10px;
      color:#fff; background:#0b6623; touch-action: manipulation;
    }
    .bar button:active{ opacity:.85; }
    .bar button:disabled{ opacity:.55; }

    #toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background:rgba(0,0,0,0.85); color:#fff; padding:10px 12px; border-radius:12px;
      font-size:14px; max-width:92%; z-index:9999; display:none; white-space:pre-wrap;
    }

    .splitBtns{ display:flex; gap:10px; margin-top:10px; }
    .splitBtns button{ width:100%; }

    .smallNote{ font-size:12px; color:#666; margin-top:8px; }
  </style>
</head>

<body>
  <div id="title" class="title">КАРТА РАНЕНИЙ</div>
  <div id="topStatus" class="topStatus">JS: OK (карта готова)</div>

  <div class="tabs">
    <button class="tab" id="btnFront" type="button">ПЕРЕД</button>
    <button class="tab" id="btnBack" type="button">СПИНА</button>
  </div>

  <div class="wrap">
    <img id="bodyImage" class="map" src="body_front.png" alt="body">
    <div id="pinsLayer"></div>
  </div>

  <div class="panel">
    <div class="row">
      <div class="col">
        <label>Дата/время (обязательно)</label>
        <input id="dt" type="datetime-local"/>
      </div>
      <div class="col">
        <label>Позывной (обязательно)</label>
        <input id="call" placeholder="например: БАРС-12"/>
      </div>
    </div>

    <label>Комментарий (обязательно)</label>
    <textarea id="comment" placeholder="кратко..."></textarea>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label>Ввести номер зоны (для текущей стороны)</label>
        <input id="zoneNum" type="number" inputmode="numeric" placeholder="например: 12"/>
        <div class="hint">Нажми “Добавить/убрать” — это переключатель.</div>
      </div>
      <div class="col" style="display:flex;align-items:flex-end;">
        <button class="btn2" id="btnAddZone" type="button" style="margin-top:0;">ДОБАВИТЬ/УБРАТЬ</button>
      </div>
    </div>

    <div class="hint" style="margin-top:10px;">
      Тапай по меткам — они станут зелёными (выбраны).<br/>
      Для зон с двумя сторонами (лопатки/бок живота/лат. грудь) метки будут “33Л/33П” и т.п.
    </div>

    <div id="zonesUI"></div>

    <button class="btn2" id="btnRefresh" type="button">ОБНОВИТЬ ТЕКСТ ОТЧЁТА</button>
    <button class="btn2" id="btnCopy" type="button">КОПИРОВАТЬ ТЕКСТ</button>

    <!-- “Удиви меня”: полезные кнопки -->
    <div class="splitBtns">
      <button class="btn2" id="btnShort" type="button">КОРОТКАЯ СВОДКА</button>
      <button class="btn2" id="btnTG" type="button">ПОДЕЛИТЬСЯ В TELEGRAM</button>
    </div>
    <div class="smallNote">
      “Короткая сводка” делает строку вида: <b>СОР левой ВК; МВТ правой НК…</b> (удобно быстро отправлять/диктовать).
    </div>

    <div class="out" id="finalMsg"></div>
  </div>

  <div class="bar">
    <button id="btnMakePDF" type="button">СДЕЛАТЬ PDF (2 страницы)</button>
  </div>

  <div id="toast"></div>

<script>
(function(){
  const top = document.getElementById("topStatus");
  const toastEl = document.getElementById("toast");

  function setTopBad(msg){ top.className="topStatus bad"; top.textContent=msg; }
  function toast(msg, ms){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>{ toastEl.style.display="none"; }, ms || 2200);
  }

  // ловим ошибки — чтобы не было “тихо сломалось”
  window.addEventListener("error", (e)=>{
    setTopBad("JS ОШИБКА:\n" + (e.message || "unknown") + "\n" + (e.filename||"") + ":" + (e.lineno||""));
  });
  window.addEventListener("unhandledrejection", (e)=>{
    setTopBad("JS PROMISE ОШИБКА:\n" + (e.reason && (e.reason.message || e.reason) || "unknown"));
  });

  const $ = (id)=>document.getElementById(id);

  // ---------- ЗОНЫ ----------
  const BACK = {
    1:"Подошва",2:"Тыльная область стопы",3:"Передняя область голени",4:"Задняя область голени",
    5:"Задняя область колена",6:"Заднепроходная область",7:"Задняя область бедра",8:"Крестцовая область",
    9:"Ягодичная область",10:"Боковая область живота",11:"Поясничная область",12:"Позвоночная область",
    13:"Подлопаточная область",14:"Задняя локтевая область",15:"Задняя область плеча",16:"Задняя область предплечья",
    17:"Передняя область плеча",18:"Тыл кисти",19:"Надлопаточная область",20:"Задняя область шеи",
    21:"Затылочная область",22:"Скуловая область",23:"Теменная область",24:"Височная область",
    25:"Лобная область",26:"Глазница",27:"Щёчная область",28:"Поднижнечелюстной треугольник",
    29:"Грудино-ключично-сосцевидная область",30:"Акромиальная область",31:"Межлопаточная область",
    32:"Дельтовидная область",33:"Лопаточная область",34:"Задняя область плеча",35:"Латеральная область груди",
    36:"Задняя локтевая область",37:"Задняя область предплечья",38:"Передняя область предплечья",
    39:"Кисть, ладонь",40:"Подрёберная область",41:"Пяточная область"
  };
  const FRONT = {
    1:"Пупочная область",2:"Подчревная (лобковая) область",3:"Передняя область предплечья",4:"Тыл кисти",
    5:"Предплечье",6:"Задняя область предплечья",7:"Задняя локтевая область",8:"Передняя область плеча",
    9:"Грудная область",10:"Дельтовидная область",11:"Ключично-грудной треугольник",
    12:"Грудино-ключично-сосцевидная область",13:"Область рта",14:"Область носа",
    15:"Височная область",16:"Глазница",17:"Лобная область",18:"Теменная область",
    19:"Передняя область шеи",20:"Подбородочная область",21:"Латеральная область шеи",22:"Область ключицы",
    23:"Подключичная ямка",24:"Ладонь",25:"Передняя локтевая область",26:"Задняя область плеча",
    27:"Подмышечная область",28:"Грудная область",29:"Подрёберная область",30:"Надчревная область",
    31:"Боковая область живота",32:"Паховая область",33:"Бедренный треугольник",34:"Передняя область бедра",
    35:"Передняя область колена",36:"Задняя область голени",37:"Передняя область голени",
    38:"Передняя голеностопная область",39:"Пяточная область",40:"Тыльная область стопы"
  };

  // зоны, где нужна Л/П (две метки)
  const LR_ZONES = {
    front: new Set([31]),
    back:  new Set([10,33,35])
  };

  function dictFor(side){ return side==="front"?FRONT:BACK; }
  function isLR(side, num){ return LR_ZONES[side] && LR_ZONES[side].has(parseInt(num,10)); }
  function makeKey(num, lr){ // lr "L"/"R" or null
    const n = String(parseInt(num,10));
    return lr ? `${n}|${lr}` : n;
  }
  function splitKey(key){
    const s = String(key);
    const p = s.split("|");
    return { num: p[0], lr: p[1] || null };
  }
  function lrSuffix(lr){ return lr==="L" ? "Л" : (lr==="R" ? "П" : ""); }
  function lrWord(lr){ return lr==="L" ? "левая" : (lr==="R" ? "правая" : ""); }

  // ---------- STORAGE ----------
  // Важно: ключи оставляем теми же, чтобы ТВОИ точки не пропали
  const POINTS_KEY="medmap_points_v2";
  const SEL_FRONT="medmap_sel_front_v2";
  const SEL_BACK="medmap_sel_back_v2";
  const TRAUMA_FRONT="medmap_trauma_front_v2";
  const TRAUMA_BACK="medmap_trauma_back_v2";

  function loadJSON(key, fallback){
    try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):fallback; }catch(_){ return fallback; }
  }
  function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

  // points format:
  // points.front[num] = {x,y} OR {L:{x,y}, R:{x,y}}
  // points.back[num]  = same
  function normalizePoints(p){
    if(!p || typeof p!=="object") p={front:{},back:{}};
    if(!p.front) p.front={};
    if(!p.back) p.back={};

    // миграция старых LR зон: если было {x,y} — сохраняем как R
    ["front","back"].forEach(side=>{
      const map=p[side]||{};
      Object.keys(map).forEach(k=>{
        const v=map[k];
        const n=parseInt(k,10);
        if(!isFinite(n)) return;
        if(isLR(side, n)){
          // если уже L/R — ок
          if(v && typeof v==="object" && (v.L || v.R)) return;
          // если это {x,y}
          if(v && typeof v==="object" && isFinite(v.x) && isFinite(v.y)){
            map[k] = { R:{x:v.x,y:v.y} };
          }
        }
      });
      p[side]=map;
    });

    return p;
  }

  function loadPoints(){
    return normalizePoints(loadJSON(POINTS_KEY,{front:{},back:{}}));
  }
  function savePoints(p){ saveJSON(POINTS_KEY, normalizePoints(p)); }

  function loadSel(side){
    const key = side==="front"?SEL_FRONT:SEL_BACK;
    const arr=loadJSON(key,[]);
    return Array.isArray(arr)?arr.map(String):[];
  }
  function saveSel(side,arr){
    const key = side==="front"?SEL_FRONT:SEL_BACK;
    saveJSON(key,arr);
  }
  function loadTrauma(side){
    const key = side==="front"?TRAUMA_FRONT:TRAUMA_BACK;
    const obj=loadJSON(key,{});
    return (obj && typeof obj==="object")?obj:{};
  }
  function saveTrauma(side,obj){
    const key = side==="front"?TRAUMA_FRONT:TRAUMABACK_DUMMY;
  }

  // маленький фикс: чтобы не было опечаток
  function saveTraumaSafe(side,obj){
    const key = side==="front"?TRAUMA_FRONT:TRAUMA_BACK;
    saveJSON(key,obj);
  }

  function uniqArr(arr){
    const seen=new Set(), out=[];
    for(const s of arr){ const v=String(s); if(!seen.has(v)){ seen.add(v); out.push(v); } }
    return out;
  }

  // ---------- UI refs ----------
  const bodyImage=$("bodyImage");
  const pinsLayer=$("pinsLayer");
  const btnFront=$("btnFront");
  const btnBack=$("btnBack");
  const zoneNumEl=$("zoneNum");
  const zonesUI=$("zonesUI");
  const finalEl=$("finalMsg");
  const dtEl=$("dt");
  const callEl=$("call");
  const commentEl=$("comment");
  const btnMakePDF=$("btnMakePDF");

  let view="front";
  let pdfBusy=false;

  // default datetime: now
  try{
    const d=new Date();
    const pad=(x)=>String(x).padStart(2,"0");
    dtEl.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }catch(_){}

  function markReq(el, ok){ if(ok) el.classList.remove("reqBad"); else el.classList.add("reqBad"); }
  function validateRequired(){
    const dt=(dtEl.value||"").trim();
    const call=(callEl.value||"").trim();
    const comment=(commentEl.value||"").trim();
    const okDt=!!dt, okCall=!!call, okComment=!!comment;
    markReq(dtEl,okDt); markReq(callEl,okCall); markReq(commentEl,okComment);
    const miss=[];
    if(!okDt) miss.push("Дата/время");
    if(!okCall) miss.push("Позывной");
    if(!okComment) miss.push("Комментарий");
    return {ok: okDt&&okCall&&okComment, missing: miss};
  }

  // ---------- TRAUMAS (пулевое убрали) ----------
  const TRAUMAS=[
    {key:"shrapnel", label:"Осколочное", short:"СОР"},  // Слепое осколочное ранение (как ты просил)
    {key:"mvt",      label:"МВТ",       short:"МВТ"},
    {key:"burn",     label:"Ожог",      short:"ОЖ"},
    {key:"fracture", label:"Перелом",   short:"ПРЛ"},
    {key:"splint",   label:"Шина",      short:"ШИНА"}
  ];

  function zoneClassByName(name){
    const s=(name||"").toLowerCase();
    const head=["лоб","височ","теменн","затыл","скул","глазниц","щёч","нос","рот","подбород"];
    for(let i=0;i<head.length;i++) if(s.indexOf(head[i])!==-1) return "head";
    if(s.indexOf("шеи")!==-1 || s.indexOf("грудино-ключично-сосцевид")!==-1 || s.indexOf("поднижнечелюст")!==-1) return "neck";
    const upper=["плеч","предплеч","локт","кист","ладон","дельтов","акроми","подмыш"];
    for(let i=0;i<upper.length;i++) if(s.indexOf(upper[i])!==-1) return "limb_upper";
    const lower=["бедр","колен","голен","стоп","пят","подошв","голеностоп"];
    for(let i=0;i<lower.length;i++) if(s.indexOf(lower[i])!==-1) return "limb_lower";
    return "trunk";
  }
  function allowedForClass(cls){
    // Перелом и Шина только на конечности
    if(cls==="limb_upper" || cls==="limb_lower") return {shrapnel:1,mvt:1,burn:1,fracture:1,splint:1};
    if(cls==="head" || cls==="neck") return {shrapnel:1,mvt:1,burn:1,fracture:0,splint:0};
    return {shrapnel:1,mvt:1,burn:1,fracture:0,splint:0};
  }

  function traumaSummary(obj){
    const out=[];
    if(obj && obj.shrapnel) out.push("осколочное");
    if(obj && obj.mvt) out.push("МВТ");
    if(obj && obj.burn) out.push("ожог");
    if(obj && obj.fracture) out.push("перелом");
    if(obj && obj.splint) out.push("шина");
    return out;
  }

  function clearPins(){ pinsLayer.innerHTML=""; }

  function addPin(pinKey, x, y, selected){
    const { num, lr } = splitKey(pinKey);

    const pin=document.createElement("div");
    pin.className="pin " + (view==="front"?"front":"back") + (selected?" selected":"");
    pin.style.left=x+"%";
    pin.style.top=y+"%";
    pin.textContent = String(num) + (lr ? lrSuffix(lr) : "");

    pin.addEventListener("pointerdown",(e)=>{
      e.preventDefault(); e.stopPropagation();
      toggleZone(pinKey);
    });

    pinsLayer.appendChild(pin);
  }

  function getPointForKey(pointsSideMap, key){
    const { num, lr } = splitKey(key);
    const base = pointsSideMap[num];
    if(!base) return null;

    // если LR зона
    if(isLR(view, num)){
      if(base && typeof base==="object" && (base.L || base.R)){
        const p = lr ? base[lr] : null;
        return p || null;
      }
      return null;
    }

    // обычная зона
    if(base && typeof base==="object" && isFinite(base.x) && isFinite(base.y)) return base;
    return null;
  }

  function enumerateAllPinsForView(pointsSideMap){
    const res=[];
    const dict=dictFor(view);

    Object.keys(pointsSideMap).forEach(num=>{
      const n=parseInt(num,10);
      if(!isFinite(n)) return;
      if(!dict[n]) return;

      const v=pointsSideMap[num];
      if(isLR(view, n)){
        if(v && typeof v==="object" && (v.L || v.R)){
          if(v.L) res.push({ key: makeKey(n,"L"), x:v.L.x, y:v.L.y });
          if(v.R) res.push({ key: makeKey(n,"R"), x:v.R.x, y:v.R.y });
        }
      } else {
        if(v && typeof v==="object" && isFinite(v.x) && isFinite(v.y)){
          res.push({ key: String(n), x:v.x, y:v.y });
        }
      }
    });
    return res;
  }

  function renderPins(){
    const points=loadPoints();
    const map=view==="front"?points.front:points.back;

    const sel=loadSel(view);
    const selSet=new Set(sel);

    clearPins();

    // сначала выбранные
    for(const key of sel){
      const p = getPointForKey(map, key);
      if(p) addPin(key, p.x, p.y, true);
    }
    // потом остальные
    const all = enumerateAllPinsForView(map);
    for(const item of all){
      if(selSet.has(item.key)) continue;
      addPin(item.key, item.x, item.y, false);
    }
  }

  function toggleZone(key){
    let sel=loadSel(view);
    const idx=sel.indexOf(String(key));
    if(idx>=0) sel.splice(idx,1);
    else sel.push(String(key));
    saveSel(view, uniqArr(sel));
    renderAll();
  }

  function setTrauma(zoneKey, key, val){
    const t=loadTrauma(view);
    if(!t[zoneKey]) t[zoneKey]={};
    t[zoneKey][key]=!!val;
    saveTraumaSafe(view,t);
    renderAll(false);
  }

  function renderZonesUI(){
    const sel=loadSel(view).slice().sort((a,b)=>{
      const A=splitKey(a), B=splitKey(b);
      const na=parseInt(A.num,10), nb=parseInt(B.num,10);
      if(na!==nb) return na-nb;
      const la=A.lr||"", lb=B.lr||"";
      return la.localeCompare(lb);
    });

    const trauma=loadTrauma(view);
    const dict=dictFor(view);

    zonesUI.innerHTML="";
    if(sel.length===0){
      const empty=document.createElement("div");
      empty.className="hint";
      empty.textContent="Зоны не выбраны. Тапни по метке или введи номер.";
      zonesUI.appendChild(empty);
      return;
    }

    for(const zoneKey of sel){
      const { num, lr } = splitKey(zoneKey);
      const n=parseInt(num,10);
      const name=dict[n] || "НЕИЗВЕСТНО";
      const cls=zoneClassByName(name);
      const allow=allowedForClass(cls);
      const cur=trauma[zoneKey] || {};

      const card=document.createElement("div");
      card.className="zoneCard";

      const head=document.createElement("div");
      head.className="zoneHead";
      head.innerHTML=
        `<div>[${num}${lr?lrSuffix(lr):""}] ${name}` +
        `<div class="zoneSub">Сторона: ${view==="front"?"ПЕРЕД":"СПИНА"}${lr?(", " + lrWord(lr)):""}</div></div>`;

      const delBtn=document.createElement("button");
      delBtn.className="miniBtn";
      delBtn.type="button";
      delBtn.textContent="Убрать";
      delBtn.addEventListener("pointerdown",(e)=>{ e.preventDefault(); toggleZone(zoneKey); });
      head.appendChild(delBtn);
      card.appendChild(head);

      const grid=document.createElement("div");
      grid.className="grid";

      for(const tr of TRAUMAS){
        if(!allow[tr.key]) continue;

        const wrap=document.createElement("label");
        wrap.className="chk";

        const inp=document.createElement("input");
        inp.type="checkbox";
        inp.checked=!!cur[tr.key];
        inp.addEventListener("change", ()=> setTrauma(zoneKey, tr.key, inp.checked));

        const span=document.createElement("span");
        span.textContent=tr.label;

        wrap.appendChild(inp);
        wrap.appendChild(span);
        grid.appendChild(wrap);
      }

      card.appendChild(grid);
      zonesUI.appendChild(card);
    }
  }

  function buildTextReport(){
    const dt=(dtEl.value||"").trim();
    const call=(callEl.value||"").trim();
    const comment=(commentEl.value||"").trim();

    const selFront=loadSel("front").slice().sort((a,b)=>{
      const A=splitKey(a), B=splitKey(b);
      const na=parseInt(A.num,10), nb=parseInt(B.num,10);
      if(na!==nb) return na-nb;
      return (A.lr||"").localeCompare(B.lr||"");
    });
    const selBack=loadSel("back").slice().sort((a,b)=>{
      const A=splitKey(a), B=splitKey(b);
      const na=parseInt(A.num,10), nb=parseInt(B.num,10);
      if(na!==nb) return na-nb;
      return (A.lr||"").localeCompare(B.lr||"");
    });

    const tf=loadTrauma("front");
    const tb=loadTrauma("back");

    function linesFor(side, sel, t){
      const dict=dictFor(side);
      if(sel.length===0) return ["(нет)"];
      const out=[];
      for(const zoneKey of sel){
        const { num, lr } = splitKey(zoneKey);
        const name=dict[parseInt(num,10)] || "НЕИЗВЕСТНО";
        const ts=traumaSummary(t[zoneKey]||{});

        let line=`• ${num}${lr?lrSuffix(lr):""} — ${name}`;
        if(lr) line += ` (${lrWord(lr)})`;
        if(ts.length) line += `\n  Травмы: ${ts.join(", ")}`;
        out.push(line);
      }
      return out;
    }

    return (
`МЕД ОТЧЁТ
Дата/время: ${dt || "-"}
Позывной: ${call || "-"}

ПЕРЕД:
${linesFor("front", selFront, tf).join("\n")}

СПИНА:
${linesFor("back", selBack, tb).join("\n")}

Комментарий:
${comment || "-"}`
    );
  }

  // “Удиви меня”: короткая сводка (сокращениями + ВК/НК)
  function limbAbbrByName(name){
    const cls=zoneClassByName(name);
    if(cls==="limb_upper") return "ВК";
    if(cls==="limb_lower") return "НК";
    if(cls==="head" || cls==="neck") return "ГОЛ/ШЕЯ";
    return "ТУЛ";
  }
  function shortSummary(){
    const dictF=dictFor("front");
    const dictB=dictFor("back");
    const selF=loadSel("front");
    const selB=loadSel("back");
    const tf=loadTrauma("front");
    const tb=loadTrauma("back");

    function parts(side, sel, dict, t){
      const out=[];
      for(const zoneKey of sel){
        const { num, lr } = splitKey(zoneKey);
        const name=dict[parseInt(num,10)] || "НЕИЗВЕСТНО";
        const limb=limbAbbrByName(name);

        const flags=t[zoneKey]||{};
        const tags=[];
        // приоритет: осколочное / МВТ / ожог / перелом / шина
        if(flags.shrapnel) tags.push("СОР");
        if(flags.mvt) tags.push("МВТ");
        if(flags.burn) tags.push("ОЖ");
        if(flags.fracture) tags.push("ПРЛ");
        if(flags.splint) tags.push("ШИНА");

        if(tags.length===0) tags.push("ЗОНА");

        // пример: "СОР левой ВК"
        if(lr && (limb==="ВК" || limb==="НК")){
          out.push(`${tags.join("+")} ${lrWord(lr)} ${limb}`);
        } else {
          out.push(`${tags.join("+")} ${limb}`);
        }
      }
      return out;
    }

    const a = parts("front", selF, dictF, tf);
    const b = parts("back",  selB, dictB, tb);
    const all = a.concat(b);
    if(all.length===0) return "Сводка: (нет выбранных зон)";
    return "Сводка: " + all.join("; ");
  }

  function renderAll(updateText=true){
    renderPins();
    renderZonesUI();
    if(updateText) finalEl.textContent=buildTextReport();
  }

  function setView(side){
    view=side;
    bodyImage.src=(view==="front") ? "body_front.png" : "body_back.png";
    btnFront.classList.toggle("active", view==="front");
    btnBack.classList.toggle("active", view==="back");
    renderAll();
  }

  // Ввод номера: если LR-зона — спросим Л/П
  function addZoneFromInput(){
    const raw=(zoneNumEl.value||"").trim();
    const n=parseInt(raw,10);
    if(!isFinite(n)){ toast("Введи номер зоны"); return; }

    const dict=dictFor(view);
    if(!dict[n]){ toast(`Нет зоны №${n} для стороны: ${view==="front"?"ПЕРЕД":"СПИНА"}`, 2600); return; }

    if(isLR(view,n)){
      const okLeft = confirm(`Зона ${n} — левая? (OK=левая, Отмена=правая)`);
      const lr = okLeft ? "L" : "R";
      toggleZone(makeKey(n, lr));
    } else {
      toggleZone(String(n));
    }

    zoneNumEl.value="";
  }

  // ---------- BUTTONS ----------
  $("btnCopy").addEventListener("pointerdown", async (e)=>{
    e.preventDefault();
    const v=validateRequired();
    if(!v.ok){ toast("Не заполнены обязательные поля:\n- " + v.missing.join("\n- "), 3200); return; }
    const text=buildTextReport();
    finalEl.textContent=text;
    try{
      await navigator.clipboard.writeText(text);
      toast("✅ Скопировано");
    } catch(_){
      toast("Не удалось скопировать. Выдели текст вручную.", 3200);
    }
  });

  $("btnRefresh").addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    finalEl.textContent=buildTextReport();
    toast("Текст обновлён");
  });

  $("btnShort").addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    const v=validateRequired();
    if(!v.ok){ toast("Заполни обязательные поля:\n- " + v.missing.join("\n- "), 3200); return; }
    const s = shortSummary();
    toast(s, 3800);
  });

  $("btnTG").addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    const v=validateRequired();
    if(!v.ok){ toast("Заполни обязательные поля:\n- " + v.missing.join("\n- "), 3200); return; }
    const text = buildTextReport() + "\n\n" + shortSummary();
    // Telegram share link
    const url = "https://t.me/share/url?text=" + encodeURIComponent(text);
    window.open(url, "_blank");
  });

  btnFront.addEventListener("pointerdown",(e)=>{ e.preventDefault(); setView("front"); });
  btnBack.addEventListener("pointerdown",(e)=>{ e.preventDefault(); setView("back"); });
  $("btnAddZone").addEventListener("pointerdown",(e)=>{ e.preventDefault(); addZoneFromInput(); });

  // ---------- PDF (2 страницы, без пароля, русский как картинка) ----------
  function mkFileName(){
    const dt=(dtEl.value||"").trim();
    const call=(callEl.value||"").trim();
    const nice = dt ? dt.replace("T","_").replace(/:/g,"-") : "no-date";
    const pref = call ? call.trim().slice(0,2).toUpperCase() : "XX";
    return `${nice}_${pref}.pdf`;
  }

  function loadImage(url){
    return new Promise((resolve,reject)=>{
      const img=new Image();
      img.crossOrigin="anonymous";
      img.onload=()=>resolve(img);
      img.onerror=()=>reject(new Error("Не загрузилась картинка: "+url));
      img.src=url + (url.indexOf("?")>=0?"&":"?") + "v=" + Date.now();
    });
  }

  function drawMarker(ctx, x, y, text, kind){
    // kind: "front"/"back"
    const r = 18;
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI*2);

    // базовый цвет
    if(kind==="front") ctx.fillStyle = "rgba(0,120,255,0.90)";
    else ctx.fillStyle = "rgba(255,0,0,0.90)";
    // выбранные мы рисуем зелёным
    // (на PDF выводим выбранные только)
    ctx.fill();

    ctx.lineWidth=3;
    ctx.strokeStyle="rgba(255,255,255,0.98)";
    ctx.stroke();

    ctx.fillStyle="#fff";
    ctx.font="bold 18px Arial";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(text, x, y);
  }

  function canvasWithSelectedPins(baseImg, side){
    // side: "front"/"back"
    const points = loadPoints();
    const map = side==="front" ? points.front : points.back;
    const sel = loadSel(side);
    const c=document.createElement("canvas");
    c.width = baseImg.naturalWidth || baseImg.width;
    c.height = baseImg.naturalHeight || baseImg.height;
    const ctx=c.getContext("2d");
    ctx.drawImage(baseImg,0,0,c.width,c.height);

    // рисуем только выбранные
    for(const key of sel){
      const { num, lr } = splitKey(key);
      const base = map[num];
      let p=null;

      if(isLR(side, num)){
        if(base && (base.L || base.R) && lr && base[lr]) p = base[lr];
      } else {
        if(base && isFinite(base.x) && isFinite(base.y)) p = base;
      }
      if(!p) continue;

      const x = (p.x/100)*c.width;
      const y = (p.y/100)*c.height;
      const label = String(num) + (lr?lrSuffix(lr):"");
      drawMarker(ctx, x, y, label, side);
    }

    return c;
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    const words = (text||"").split(/\s+/).filter(Boolean);
    let line = "";
    for(let i=0;i<words.length;i++){
      const test = line ? (line + " " + words[i]) : words[i];
      const w = ctx.measureText(test).width;
      if(w > maxWidth && line){
        ctx.fillText(line, x, y);
        y += lineHeight;
        line = words[i];
      } else {
        line = test;
      }
    }
    if(line){
      ctx.fillText(line, x, y);
      y += lineHeight;
    }
    return y;
  }

  function makeA4PageCanvas(title, imgCanvas, reportText){
    const page=document.createElement("canvas");
    // A4 portrait in pixels (примерно, чтобы выглядело одинаково)
    page.width = 1240;
    page.height = 1754;
    const ctx=page.getContext("2d");

    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,page.width,page.height);

    ctx.fillStyle="#111";
    ctx.font="bold 34px Arial";
    ctx.textAlign="left";
    ctx.textBaseline="top";
    ctx.fillText(title, 60, 40);

    // картинка
    const imgX=140, imgY=120, imgW=960, imgH=960;
    ctx.drawImage(imgCanvas, imgX, imgY, imgW, imgH);

    // текст отчёта (как картинка)
    ctx.fillStyle="#111";
    ctx.font="20px Arial";
    ctx.textAlign="left";
    ctx.textBaseline="top";

    const boxX=60, boxY=1120, boxW=1120;
    const lines = reportText.split("\n");

    let y=boxY;
    const lineHeight=28;

    // лёгкая рамка
    ctx.strokeStyle="rgba(0,0,0,0.15)";
    ctx.lineWidth=2;
    ctx.strokeRect(boxX-10, boxY-10, boxW+20, 560);

    for(const ln of lines){
      y = wrapText(ctx, ln, boxX, y, boxW, lineHeight);
      if(y > page.height-40) break;
    }

    return page;
  }

  async function makePDF(){
    const v=validateRequired();
    if(!v.ok){
      toast("Не заполнены обязательные поля:\n- " + v.missing.join("\n- "), 3200);
      return;
    }
    if(pdfBusy) return;

    pdfBusy=true;
    btnMakePDF.disabled=true;
    try{
      toast("Готовлю PDF…", 2600);

      const baseFront = await loadImage("body_front.png");
      const baseBack  = await loadImage("body_back.png");

      const frontPins = canvasWithSelectedPins(baseFront, "front");
      const backPins  = canvasWithSelectedPins(baseBack, "back");

      const reportText = buildTextReport() + "\n\n" + shortSummary();

      const page1 = makeA4PageCanvas("КАРТА РАНЕНИЙ — ПЕРЕД", frontPins, reportText);
      const page2 = makeA4PageCanvas("КАРТА РАНЕНИЙ — СПИНА", backPins, reportText);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:"p", unit:"mm", format:"a4"});

      // page1
      const img1 = page1.toDataURL("image/jpeg", 0.92);
      doc.addImage(img1, "JPEG", 0, 0, 210, 297);

      // page2
      doc.addPage();
      const img2 = page2.toDataURL("image/jpeg", 0.92);
      doc.addImage(img2, "JPEG", 0, 0, 210, 297);

      // download + preview
      const fileName = mkFileName();
      doc.save(fileName);

      // preview in new tab
      try{
        const blob = doc.output("blob");
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        setTimeout(()=>URL.revokeObjectURL(url), 15000);
      }catch(_){}

      toast("✅ PDF готов", 2400);
    }catch(err){
      setTopBad("PDF ОШИБКА:\n" + (err && err.message ? err.message : String(err)));
    }finally{
      pdfBusy=false;
      btnMakePDF.disabled=false;
    }
  }

  btnMakePDF.addEventListener("pointerdown",(e)=>{ e.preventDefault(); makePDF(); });

  // ---------- старт ----------
  function setViewInit(){
    btnFront.classList.toggle("active", true);
    btnBack.classList.toggle("active", false);
    renderAll();
  }
  setViewInit();

})();
</script>
</body>
</html>
