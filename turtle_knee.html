<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä: –ß–µ—Ä–µ–ø–∞—à—å—è –ø–æ–≤—è–∑–∫–∞ (–∫–æ–ª–µ–Ω–æ)</title>
  <style>
    :root{
      --bg:#f4f6f8;
      --card:#fff;
      --line:#d9dee6;
      --text:#111;
      --muted:#556;

      --green:#1b5e20;
      --blue:#1976d2;
      --amber:#f9a825;
      --red:#b71c1c;

      --good:#0f7b2c;
      --bad:#7b1212;

      --bandage:#e9e2d3;
      --bandageEdge:#d6cfbf;
      --ink:#111;
    }

    /* –ù–æ—á—å */
    body.night{
      --bg:#0b1220;
      --card:#0f172a;
      --line:#243149;
      --text:#e5e7eb;
      --muted:#aab4c0;

      --bandage:#cfc8bb;
      --bandageEdge:#bfb8aa;
      --ink:#e5e7eb;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(0deg, rgba(0,0,0,.08), rgba(0,0,0,.08)), var(--green);
      color:#fff;padding:12px 14px;
    }
    body.night header{ background:linear-gradient(0deg, rgba(0,0,0,.25), rgba(0,0,0,.25)), #0b3a1f; }
    .t{font-weight:900;text-align:center;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:6px;text-align:center;font-size:12px;opacity:.92;line-height:1.25}

    .wrap{max-width:1020px;margin:0 auto;padding:12px;display:grid;gap:12px}
    @media (min-width: 920px){
      .wrap{grid-template-columns: 1.25fr .75fr; align-items:start;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      padding:12px;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .pill.good{border-color:rgba(15,123,44,.35);background:rgba(15,123,44,.10);color:var(--good)}
    .pill.warn{border-color:rgba(249,168,37,.45);background:rgba(249,168,37,.14);color:#6a4b00}
    body.night .pill.warn{color:#ffd27a}
    .pill.bad{border-color:rgba(183,28,28,.35);background:rgba(183,28,28,.12);color:var(--bad)}

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:none;border-radius:14px;padding:12px 14px;font-weight:900;font-size:15px;
      cursor:pointer;touch-action:manipulation;
      background:#fff;color:var(--text);border:1px solid var(--line);
    }
    button:active{opacity:.86}
    .bBlue{background:var(--blue);border-color:rgba(25,118,210,.25);color:#fff}
    .bGray{background:#515a63;border-color:#515a63;color:#fff}
    .bGreen{background:var(--green);border-color:rgba(27,94,32,.25);color:#fff}
    .bAmber{background:rgba(249,168,37,.14);border-color:rgba(249,168,37,.45);color:#6a4b00}
    body.night .bAmber{color:#ffd27a}
    button:disabled{opacity:.55}

    .hint{margin-top:10px;font-size:13px;color:var(--muted);line-height:1.25}
    .stepTitle{font-size:16px;font-weight:900;margin:0}
    .stepText{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.25}
    .list{margin:10px 0 0 18px;color:var(--muted);font-size:13px;line-height:1.25}
    .list li{margin:6px 0}

    /* –í–ê–ñ–ù–û: –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π —Ö–æ–ª—Å—Ç */
    .canvasWrap{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--line);
      background:var(--card);
      touch-action:none;
    }
    canvas{display:block;width:100%;height:100%}

    .small{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.25}

    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(0,0,0,.85);color:#fff;padding:10px 12px;border-radius:12px;
      font-size:14px;max-width:92%;display:none;z-index:9999;white-space:pre-wrap;
    }
  </style>
</head>
<body>
<header>
  <div class="t">–¢–†–ï–ù–ê–ñ–Å–†: ‚Äú–ß–ï–†–ï–ü–ê–®–¨–Ø‚Äù –ü–û–í–Ø–ó–ö–ê –ù–ê –ö–û–õ–ï–ù–û</div>
  <div class="sub">–õ–µ–Ω—Ç–∞ –±–∏–Ω—Ç–∞ + —à–∞–≥–∏ ‚Äú–ø–æ —Ç—É—Ä–∞–º‚Äù + —ç–∫–∑–∞–º–µ–Ω. –û—Ñ—Ñ–ª–∞–π–Ω.</div>
</header>

<div class="wrap">

  <!-- –ü–æ–ª–µ -->
  <div class="card">
    <div class="row">
      <div class="pill" id="stepPill">–®–∞–≥ 1/5</div>
      <div class="pill warn" id="statusPill">–°–¥–µ–ª–∞–π —Ç—É—Ä –∏ –Ω–∞–∂–º–∏ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù</div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="pill" id="modePill">–†–µ–∂–∏–º: –û–ë–£–ß–ï–ù–ò–ï</div>
      <div class="pill" id="triesPill">–ü–æ–ø—ã—Ç–∫–∏: ‚Äî</div>
      <div class="pill" id="timePill">–í—Ä–µ–º—è: ‚Äî</div>
      <div class="pill" id="bestPill">–õ—É—á—à–µ–µ: ‚Äî</div>
    </div>

    <div class="canvasWrap" style="margin-top:10px;">
      <canvas id="cv"></canvas>
    </div>

    <div class="btns">
      <button id="btnMode" type="button" class="bAmber">–≠–ö–ó–ê–ú–ï–ù: –í–´–ö–õ</button>
      <button id="btnNight" type="button">–ù–û–ß–¨: –í–´–ö–õ</button>
      <button id="btnHint" type="button">–ü–û–î–°–ö–ê–ó–ö–ê: –í–ö–õ</button>
      <button id="btnClear" type="button" class="bGray">–°–¢–ï–†–ï–¢–¨ –•–û–î</button>
      <button id="btnCheck" type="button" class="bBlue">–ü–†–û–í–ï–†–ò–¢–¨</button>
      <button id="btnNext" type="button" class="bGreen" disabled>–î–ê–õ–¨–®–ï</button>
    </div>

    <div class="small">
      –í –æ–±—É—á–µ–Ω–∏–∏ –ø–æ–¥—Å–∫–∞–∑–∫—É –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å. –í —ç–∫–∑–∞–º–µ–Ω–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤—Å–µ–≥–¥–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞, 3 –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ —à–∞–≥, –∏–¥—ë—Ç —Ç–∞–π–º–µ—Ä.
      –õ–∏–Ω–∏—è ‚Äî —ç—Ç–æ ‚Äú–ª–µ–Ω—Ç–∞ –±–∏–Ω—Ç–∞‚Äù, –ø–æ–ø–∞–¥–∞–Ω–∏–µ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è –∑–µ–ª—ë–Ω—ã–º.
    </div>
  </div>

  <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
  <div class="card">
    <h3 class="stepTitle" id="stepTitle">‚Äî</h3>
    <div class="stepText" id="stepText">‚Äî</div>

    <div class="hint" id="stepMeta"><b>–¶–µ–ª—å:</b> —Ñ–∏–∫—Å–∞—Ü–∏—è –Ω–∞ —Å—É—Å—Ç–∞–≤–µ –±–µ–∑ —Å–ø–æ–ª–∑–∞–Ω–∏—è. –¢—É—Ä—ã –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 1/2.</div>

    <div style="margin-top:10px;">
      <b style="font-size:13px;">–ß—Ç–æ —Å—á–∏—Ç–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –Ω–∞ —ç—Ç–æ–º —à–∞–≥–µ</b>
      <ul class="list" id="criteria"></ul>
    </div>

    <div style="margin-top:10px;">
      <b style="font-size:13px;">–ö–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Å–ª–µ (—Ä–µ–∞–ª—å–Ω–æ –≤ –ø–æ–ª–µ)</b>
      <ul class="list">
        <li>–ù–µ –ø–µ—Ä–µ–¥–∞–≤–ª–∏–≤–∞–µ—Ç: –ø–∞–ª—å—Ü—ã —Ç—ë–ø–ª—ã–µ, —Ü–≤–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π.</li>
        <li>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (–µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç–µ).</li>
        <li>–ü–æ–≤—è–∑–∫–∞ –¥–µ—Ä–∂–∏—Ç—Å—è, –Ω–µ —Å–ø–æ–ª–∑–∞–µ—Ç –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏.</li>
      </ul>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  // ----------------------- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã / —Å–æ—Å—Ç–æ—è–Ω–∏–µ -----------------------
  const STORAGE_KEY = "turtle_knee_trainer_v2";
  const BEST_KEY = "turtle_knee_best_v2";

  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  const toastEl = document.getElementById("toast");
  const stepPill = document.getElementById("stepPill");
  const statusPill = document.getElementById("statusPill");
  const modePill = document.getElementById("modePill");
  const triesPill = document.getElementById("triesPill");
  const timePill = document.getElementById("timePill");
  const bestPill = document.getElementById("bestPill");

  const stepTitle = document.getElementById("stepTitle");
  const stepText = document.getElementById("stepText");
  const criteriaEl = document.getElementById("criteria");

  const btnMode = document.getElementById("btnMode");
  const btnNight = document.getElementById("btnNight");
  const btnHint = document.getElementById("btnHint");
  const btnClear = document.getElementById("btnClear");
  const btnCheck = document.getElementById("btnCheck");
  const btnNext = document.getElementById("btnNext");

  function toast(msg, ms=2000){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.style.display="none", ms);
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s%60;
    return `${pad2(m)}:${pad2(r)}`;
  }

  // –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç 900x900
  const V = {w:900, h:900};
  const kneeCenter = {x:450, y:450};
  const kneeR = 135;
  const TOL = 45; // –∫–æ—Ä–∏–¥–æ—Ä

  // ‚Äú–¢—É—Ä—ã‚Äù ‚Äî —Å–∫–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã—Ö —Ö–æ–¥–æ–≤ –Ω—É–∂–Ω–æ –Ω–∞ —à–∞–≥–µ
  // –®–∞–≥ 1: 2 —Ç—É—Ä–∞ –Ω–∏–∂–µ; 3: 1 —Ç—É—Ä –≤—ã—à–µ; 5: 1 —Ç—É—Ä –ø–æ –∫–æ–ª–µ–Ω—É; –¥–∏–∞–≥–æ–Ω–∞–ª–∏ –ø–æ 1 —Ö–æ–¥—É
  const STEPS = [
    { id:1, need:2, kind:"loop",
      title:"–®–∞–≥ 1 ‚Äî 2 —Ñ–∏–∫—Å–∏—Ä—É—é—â–∏—Ö —Ç—É—Ä–∞ –Ω–∏–∂–µ –∫–æ–ª–µ–Ω–∞",
      text:"–°–¥–µ–ª–∞–π –¥–≤–∞ –∫—Ä—É–≥–æ–≤—ã—Ö —Ç—É—Ä–∞ –Ω–∞ –≥–æ–ª–µ–Ω–∏ (–Ω–∏–∂–µ —Å—É—Å—Ç–∞–≤–∞). –ö–∞–∂–¥—ã–π —Ç—É—Ä –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º ‚Äú—Ö–æ–¥–æ–º‚Äù.",
      criteria:[
        "–ö–∞–∂–¥—ã–π —Ç—É—Ä –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–æ–∫—Ä—É–≥ –≥–æ–ª–µ–Ω–∏ –Ω–∏–∂–µ –∫–æ–ª–µ–Ω–∞.",
        "–¢—É—Ä –∑–∞–º–∫–Ω—É—Ç—ã–π (—Å—Ç–∞—Ä—Ç‚âà—Ñ–∏–Ω–∏—à).",
        "–ù–µ –∑–∞–ª–µ–∑–∞–µ—Ç –Ω–∞ —Å—É—Å—Ç–∞–≤."
      ],
      path: circlePolyline(kneeCenter.x, kneeCenter.y+210, 170, 0, Math.PI*2, 120)
    },
    { id:2, need:1, kind:"diagUp",
      title:"–®–∞–≥ 2 ‚Äî –¥–∏–∞–≥–æ–Ω–∞–ª—å –≤–≤–µ—Ä—Ö —á–µ—Ä–µ–∑ —Å—É—Å—Ç–∞–≤",
      text:"–°–¥–µ–ª–∞–π –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–π —Ö–æ–¥ —Å–Ω–∏–∑—É-–≤–≤–µ—Ä—Ö —á–µ—Ä–µ–∑ –æ–±–ª–∞—Å—Ç—å –∫–æ–ª–µ–Ω–∞ (–∫–∞–∫ —ç–ª–µ–º–µ–Ω—Ç ‚Äú–≤–æ—Å—å–º—ë—Ä–∫–∏‚Äù).",
      criteria:[
        "–ü–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –∫–æ–ª–µ–Ω–∞.",
        "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–∑—É-–≤–≤–µ—Ä—Ö.",
        "–î–µ—Ä–∂–∏—Ç—Å—è –≤–æ–∑–ª–µ —Å—É—Å—Ç–∞–≤–∞ (–Ω–µ —É—Ö–æ–¥–∏—Ç –¥–∞–ª–µ–∫–æ)."
      ],
      path: linePolyline(330, 635, 610, 300, 80)
    },
    { id:3, need:1, kind:"loop",
      title:"–®–∞–≥ 3 ‚Äî 1 —Ç—É—Ä –≤—ã—à–µ –∫–æ–ª–µ–Ω–∞ (–Ω–∞ –±–µ–¥—Ä–µ)",
      text:"–°–¥–µ–ª–∞–π –∫—Ä—É–≥–æ–≤–æ–π —Ç—É—Ä –Ω–∞ –±–µ–¥—Ä–µ –≤—ã—à–µ —Å—É—Å—Ç–∞–≤–∞ ‚Äî –∑–∞–∫—Ä–µ–ø–ª—è–µ—à—å –≤–µ—Ä—Ö–Ω—é—é –ø–µ—Ç–ª—é.",
      criteria:[
        "–¢—É—Ä –≤–æ–∫—Ä—É–≥ –±–µ–¥—Ä–∞ –≤—ã—à–µ –∫–æ–ª–µ–Ω–∞.",
        "–ó–∞–º–∫–Ω—É—Ç—ã–π (—Å—Ç–∞—Ä—Ç‚âà—Ñ–∏–Ω–∏—à).",
        "–ù–µ —É—Ö–æ–¥–∏—Ç –Ω–∏–∂–µ –ª–∏–Ω–∏–∏ —Å—É—Å—Ç–∞–≤–∞."
      ],
      path: circlePolyline(kneeCenter.x, kneeCenter.y-210, 175, 0, Math.PI*2, 120)
    },
    { id:4, need:1, kind:"diagDown",
      title:"–®–∞–≥ 4 ‚Äî –¥–∏–∞–≥–æ–Ω–∞–ª—å –≤–Ω–∏–∑ —á–µ—Ä–µ–∑ —Å—É—Å—Ç–∞–≤",
      text:"–í—Ç–æ—Ä–∞—è –¥–∏–∞–≥–æ–Ω–∞–ª—å: —Å–≤–µ—Ä—Ö—É-–≤–Ω–∏–∑ —á–µ—Ä–µ–∑ –∫–æ–ª–µ–Ω–æ, —Ñ–æ—Ä–º–∏—Ä—É—è ‚Äú–≤–æ—Å—å–º—ë—Ä–∫—É‚Äù.",
      criteria:[
        "–ü–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –∫–æ–ª–µ–Ω–∞.",
        "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É-–≤–Ω–∏–∑.",
        "–ü–æ—Ö–æ–∂–∞ –Ω–∞ –∑–µ—Ä–∫–∞–ª—å–Ω—É—é –∫ —à–∞–≥—É 2."
      ],
      path: linePolyline(330, 300, 610, 635, 80)
    },
    { id:5, need:1, kind:"loop",
      title:"–®–∞–≥ 5 ‚Äî –∑–∞–∫—Ä–µ–ø–ª—è—é—â–∏–π —Ç—É—Ä –≤–æ–∫—Ä—É–≥ –∫–æ–ª–µ–Ω–∞",
      text:"–ó–∞–∫—Ä–µ–ø–∏ –ø–æ–≤—è–∑–∫—É –∫—Ä—É–≥–æ–≤—ã–º —Ç—É—Ä–æ–º –≤–æ–∫—Ä—É–≥ –æ–±–ª–∞—Å—Ç–∏ –∫–æ–ª–µ–Ω–∞ (–ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏ —á—É—Ç—å —à–∏—Ä–µ).",
      criteria:[
        "–¢—É—Ä –≤–æ–∫—Ä—É–≥ –∫–æ–ª–µ–Ω–∞.",
        "–ó–∞–º–∫–Ω—É—Ç—ã–π (—Å—Ç–∞—Ä—Ç‚âà—Ñ–∏–Ω–∏—à).",
        "–ó–∞–∫—Ä–µ–ø–ª—è–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –¥–∏–∞–≥–æ–Ω–∞–ª–µ–π."
      ],
      path: circlePolyline(kneeCenter.x, kneeCenter.y, 195, 0, Math.PI*2, 120)
    }
  ];

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  let stepIndex = 0;
  let showHint = true;
  let examMode = false;
  let nightMode = false;

  let drawing = false;
  let rawPts = [];
  let pts = [];            // —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–µ
  let stepDone = 0;        // —Å–∫–æ–ª—å–∫–æ –∑–∞—Å—á–∏—Ç–∞–Ω–æ —Ö–æ–¥–æ–≤ –Ω–∞ —à–∞–≥–µ
  let triesLeft = 3;       // —ç–∫–∑–∞–º–µ–Ω

  let startMs = null;      // —ç–∫–∑–∞–º–µ–Ω —Ç–∞–π–º–µ—Ä

  // ----------------------- –ì–µ–æ–º–µ—Ç—Ä–∏—è -----------------------
  function scale(){
    const rect = cv.getBoundingClientRect();
    // –∫–≤–∞–¥—Ä–∞—Ç, –ø–æ—ç—Ç–æ–º—É –±–∞–∑–∏—Ä—É–µ–º –Ω–∞ width
    const sx = rect.width / V.w;
    const sy = rect.height / V.h;
    return {sx, sy};
  }
  function toCanvas(p){
    const s = scale();
    return {x: p.x * s.sx, y: p.y * s.sy};
  }
  function fromCanvas(x,y){
    const s = scale();
    return {x: x / s.sx, y: y / s.sy};
  }

  function circlePolyline(cx,cy,r,startA,endA,steps=90){
    const pts=[];
    const dir = endA>=startA ? 1 : -1;
    const span = Math.abs(endA-startA);
    for(let i=0;i<=steps;i++){
      const t=i/steps;
      const a = startA + dir*(span*t);
      pts.push({x: cx + Math.cos(a)*r, y: cy + Math.sin(a)*r});
    }
    return pts;
  }
  function linePolyline(x1,y1,x2,y2,steps=40){
    const pts=[];
    for(let i=0;i<=steps;i++){
      const t=i/steps;
      pts.push({x:x1+(x2-x1)*t, y:y1+(y2-y1)*t});
    }
    return pts;
  }

  function distPointToSegment(p,a,b){
    const vx=b.x-a.x, vy=b.y-a.y;
    const wx=p.x-a.x, wy=p.y-a.y;
    const c1=vx*wx+vy*wy;
    if(c1<=0) return Math.hypot(p.x-a.x,p.y-a.y);
    const c2=vx*vx+vy*vy;
    if(c2<=c1) return Math.hypot(p.x-b.x,p.y-b.y);
    const t=c1/c2;
    const px=a.x+t*vx, py=a.y+t*vy;
    return Math.hypot(p.x-px,p.y-py);
  }
  function distPointToPolyline(p, poly){
    let best=Infinity;
    for(let i=0;i<poly.length-1;i++){
      const d=distPointToSegment(p, poly[i], poly[i+1]);
      if(d<best) best=d;
    }
    return best;
  }

  function bboxOf(poly){
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    for(const p of poly){
      if(p.x<minX) minX=p.x;
      if(p.y<minY) minY=p.y;
      if(p.x>maxX) maxX=p.x;
      if(p.y>maxY) maxY=p.y;
    }
    return {minX,minY,maxX,maxY};
  }

  // –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äú–∑–∞–º–∫–Ω—É—Ç–æ—Å—Ç–∏‚Äù —Ç—É—Ä–∞
  function isClosed(poly){
    if(poly.length<12) return false;
    const a=poly[0], b=poly[poly.length-1];
    return Math.hypot(a.x-b.x, a.y-b.y) < 110; // –¥–æ–ø—É—Å–∫
  }

  // –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äú–ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –∫–æ–ª–µ–Ω–æ‚Äù
  function crossesKnee(poly){
    // —Ö–æ—Ç—è –±—ã N —Ç–æ—á–µ–∫ –≤ –∑–æ–Ω–µ —Ä–∞–¥–∏—É—Å–∞ kneeR+tol
    let hit=0;
    const rr = kneeR + 35;
    const rr2 = rr*rr;
    for(const p of poly){
      const dx=p.x-kneeCenter.x, dy=p.y-kneeCenter.y;
      if(dx*dx+dy*dy <= rr2) hit++;
    }
    return hit >= 10;
  }

  // ----------------------- –û—Ü–µ–Ω–∫–∞ —Ö–æ–¥–∞ -----------------------
  function evaluateStroke(step, userPoly){
    if(userPoly.length < 18) return {ok:false, msg:"–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ. –°–¥–µ–ª–∞–π —Ö–æ–¥ –¥–ª–∏–Ω–Ω–µ–µ."};

    // —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ –∫–æ—Ä–∏–¥–æ—Ä—É
    let good=0;
    for(const p of userPoly){
      if(distPointToPolyline(p, step.path) <= TOL) good++;
    }
    const score = good / userPoly.length;

    // –±–∞–∑–æ–≤–∞—è –ø–ª–∞–Ω–∫–∞
    const okScore = score >= 0.62;

    // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ —Ç–∏–ø—É —à–∞–≥–∞
    if(step.kind === "loop"){
      if(!isClosed(userPoly)) return {ok:false, msg:`–¢—É—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–º–∫–Ω—É—Ç—ã–º (—Å—Ç–∞—Ä—Ç‚âà—Ñ–∏–Ω–∏—à).`};
      // –æ–≥—Ä–∞–Ω–∏—á–∏–º ‚Äú–Ω–µ —Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å‚Äù: —Å—Ä–∞–≤–Ω–∏–º bbox –ø–æ Y —Å bbox —ç—Ç–∞–ª–æ–Ω–∞
      const bbU = bboxOf(userPoly);
      const bbR = bboxOf(step.path);
      const centerU = (bbU.minY+bbU.maxY)/2;
      const centerR = (bbR.minY+bbR.maxY)/2;
      if(Math.abs(centerU-centerR) > 120) return {ok:false, msg:"–¢—É—Ä —É—à—ë–ª –Ω–µ —Ç—É–¥–∞ –ø–æ –≤—ã—Å–æ—Ç–µ. –î–µ—Ä–∂–∏—Å—å –±–ª–∏–∂–µ –∫ –∑–æ–Ω–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏."};
      if(!okScore) return {ok:false, msg:`–ü–æ—á—Ç–∏. –¢—è–Ω–∏ –±–ª–∏–∂–µ –∫ –∫–æ—Ä–∏–¥–æ—Ä—É (—Ç–æ—á–Ω–æ—Å—Ç—å ${(score*100).toFixed(0)}%).`};
      return {ok:true, msg:`–ó–∞—á—ë—Ç ‚úÖ (—Ç–æ—á–Ω–æ—Å—Ç—å ${(score*100).toFixed(0)}%)`};
    }

    if(step.kind === "diagUp"){
      if(!crossesKnee(userPoly)) return {ok:false, msg:"–î–∏–∞–≥–æ–Ω–∞–ª—å –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –æ–±–ª–∞—Å—Ç—å –∫–æ–ª–µ–Ω–∞."};
      const dy = userPoly[userPoly.length-1].y - userPoly[0].y;
      if(dy > 30) return {ok:false, msg:"–î–∏–∞–≥–æ–Ω–∞–ª—å –¥–æ–ª–∂–Ω–∞ –∏–¥—Ç–∏ –°–ù–ò–ó–£ –í–í–ï–†–•."};
      if(!okScore) return {ok:false, msg:`–£—à—ë–ª –æ—Ç –∫–æ—Ä–∏–¥–æ—Ä–∞ (—Ç–æ—á–Ω–æ—Å—Ç—å ${(score*100).toFixed(0)}%).`};
      return {ok:true, msg:`–ó–∞—á—ë—Ç ‚úÖ (—Ç–æ—á–Ω–æ—Å—Ç—å ${(score*100).toFixed(0)}%)`};
    }

    if(step.kind === "diagDown"){
      if(!crossesKnee(userPoly)) return {ok:false, msg:"–î–∏–∞–≥–æ–Ω–∞–ª—å –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –æ–±–ª–∞—Å—Ç—å –∫–æ–ª–µ–Ω–∞."};
      const dy = userPoly[userPoly.length-1].y - userPoly[0].y;
      if(dy < -30) return {ok:false, msg:"–î–∏–∞–≥–æ–Ω–∞–ª—å –¥–æ–ª–∂–Ω–∞ –∏–¥—Ç–∏ –°–í–ï–†–•–£ –í–ù–ò–ó."};
      if(!okScore) return {ok:false, msg:`–£—à—ë–ª –æ—Ç –∫–æ—Ä–∏–¥–æ—Ä–∞ (—Ç–æ—á–Ω–æ—Å—Ç—å ${(score*100).toFixed(0)}%).`};
      return {ok:true, msg:`–ó–∞—á—ë—Ç ‚úÖ (—Ç–æ—á–Ω–æ—Å—Ç—å ${(score*100).toFixed(0)}%)`};
    }

    return okScore
      ? {ok:true, msg:`–ó–∞—á—ë—Ç ‚úÖ (—Ç–æ—á–Ω–æ—Å—Ç—å ${(score*100).toFixed(0)}%)`}
      : {ok:false, msg:`–ü–æ—á—Ç–∏. –¢—è–Ω–∏ –±–ª–∏–∂–µ –∫ –ø–æ–¥—Å–∫–∞–∑–∫–µ (—Ç–æ—á–Ω–æ—Å—Ç—å ${(score*100).toFixed(0)}%).`};
  }

  // ----------------------- –†–∏—Å–æ–≤–∞–Ω–∏–µ: ‚Äú–±–∏–Ω—Ç-–ª–µ–Ω—Ç–∞‚Äù -----------------------
  function drawBody(){
    const rect = cv.getBoundingClientRect();
    const w = rect.width, h = rect.height;

    // —Ñ–æ–Ω
    ctx.clearRect(0,0,w,h);

    // –ª–µ–≥–∫–∞—è —Å–µ—Ç–∫–∞ (–≤ –¥–µ–Ω—å)
    if(!nightMode){
      ctx.save();
      ctx.globalAlpha = 0.05;
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 1;
      for(let i=0;i<=900;i+=50){
        const a = toCanvas({x:i,y:0}); const b = toCanvas({x:i,y:900});
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        const c = toCanvas({x:0,y:i}); const d = toCanvas({x:900,y:i});
        ctx.beginPath(); ctx.moveTo(c.x,c.y); ctx.lineTo(d.x,d.y); ctx.stroke();
      }
      ctx.restore();
    }

    // –∫–æ–Ω—Ç—É—Ä –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏
    ctx.save();
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue("--ink").trim() || "#111";
    ctx.globalAlpha = nightMode ? 0.9 : 0.85;
    ctx.lineWidth = 4;

    // –ª–µ–≤–∞—è/–ø—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü—ã
    ctx.beginPath();
    // left
    let p = toCanvas({x:320,y:140});
    ctx.moveTo(p.x,p.y);
    ctx.quadraticCurveTo(...pt(250,320), ...pt(295,420));
    ctx.quadraticCurveTo(...pt(250,520), ...pt(295,760));
    ctx.quadraticCurveTo(...pt(320,840), ...pt(360,860));
    ctx.stroke();

    ctx.beginPath();
    // right
    p = toCanvas({x:580,y:140});
    ctx.moveTo(p.x,p.y);
    ctx.quadraticCurveTo(...pt(650,320), ...pt(605,420));
    ctx.quadraticCurveTo(...pt(650,520), ...pt(605,760));
    ctx.quadraticCurveTo(...pt(580,840), ...pt(540,860));
    ctx.stroke();

    // –∫–æ–ª–µ–Ω–æ
    ctx.save();
    ctx.globalAlpha = nightMode ? 0.85 : 0.65;
    ctx.lineWidth = 5;
    ctx.beginPath();
    const kc = toCanvas(kneeCenter);
    const s = scale().sx;
    ctx.arc(kc.x,kc.y, kneeR*s, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();

    // –ø–æ–¥–ø–∏—Å–∏
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue("--ink").trim() || "#111";
    ctx.globalAlpha = nightMode ? 0.75 : 0.6;
    ctx.font = "bold 16px system-ui, Arial";
    ctx.fillText("–ë–ï–î–†–û", ...txt(390,120));
    ctx.fillText("–ö–û–õ–ï–ù–û", ...txt(382,465));
    ctx.fillText("–ì–û–õ–ï–ù–¨", ...txt(392,835));

    ctx.restore();

    function pt(x,y){ const q=toCanvas({x,y}); return [q.x,q.y]; }
    function txt(x,y){ const q=toCanvas({x,y}); return [q.x,q.y]; }
  }

  function drawHint(step){
    if(examMode) return;
    if(!showHint) return;

    const poly = step.path;
    const s = scale().sx;

    // –∫–æ—Ä–∏–¥–æ—Ä (—à–∏—Ä–æ–∫–∞—è –ª–µ–Ω—Ç–∞)
    ctx.save();
    ctx.globalAlpha = 0.18;
    ctx.lineWidth = (TOL*2) * s;
    ctx.lineCap = "round";
    ctx.strokeStyle = "rgba(249,168,37,0.9)";
    strokePolyline(poly);
    ctx.restore();

    // ‚Äú–∏–¥–µ–∞–ª—å–Ω—ã–π‚Äù –ø—É—Ç—å
    ctx.save();
    ctx.globalAlpha = 0.28;
    ctx.lineWidth = 16 * s;
    ctx.lineCap = "round";
    ctx.strokeStyle = "rgba(25,118,210,0.95)";
    strokePolyline(poly);
    ctx.restore();

    function strokePolyline(p){
      ctx.beginPath();
      const p0 = toCanvas(p[0]);
      ctx.moveTo(p0.x,p0.y);
      for(let i=1;i<p.length;i++){
        const pi = toCanvas(p[i]);
        ctx.lineTo(pi.x,pi.y);
      }
      ctx.stroke();
    }
  }

  // –û—Å–Ω–æ–≤–Ω–∞—è –ª–µ–Ω—Ç–∞ + –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è
  function drawBandage(userPoly, step){
    if(userPoly.length < 2) return;

    const s = scale().sx;
    const w = 28 * s; // —à–∏—Ä–∏–Ω–∞ ‚Äú–ª–µ–Ω—Ç—ã‚Äù
    const edge = 2.5 * s;

    // –Ω–∞—Ä–∏—Å—É–µ–º —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏: –µ—Å–ª–∏ midpoint –≤ –∫–æ—Ä–∏–¥–æ—Ä–µ -> –∑–µ–ª—ë–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
    for(let i=0;i<userPoly.length-1;i++){
      const a = userPoly[i], b = userPoly[i+1];
      const mid = {x:(a.x+b.x)/2, y:(a.y+b.y)/2};
      const d = distPointToPolyline(mid, step.path);
      const ok = d <= TOL;

      const A = toCanvas(a), B = toCanvas(b);

      // 1) –æ—Å–Ω–æ–≤–Ω–∞—è –ª–µ–Ω—Ç–∞
      ctx.save();
      ctx.lineCap = "round";
      ctx.lineWidth = w;
      ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue("--bandage").trim() || "#e9e2d3";
      ctx.globalAlpha = 0.92;
      ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
      ctx.restore();

      // 2) –∫—Ä–∞—è –ª–µ–Ω—Ç—ã
      ctx.save();
      ctx.lineCap = "round";
      ctx.lineWidth = w + edge*2;
      ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue("--bandageEdge").trim() || "#d6cfbf";
      ctx.globalAlpha = 0.18;
      ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
      ctx.restore();

      // 3) ‚Äú—Ç–∫–∞–Ω–µ–≤–∞—è‚Äù —Ç–µ–∫—Å—Ç—É—Ä–∞ (—à—Ç—Ä–∏—Ö–∏)
      ctx.save();
      ctx.lineCap = "round";
      ctx.lineWidth = 1.5 * s;
      ctx.strokeStyle = nightMode ? "rgba(0,0,0,0.18)" : "rgba(0,0,0,0.12)";
      ctx.setLineDash([6*s, 10*s]);
      ctx.globalAlpha = 0.75;
      ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();

      // 4) –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è
      if(ok){
        ctx.save();
        ctx.lineCap="round";
        ctx.lineWidth = w * 0.72;
        ctx.strokeStyle = nightMode ? "rgba(0,255,120,0.25)" : "rgba(15,123,44,0.22)";
        ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
        ctx.restore();
      }else{
        // –ª—ë–≥–∫–∞—è —Ç—ë–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ ‚Äú–º–∏–º–æ‚Äù
        ctx.save();
        ctx.lineCap="round";
        ctx.lineWidth = w * 0.55;
        ctx.strokeStyle = nightMode ? "rgba(255,100,100,0.10)" : "rgba(183,28,28,0.08)";
        ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
        ctx.restore();
      }
    }
  }

  function redraw(){
    // –í–ê–ñ–ù–û: rect.height (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–º–µ—â–µ–Ω–∏—è)
    const rect = cv.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    ctx.clearRect(0,0,w,h);

    const step = STEPS[stepIndex];
    drawBody();
    drawHint(step);
    drawBandage(pts, step);

    // –º–∏–Ω–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —à–∞–≥–∞ (—Å–ª–µ–≤–∞ —Å–≤–µ—Ä—Ö—É –Ω–∞ —Ö–æ–ª—Å—Ç–µ)
    ctx.save();
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = nightMode ? "rgba(255,255,255,0.9)" : "rgba(0,0,0,0.85)";
    ctx.font = "bold 14px system-ui, Arial";
    ctx.fillText(`–•–æ–¥—ã: ${stepDone}/${step.need}`, 14, 22);
    ctx.restore();
  }

  // ----------------------- –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (–ø—Ä–æ—Å—Ç–æ–µ) -----------------------
  function smoothAppend(p){
    // low-pass filter: smoothed = prev*0.7 + new*0.3
    if(pts.length === 0){
      pts.push(p);
      return;
    }
    const prev = pts[pts.length-1];
    const sp = {x: prev.x*0.7 + p.x*0.3, y: prev.y*0.7 + p.y*0.3};
    pts.push(sp);
  }

  // ----------------------- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–∞–ª—å—Ü–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) -----------------------
  function addPointFromEvent(e){
    const rect = cv.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const xx = Math.max(0, Math.min(rect.width, x));
    const yy = Math.max(0, Math.min(rect.height, y)); // –í–ê–ñ–ù–û: height

    const v = fromCanvas(xx, yy);
    rawPts.push(v);
    smoothAppend(v);
  }

  // ----------------------- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–≥–∞–º–∏ / —Ä–µ–∂–∏–º–∞–º–∏ -----------------------
  function setStatus(type, text){
    statusPill.textContent = text;
    statusPill.classList.remove("good","warn","bad");
    statusPill.classList.add(type);
  }

  function updateUI(){
    const s = STEPS[stepIndex];
    stepPill.textContent = `–®–∞–≥ ${s.id}/5`;
    stepTitle.textContent = s.title;
    stepText.textContent = s.text;

    criteriaEl.innerHTML = "";
    for(const c of s.criteria){
      const li = document.createElement("li");
      li.textContent = c;
      criteriaEl.appendChild(li);
    }

    modePill.textContent = `–†–µ–∂–∏–º: ${examMode ? "–≠–ö–ó–ê–ú–ï–ù" : "–û–ë–£–ß–ï–ù–ò–ï"}`;
    triesPill.textContent = examMode ? `–ü–æ–ø—ã—Ç–∫–∏: ${triesLeft}/3` : "–ü–æ–ø—ã—Ç–∫–∏: ‚Äî";

    btnHint.disabled = examMode;
    btnHint.textContent = `–ü–û–î–°–ö–ê–ó–ö–ê: ${(!examMode && showHint) ? "–í–ö–õ" : "–í–´–ö–õ"}`;

    btnMode.textContent = `–≠–ö–ó–ê–ú–ï–ù: ${examMode ? "–í–ö–õ" : "–í–´–ö–õ"}`;
    btnNight.textContent = `–ù–û–ß–¨: ${nightMode ? "–í–ö–õ" : "–í–´–ö–õ"}`;

    btnNext.disabled = !(stepDone >= s.need);
    if(stepDone >= s.need){
      setStatus("good", "–®–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úÖ –ù–∞–∂–º–∏ ‚Äú–î–ê–õ–¨–®–ï‚Äù");
    }else{
      setStatus("warn", "–°–¥–µ–ª–∞–π —Ö–æ–¥ –∏ –Ω–∞–∂–º–∏ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù");
    }

    updateTimeUI();
    updateBestUI();
    redraw();
  }

  function updateTimeUI(){
    if(!examMode || startMs === null){
      timePill.textContent = "–í—Ä–µ–º—è: ‚Äî";
      return;
    }
    timePill.textContent = `–í—Ä–µ–º—è: ${fmtTime(Date.now()-startMs)}`;
  }

  function updateBestUI(){
    const best = loadBest();
    bestPill.textContent = best ? `–õ—É—á—à–µ–µ: ${fmtTime(best)}` : "–õ—É—á—à–µ–µ: ‚Äî";
  }

  function resetStroke(){
    rawPts = [];
    pts = [];
    redraw();
  }

  function resetAll(){
    stepIndex = 0;
    stepDone = 0;
    triesLeft = 3;
    startMs = examMode ? Date.now() : null;
    resetStroke();
    saveState();
    updateUI();
  }

  function stepNext(){
    if(stepIndex < STEPS.length-1){
      stepIndex++;
      stepDone = 0;
      triesLeft = 3;
      resetStroke();
      saveState();
      updateUI();
      toast("–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥");
      return;
    }

    // –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    setStatus("good", "–ì–æ—Ç–æ–≤–æ ‚úÖ –ü–æ–≤—è–∑–∫–∞ —Å–æ–±—Ä–∞–Ω–∞ (—É—á–µ–±–Ω—ã–π —Ç—Ä–µ–Ω–∞–∂—ë—Ä)");
    btnNext.disabled = true;

    if(examMode && startMs !== null){
      const total = Date.now() - startMs;
      const best = loadBest();
      if(!best || total < best){
        saveBest(total);
        toast(`–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ üéØ ${fmtTime(total)}`, 2600);
      }else{
        toast(`–≠–∫–∑–∞–º–µ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ ${fmtTime(total)}`, 2600);
      }
      updateBestUI();
    }else{
      toast("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ", 2400);
    }

    saveState();
  }

  // ----------------------- LocalStorage -----------------------
  function saveState(){
    const st = { stepIndex, stepDone, showHint, examMode, nightMode, triesLeft, startMs };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const st = JSON.parse(raw);
      if(!st || typeof st !== "object") return;
      if(typeof st.stepIndex==="number") stepIndex = Math.max(0, Math.min(STEPS.length-1, st.stepIndex));
      if(typeof st.stepDone==="number") stepDone = Math.max(0, st.stepDone);
      if(typeof st.showHint==="boolean") showHint = st.showHint;
      if(typeof st.examMode==="boolean") examMode = st.examMode;
      if(typeof st.nightMode==="boolean") nightMode = st.nightMode;
      if(typeof st.triesLeft==="number") triesLeft = st.triesLeft;
      if(typeof st.startMs==="number") startMs = st.startMs;
    }catch(_){}
  }
  function saveBest(ms){ localStorage.setItem(BEST_KEY, String(ms)); }
  function loadBest(){
    const v = localStorage.getItem(BEST_KEY);
    const n = v ? parseInt(v,10) : NaN;
    return Number.isFinite(n) ? n : null;
  }

  // ----------------------- Pointer events -----------------------
  cv.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    cv.setPointerCapture(e.pointerId);
    drawing = true;
    resetStroke();
    addPointFromEvent(e);
    redraw();
  });

  cv.addEventListener("pointermove", (e)=>{
    if(!drawing) return;
    e.preventDefault();
    addPointFromEvent(e);
    if(pts.length % 2 === 0) redraw();
  });

  function endDraw(){
    if(!drawing) return;
    drawing = false;
    redraw();
  }
  cv.addEventListener("pointerup", (e)=>{ e.preventDefault(); endDraw(); });
  cv.addEventListener("pointercancel", (e)=>{ e.preventDefault(); endDraw(); });

  // ----------------------- Buttons -----------------------
  btnNight.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    nightMode = !nightMode;
    document.body.classList.toggle("night", nightMode);
    saveState();
    updateUI();
  });

  btnMode.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    examMode = !examMode;

    // —ç–∫–∑–∞–º–µ–Ω: –ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤—Å–µ–≥–¥–∞ –≤—ã–∫–ª
    if(examMode){
      showHint = false;
      triesLeft = 3;
      startMs = Date.now();
      toast("–≠–∫–∑–∞–º–µ–Ω: –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω—ã, 3 –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ —à–∞–≥", 2600);
    }else{
      startMs = null;
      toast("–û–±—É—á–µ–Ω–∏–µ: –º–æ–∂–Ω–æ –ø–æ–¥—Å–∫–∞–∑–∫—É", 1800);
    }
    saveState();
    updateUI();
  });

  btnHint.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    if(examMode) return;
    showHint = !showHint;
    saveState();
    updateUI();
  });

  btnClear.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    resetStroke();
    setStatus("warn","–•–æ–¥ —Å—Ç—ë—Ä—Ç. –ù–∞—Ä–∏—Å—É–π –∑–∞–Ω–æ–≤–æ –∏ –ø—Ä–æ–≤–µ—Ä—å.");
    toast("–•–æ–¥ —Å—Ç—ë—Ä—Ç");
  });

  btnCheck.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    const step = STEPS[stepIndex];

    const r = evaluateStroke(step, pts);

    if(r.ok){
      stepDone++;
      resetStroke();

      if(stepDone >= step.need){
        setStatus("good", `–®–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úÖ (${stepDone}/${step.need})`);
        btnNext.disabled = false;
        toast("–®–∞–≥ –∑–∞–∫—Ä—ã—Ç ‚úÖ", 1800);
      }else{
        setStatus("good", `–ó–∞—á—ë—Ç ‚úÖ –•–æ–¥–æ–≤: ${stepDone}/${step.need}`);
        toast(`–ó–∞—á—ë—Ç ‚úÖ –û—Å—Ç–∞–ª–æ—Å—å: ${step.need-stepDone}`, 1800);
      }
      saveState();
      redraw();
      return;
    }

    // –Ω–µ –æ–∫
    setStatus("bad", r.msg);
    toast(r.msg, 2400);

    if(examMode){
      triesLeft = Math.max(0, triesLeft-1);
      if(triesLeft === 0){
        toast("–ü–æ–ø—ã—Ç–∫–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å. –°–±—Ä–æ—Å —à–∞–≥–∞.", 2600);
        // —Å–±—Ä–æ—Å —à–∞–≥–∞
        stepDone = 0;
        triesLeft = 3;
        resetStroke();
      }else{
        resetStroke();
      }
      saveState();
      updateUI();
    }
  });

  btnNext.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    stepNext();
    saveState();
    updateUI();
  });

  // ----------------------- Canvas sizing -----------------------
  function fitCanvasToCSS(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = cv.getBoundingClientRect();
    const w = Math.round(rect.width * dpr);
    const h = Math.round(rect.height * dpr);
    if(cv.width !== w || cv.height !== h){
      cv.width = w;
      cv.height = h;
    }
    ctx.setTransform(dpr,0,0,dpr,0,0);
    redraw();
  }
  window.addEventListener("resize", ()=>{ fitCanvasToCSS(); });

  // —Ç–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ (–¥–ª—è —ç–∫–∑–∞–º–µ–Ω–∞)
  setInterval(()=>{
    if(examMode) updateTimeUI();
  }, 250);

  // ----------------------- INIT -----------------------
  loadState();
  document.body.classList.toggle("night", nightMode);
  fitCanvasToCSS();
  updateUI();

})();
</script>
</body>
</html>
