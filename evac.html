<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Эвакуация — PRO</title>
  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111;
      --muted:#556;
      --line:#dde2e8;
      --shadow:0 2px 10px rgba(0,0,0,.06);

      --red:#b71c1c;
      --redBg:#ffecec;

      --orange:#ef6c00;
      --orangeBg:#fff2e6;

      --yellow:#b37b00;
      --yellowBg:#fff8de;

      --green:#1b5e20;
      --greenBg:#e9f6ec;

      --blue:#1976d2;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(0deg, rgba(0,0,0,.06), rgba(0,0,0,.06)), var(--green);
      color:#fff;padding:12px 14px;box-shadow:var(--shadow);
    }
    .hTitle{font-weight:900;text-align:center;font-size:18px;letter-spacing:.2px;}
    .hSub{margin-top:6px;text-align:center;font-size:12px;opacity:.92;line-height:1.25}

    .wrap{max-width:980px;margin:0 auto;padding:12px;}
    .topRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}
    .btn{
      border:none;border-radius:14px;padding:12px 14px;font-weight:900;font-size:15px;
      touch-action:manipulation;cursor:pointer;
    }
    .btn:active{opacity:.88}
    .btnBack{background:#fff;border:1px solid rgba(255,255,255,.35); box-shadow:var(--shadow); }
    .btnBackWrap{display:flex;gap:10px;align-items:center}
    .pill{
      border-radius:999px;padding:8px 12px;font-size:12px;font-weight:900;
      border:1px solid var(--line);background:#fff;white-space:nowrap;
    }

    .grid2{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width: 860px){
      .grid2{grid-template-columns: 1.2fr .8fr;}
    }

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:18px;
      padding:14px;box-shadow:var(--shadow);
    }
    .secTitle{font-weight:900;color:#223;margin:0 0 10px 0;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .secHint{font-size:12px;color:var(--muted);line-height:1.25;margin-top:6px}

    /* пункты */
    .item{
      display:block;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
      background:#fff;
      user-select:none;
    }
    .itemRow{display:flex;gap:12px;align-items:flex-start}
    .item input{width:22px;height:22px;margin-top:2px;flex:0 0 auto}
    .itT{font-weight:900;line-height:1.15}
    .itD{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.25}
    .chips{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{font-size:12px;font-weight:900;border-radius:999px;padding:4px 8px;border:1px solid var(--line);background:#f7f9fb;color:#234}
    .chip.crit{border-color:rgba(183,28,28,.35);background:rgba(183,28,28,.10);color:#7b1212}
    .chip.urg{border-color:rgba(239,108,0,.35);background:rgba(239,108,0,.10);color:#8a3b00}
    .chip.plan{border-color:rgba(179,123,0,.35);background:rgba(179,123,0,.12);color:#6a4b00}
    .chip.obs{border-color:rgba(27,94,32,.35);background:rgba(27,94,32,.10);color:#0f4f2b}

    /* результат */
    .resultBox{
      border-radius:18px;border:2px solid rgba(0,0,0,.08);
      padding:14px;margin-top:10px;
    }
    .resultBox.red{background:var(--redBg);border-color:rgba(183,28,28,.35)}
    .resultBox.orange{background:var(--orangeBg);border-color:rgba(239,108,0,.35)}
    .resultBox.yellow{background:var(--yellowBg);border-color:rgba(179,123,0,.35)}
    .resultBox.green{background:var(--greenBg);border-color:rgba(27,94,32,.35)}
    .rTitle{margin:0;font-size:18px;font-weight:900}
    .rSub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.3}
    .split{
      margin-top:10px;border-top:1px dashed var(--line);padding-top:10px;
    }
    ul{margin:8px 0 0 18px;padding:0}
    li{margin:6px 0;line-height:1.25}

    /* таймеры */
    .timerBtns{display:flex;gap:8px;flex-wrap:wrap}
    .btnTiny{
      width:auto;border-radius:12px;padding:10px 12px;font-size:13px;font-weight:900;
      border:1px solid var(--line);background:#fff;color:#111;
    }
    .btnTiny.blue{background:rgba(25,118,210,.10);border-color:rgba(25,118,210,.25);color:#0e4f95}
    .btnTiny.red{background:rgba(183,28,28,.10);border-color:rgba(183,28,28,.25);color:#7b1212}
    .btnTiny.green{background:rgba(27,94,32,.10);border-color:rgba(27,94,32,.25);color:#0f4f2b}
    .btnTiny:active{opacity:.86}

    .timerList{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .tItem{
      border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .tName{font-weight:900}
    .tMeta{margin-top:4px;font-size:12px;color:var(--muted)}
    .tTime{font-weight:900;font-size:14px}
    .tLeft.warn{color:#7b1212}
    .tRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .btnStop{padding:8px 10px;border-radius:12px;border:1px solid rgba(183,28,28,.35);background:rgba(183,28,28,.10);color:#7b1212;font-weight:900;font-size:12px}

    /* журнал */
    .log{
      margin-top:10px;white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      background:#0f172a;color:#e5e7eb;border-radius:14px;padding:12px;font-size:12px;line-height:1.35;
    }

    /* экспорт */
    .actionRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btnWide{flex:1;min-width:170px}
    .btnBlue{background:var(--blue);color:#fff}
    .btnGray{background:#515a63;color:#fff}
    .btnGreen{background:var(--green);color:#fff}

    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(0,0,0,.85);color:#fff;padding:10px 12px;border-radius:12px;
      font-size:14px;max-width:92%;display:none;z-index:9999;white-space:pre-wrap;
    }
  </style>
</head>

<body>
<header>
  <div class="hTitle">ЭВАКУАЦИЯ — PRO</div>
  <div class="hSub">Оффлайн. Выбор признаков → приоритет эвакуации + рекомендации. Таймеры и журнал сохраняются.</div>
</header>

<div class="wrap">

  <div class="topRow">
    <div class="btnBackWrap">
      <button class="btn btnBack" id="btnBack">← К карте ранений</button>
      <span class="pill" id="pickedPill">Выбрано: 0</span>
    </div>
    <span class="pill" id="modePill">Режим: Оценка</span>
  </div>

  <div class="grid2">

    <!-- LEFT: признаки -->
    <div class="card">
      <div class="secTitle">
        <span>Признаки</span>
        <span class="pill" id="catPill">—</span>
      </div>

      <div class="secHint">
        Правило: если есть любой <b>критический</b> пункт → <b>ЭВАК СЕЙЧАС</b>.
        Иначе “срочно/планово/наблюдать” по смыслу выбранных факторов.
      </div>

      <div id="items"></div>

      <div class="split">
        <div class="secTitle" style="margin:0 0 6px 0;">
          <span>Сводка 1 строка</span>
          <span class="pill" id="oneLinePill">готово</span>
        </div>
        <div class="secHint" id="oneLineText">—</div>

        <div class="actionRow">
          <button class="btn btnWide btnBlue" id="btnCopy">КОПИРОВАТЬ</button>
          <button class="btn btnWide btnGreen" id="btnTg">В TELEGRAM</button>
          <button class="btn btnWide btnGray" id="btnReset">СБРОС</button>
        </div>
      </div>
    </div>

    <!-- RIGHT: результат + таймеры -->
    <div class="card">
      <div class="secTitle">
        <span>Результат</span>
        <span class="pill" id="timePill">время: —</span>
      </div>

      <div id="resultBox" class="resultBox green">
        <h3 class="rTitle" id="resTitle">Не оценено</h3>
        <div class="rSub" id="resSub">Отметь пункты слева.</div>

        <div class="split">
          <b>Причины</b>
          <ul id="whyList"><li>—</li></ul>
        </div>

        <div class="split">
          <b>Рекомендации на месте</b>
          <ul id="recList"><li>—</li></ul>
        </div>
      </div>

      <div class="split">
        <div class="secTitle" style="margin:0 0 6px 0;">
          <span>Таймеры</span>
          <span class="pill">офлайн</span>
        </div>

        <div class="timerBtns">
          <button class="btnTiny red" data-timer="tourniquet">ЖГУТ 60</button>
          <button class="btnTiny blue" data-timer="recheck15">ПЕРЕОЦЕНКА 15</button>
          <button class="btnTiny blue" data-timer="recheck30">ПЕРЕОЦЕНКА 30</button>
          <button class="btnTiny green" data-timer="pain30">ОБЕЗБОЛ 30</button>
        </div>

        <div class="secHint">
          Нажал — таймер стартовал и записался в журнал. По нулю: вибрация (если доступна) + пометка.
        </div>

        <div class="timerList" id="timerList"></div>
      </div>

      <div class="split">
        <div class="secTitle" style="margin:0 0 6px 0;">
          <span>Журнал</span>
          <button class="btnTiny" id="btnClearLog" type="button">Очистить</button>
        </div>
        <div class="log" id="logBox"></div>
      </div>

    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  // ---------- CONFIG ----------
  const STORAGE_KEY = "evak_pro_v1_state";

  // Back link: лучше так для GitHub Pages: /med-map/
  // Если когда-то поменяешь имя репо — измени только эту строку:
  const BACK_URL = "/med-map/"; // или "/med-map/index.html"

  const ITEM_DEFS = [
    // critical -> эвак сейчас
    {id:"crit_bleed_uncontrolled", level:"critical", title:"Кровотечение не контролируется / срыв контроля",
      desc:"жгут/тампонада не держит, быстрое промокание, повторное активное кровотечение",
      tags:["bleed"]},
    {id:"crit_airway", level:"critical", title:"Угроза дыхательным путям",
      desc:"обструкция/аспирация/не может говорить/нарастающее удушье",
      tags:["airway"]},
    {id:"crit_shock", level:"critical", title:"Признаки шока / резкое ухудшение",
      desc:"холодный пот, сильная слабость, спутанность, выраженная бледность, падение давления (если меряете)",
      tags:["shock"]},
    {id:"crit_neuro", level:"critical", title:"Неврологическое ухудшение",
      desc:"потеря сознания, судороги, прогресс симптомов",
      tags:["neuro"]},

    // urgent -> эвак срочно/приоритет
    {id:"urg_chest", level:"urgent", title:"Ранение груди / риск ухудшения",
      desc:"одышка/боль/подозрение, даже если “пока держится”",
      tags:["chest"]},
    {id:"urg_abd_pelvis", level:"urgent", title:"Подозрение на проникающее ранение живота/таза",
      desc:"боль/напряжение/ухудшение, риск скрытого повреждения",
      tags:["abd"]},
    {id:"urg_head_eye", level:"urgent", title:"Травма головы/глаза с риском ухудшения",
      desc:"проникающая травма глаза, нарастающие симптомы, выраженная головная боль/спутанность",
      tags:["head","eye"]},
    {id:"urg_major_burn", level:"urgent", title:"Ожоги значимой зоны",
      desc:"площадь/суставы/лицо/кисти/промежность или риск ухудшения",
      tags:["burn"]},

    // planned -> планово/по ресурсу
    {id:"plan_limb_serious", level:"planned", title:"Серьёзная травма конечности",
      desc:"перелом/деформация/не может опереться, нужна фиксация/хирургия",
      tags:["limb"]},
    {id:"plan_infection_flags", level:"planned", title:"Красные флаги инфекции/воспаления",
      desc:"температура + ухудшение, быстрый отёк/покраснение, гной + слабость",
      tags:["infection"]},
    {id:"plan_support_need", level:"planned", title:"Нуждается в постоянном наблюдении/поддержке",
      desc:"не может идти сам, выраженная слабость, нужен контроль",
      tags:["support"]},

    // observe -> наблюдать на месте
    {id:"obs_stable_minor", level:"observe", title:"Стабильно, поверхностно",
      desc:"контроль держится, нет прогрессии, состояние ровное",
      tags:["stable"]},
    {id:"obs_aftercare", level:"observe", title:"Нужна только перевязка/уход",
      desc:"без системных признаков ухудшения",
      tags:["aftercare"]}
  ];

  const TIMER_DEFS = {
    tourniquet: {label:"Жгут — контроль", minutes:60},
    recheck15:  {label:"Повторная оценка", minutes:15},
    recheck30:  {label:"Повторная оценка", minutes:30},
    pain30:     {label:"Обезбол — контроль", minutes:30}
  };

  // ---------- STATE ----------
  const defaultState = {
    checked: {},      // id -> true
    timers: [],       // {id, label, startMs, durationMs}
    log: []           // ["HH:MM событие", ...]
  };

  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(defaultState);
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== "object") return structuredClone(defaultState);
      obj.checked = obj.checked && typeof obj.checked==="object" ? obj.checked : {};
      obj.timers = Array.isArray(obj.timers) ? obj.timers : [];
      obj.log = Array.isArray(obj.log) ? obj.log : [];
      return obj;
    }catch(_){
      return structuredClone(defaultState);
    }
  }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // ---------- UI HELPERS ----------
  const $ = (id)=>document.getElementById(id);
  const toastEl = $("toast");

  function toast(msg, ms=2000){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.style.display="none", ms);
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function nowHHMM(){
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function fmtMMSS(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${pad2(m)}:${pad2(r)}`;
  }

  function addLog(line){
    const entry = `${nowHHMM()} ${line}`;
    state.log.push(entry);
    // ограничим размер журнала
    if(state.log.length > 200) state.log = state.log.slice(state.log.length - 200);
    saveState();
    renderLog();
  }

  // ---------- BUILD ITEMS ----------
  function chipFor(level){
    if(level==="critical") return `<span class="chip crit">КРИТИЧЕСКИ</span>`;
    if(level==="urgent") return `<span class="chip urg">СРОЧНО</span>`;
    if(level==="planned") return `<span class="chip plan">ПЛАНОВО</span>`;
    return `<span class="chip obs">НАБЛЮДАТЬ</span>`;
  }

  function renderItems(){
    const wrap = $("items");
    wrap.innerHTML = "";

    for(const it of ITEM_DEFS){
      const label = document.createElement("label");
      label.className = "item";
      label.htmlFor = `cb_${it.id}`;

      const row = document.createElement("div");
      row.className = "itemRow";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.id = `cb_${it.id}`;
      cb.checked = !!state.checked[it.id];
      cb.dataset.itemId = it.id;

      cb.addEventListener("change", ()=>{
        state.checked[it.id] = cb.checked;
        if(!cb.checked) delete state.checked[it.id];
        saveState();
        recalcAndRender();
      });

      const box = document.createElement("div");
      box.innerHTML = `
        <div class="itT">${it.title}</div>
        <div class="itD">${it.desc || ""}</div>
        <div class="chips">${chipFor(it.level)}<span class="chip">${(it.tags||[]).join(" · ")}</span></div>
      `;

      row.appendChild(cb);
      row.appendChild(box);
      label.appendChild(row);

      wrap.appendChild(label);
    }
  }

  // ---------- DECISION ENGINE ----------
  function selectedItems(){
    const ids = Object.keys(state.checked);
    const out = [];
    for(const id of ids){
      const def = ITEM_DEFS.find(x=>x.id===id);
      if(def) out.push(def);
    }
    return out;
  }

  function uniq(arr){
    const s = new Set();
    const out = [];
    for(const x of arr){ if(!s.has(x)){ s.add(x); out.push(x);} }
    return out;
  }

  function decideCategory(sel){
    if(sel.length===0) return {cat:"NONE"};

    const hasCritical = sel.some(x=>x.level==="critical");
    if(hasCritical) return {cat:"NOW"};

    // если только observe
    const onlyObserve = sel.every(x=>x.level==="observe");
    if(onlyObserve) return {cat:"OBSERVE"};

    // если есть urgent -> срочно
    const hasUrgent = sel.some(x=>x.level==="urgent");
    if(hasUrgent) return {cat:"URGENT"};

    // если есть planned (и нет urgent/critical) -> планово
    const hasPlanned = sel.some(x=>x.level==="planned");
    if(hasPlanned) return {cat:"PLANNED"};

    // fallback
    return {cat:"OBSERVE"};
  }

  function buildRecommendations(sel, cat){
    // базовые универсальные
    const rec = [];

    // всегда полезно
    if(cat!=="NONE"){
      rec.push("Тепло, покой, минимизация движений. Контроль динамики состояния.");
      rec.push("Повторная оценка: сознание/дыхание/кровотечение/боль/цвет конечности.");
    }

    const tags = uniq(sel.flatMap(x=>x.tags||[]));

    // Комбинационные подсказки (без назначения лекарств)
    if(tags.includes("bleed")){
      rec.push("Кровотечение: контроль повязок/жгута/тампонады, фиксация, готовность к повторному контролю.");
    }
    if(tags.includes("chest")){
      rec.push("Грудь: контроль дыхания, положение как переносит, отслеживать ухудшение/нарастание одышки.");
    }
    if(tags.includes("abd")){
      rec.push("Живот/таз: минимизировать нагрузку, контроль боли/ухудшения, готовность к эвакуации.");
    }
    if(tags.includes("neuro") || tags.includes("head")){
      rec.push("Голова/неврология: наблюдение сознания, защита головы, избегать нагрузки.");
    }
    if(tags.includes("eye")){
      rec.push("Глаз: защита/не давить на глаз, аккуратная фиксация повязкой, избегать трения.");
    }
    if(tags.includes("limb")){
      rec.push("Конечность: иммобилизация, контроль кровообращения/чувствительности дистально, тепло.");
    }
    if(tags.includes("burn")){
      rec.push("Ожоги: защита чистой повязкой, тепло, контроль боли/ухудшения.");
    }
    if(tags.includes("infection")){
      rec.push("Инфекция: контроль температуры/ухудшения, перевязка/гигиена, при прогрессии — повышать приоритет.");
    }

    // Категорийные
    if(cat==="NOW"){
      rec.unshift("ЭВАКУАЦИЯ: немедленно. Подготовить транспортировку и связь, держать готовность к ухудшению.");
    } else if(cat==="URGENT"){
      rec.unshift("ЭВАКУАЦИЯ: приоритетно (срочно). Подготовить эвак заранее, наблюдать до передачи.");
    } else if(cat==="PLANNED"){
      rec.unshift("ЭВАКУАЦИЯ: планово/по ресурсу. При ухудшении — повышать приоритет.");
    } else if(cat==="OBSERVE"){
      rec.unshift("НА МЕСТЕ: наблюдать и купировать. Эвакуация не обязательна при стабильности.");
    }

    // компактно
    return uniq(rec).slice(0, 10);
  }

  function buildOneLine(sel, cat){
    if(cat==="NONE") return "—";
    const map = {NOW:"ЭВАК СЕЙЧАС", URGENT:"ЭВАК СРОЧНО", PLANNED:"ЭВАК ПЛАНОВО", OBSERVE:"НАБЛЮДАТЬ"};
    const reasons = sel.slice(0,4).map(x=>x.title).join("; ");
    const more = sel.length>4 ? ` +${sel.length-4}` : "";
    return `${map[cat]}: ${reasons}${more}`;
  }

  function categoryUi(cat){
    if(cat==="NOW") return {pill:"СЕЙЧАС", cls:"red", title:"ЭВАКУАЦИЯ СЕЙЧАС", sub:"Есть критические признаки. Приоритет — немедленная эвакуация."};
    if(cat==="URGENT") return {pill:"СРОЧНО", cls:"orange", title:"ЭВАКУАЦИЯ СРОЧНО", sub:"Риск ухудшения. Эвакуация при первой возможности/приоритет."};
    if(cat==="PLANNED") return {pill:"ПЛАНОВО", cls:"yellow", title:"ЭВАКУАЦИЯ ПЛАНОВО", sub:"Стабильно, но требуется помощь/наблюдение/лечение. При ухудшении — повысить."};
    if(cat==="OBSERVE") return {pill:"НА МЕСТЕ", cls:"green", title:"НАБЛЮДАТЬ НА МЕСТЕ", sub:"Сейчас нет явных показаний к срочной эвакуации. Главное — динамика."};
    return {pill:"—", cls:"green", title:"Не оценено", sub:"Отметь пункты слева."};
  }

  // ---------- TIMERS ----------
  function startTimer(key){
    const def = TIMER_DEFS[key];
    if(!def) return;

    const t = {
      id: "t_" + Math.random().toString(36).slice(2) + "_" + Date.now(),
      label: def.label,
      startMs: Date.now(),
      durationMs: def.minutes * 60 * 1000
    };
    state.timers.push(t);
    saveState();
    renderTimers();
    addLog(`Таймер: старт — ${def.label} (${def.minutes} мин)`);
    toast(`Таймер: ${def.label}`);
  }

  function stopTimer(id){
    const idx = state.timers.findIndex(x=>x.id===id);
    if(idx<0) return;
    const label = state.timers[idx].label;
    state.timers.splice(idx,1);
    saveState();
    renderTimers();
    addLog(`Таймер: стоп — ${label}`);
    toast("Таймер остановлен");
  }

  function renderTimers(){
    const box = $("timerList");
    box.innerHTML = "";

    if(!state.timers.length){
      const empty = document.createElement("div");
      empty.className = "secHint";
      empty.textContent = "Таймеров нет.";
      box.appendChild(empty);
      return;
    }

    for(const t of state.timers){
      const end = t.startMs + t.durationMs;
      const left = end - Date.now();
      const done = left <= 0;

      const row = document.createElement("div");
      row.className = "tItem";

      const leftBox = document.createElement("div");
      leftBox.innerHTML = `
        <div class="tName">${t.label}</div>
        <div class="tMeta">Старт: ${new Date(t.startMs).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}</div>
      `;

      const right = document.createElement("div");
      right.className = "tRight";

      const time = document.createElement("div");
      time.className = "tTime";

      if(done){
        time.innerHTML = `<span class="tLeft warn">⏰ 00:00</span>`;
      }else{
        time.textContent = "Осталось " + fmtMMSS(left);
      }

      const btn = document.createElement("button");
      btn.className = "btnStop";
      btn.type = "button";
      btn.textContent = "Стоп";
      btn.addEventListener("pointerdown",(e)=>{ e.preventDefault(); stopTimer(t.id); });

      right.appendChild(time);
      right.appendChild(btn);

      row.appendChild(leftBox);
      row.appendChild(right);
      box.appendChild(row);
    }
  }

  function tickTimers(){
    if(!state.timers.length) return;

    // Проверим какие закончились впервые
    let anyFinished = false;
    for(const t of state.timers){
      const end = t.startMs + t.durationMs;
      const left = end - Date.now();
      if(left <= 0 && !t._notified){
        t._notified = true;
        anyFinished = true;
        addLog(`⏰ Таймер: ВРЕМЯ — ${t.label}`);
        try{ navigator.vibrate && navigator.vibrate([120,80,120]); }catch(_){}
        toast(`ВРЕМЯ: ${t.label}`, 2600);
      }
    }
    if(anyFinished) saveState();
    renderTimers();
  }

  // ---------- LOG ----------
  function renderLog(){
    const box = $("logBox");
    if(!state.log.length){
      box.textContent = "(пусто)";
      return;
    }
    box.textContent = state.log.slice(-80).join("\n");
  }

  // ---------- EXPORT ----------
  function buildFullText(sel, cat, recs){
    const ui = categoryUi(cat);
    const time = new Date().toLocaleString("ru-RU");
    const reasons = sel.length ? sel.map(x=>`- ${x.title}`).join("\n") : "- (нет)";

    // таймеры
    const timers = state.timers.length ? state.timers.map(t=>{
      const end = t.startMs + t.durationMs;
      const left = end - Date.now();
      const leftStr = left<=0 ? "00:00" : fmtMMSS(left);
      return `- ${t.label}: осталось ${leftStr}`;
    }).join("\n") : "- (нет)";

    const log = state.log.length ? state.log.slice(-30).join("\n") : "(пусто)";

    return (
`ЭВАКУАЦИЯ — ОТЧЁТ (офлайн)
Время: ${time}

Категория: ${ui.title}

Причины:
${reasons}

Рекомендации:
${recs.map(x=>`- ${x}`).join("\n")}

Таймеры:
${timers}

Журнал (последние):
${log}`
    );
  }

  // ---------- MAIN RENDER ----------
  function recalcAndRender(){
    const sel = selectedItems();
    const picked = sel.length;
    $("pickedPill").textContent = `Выбрано: ${picked}`;

    const time = nowHHMM();
    $("timePill").textContent = `время: ${time}`;

    const {cat} = decideCategory(sel);
    const ui = categoryUi(cat);
    $("catPill").textContent = ui.pill;

    const resBox = $("resultBox");
    resBox.className = "resultBox " + ui.cls;
    $("resTitle").textContent = ui.title;
    $("resSub").textContent = ui.sub;

    // why
    const why = $("whyList");
    why.innerHTML = "";
    if(!sel.length){
      const li = document.createElement("li");
      li.textContent = "—";
      why.appendChild(li);
    }else{
      for(const it of sel){
        const li = document.createElement("li");
        li.textContent = it.title;
        why.appendChild(li);
      }
    }

    // rec
    const recs = buildRecommendations(sel, cat);
    const rlist = $("recList");
    rlist.innerHTML = "";
    if(!recs.length){
      const li = document.createElement("li");
      li.textContent = "—";
      rlist.appendChild(li);
    }else{
      for(const r of recs){
        const li = document.createElement("li");
        li.textContent = r;
        rlist.appendChild(li);
      }
    }

    // one-line
    const one = buildOneLine(sel, cat);
    $("oneLineText").textContent = one;

    // save last computed export
    window.__EVAK_ONE__ = one;
    window.__EVAK_FULL__ = buildFullText(sel, cat, recs);

    // если категория сменилась — логируем (только при реальном изменении)
    if(state._lastCat !== cat){
      if(state._lastCat !== undefined) addLog(`Категория: ${categoryUi(state._lastCat).pill} → ${ui.pill}`);
      state._lastCat = cat;
      saveState();
    }
  }

  // ---------- BUTTONS ----------
  $("btnBack").addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    window.location.href = BACK_URL;
  });

  $("btnCopy").addEventListener("pointerdown", async (e)=>{
    e.preventDefault();
    const text = window.__EVAK_FULL__ || "";
    if(!text){ toast("Нечего копировать"); return; }
    try{
      await navigator.clipboard.writeText(text);
      toast("✅ Скопировано");
    }catch(_){
      toast("Не удалось скопировать (браузер). Попробуй выделить вручную.", 2600);
    }
  });

  $("btnTg").addEventListener("pointerdown", async (e)=>{
    e.preventDefault();
    const text = window.__EVAK_FULL__ || "";
    if(!text){ toast("Нечего отправлять"); return; }

    // Надёжно: сначала в буфер, потом открыть Telegram share
    try{ await navigator.clipboard.writeText(text); }catch(_){}

    // t.me/share/url: можно без url, только text
    const shareUrl = "https://t.me/share/url?url=&text=" + encodeURIComponent(text);
    window.open(shareUrl, "_blank");
    toast("Открыл Telegram share (текст в буфере тоже есть)", 2600);
  });

  $("btnReset").addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    state.checked = {};
    state.timers = [];
    state._lastCat = undefined;
    saveState();
    renderItems();      // пересоздать чекбоксы
    renderTimers();
    addLog("Сброс: признаки и таймеры очищены");
    recalcAndRender();
    toast("Сброшено");
  });

  $("btnClearLog").addEventListener("pointerdown",(e)=>{
    e.preventDefault();
    state.log = [];
    saveState();
    renderLog();
    toast("Журнал очищен");
  });

  document.querySelectorAll("[data-timer]").forEach(btn=>{
    btn.addEventListener("pointerdown",(e)=>{
      e.preventDefault();
      const key = btn.getAttribute("data-timer");
      startTimer(key);
    });
  });

  // ---------- INIT ----------
  renderItems();
  renderTimers();
  renderLog();
  recalcAndRender();

  // обновление времени/таймеров
  setInterval(()=>{
    $("timePill").textContent = `время: ${nowHHMM()}`;
    tickTimers();
  }, 1000);

})();
</script>

</body>
</html>
